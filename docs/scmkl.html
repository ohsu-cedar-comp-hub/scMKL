<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.0"/>
    <title>scmkl API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>
            <img src="https://github.com/ohsu-cedar-comp-hub/scMKL/blob/main/scMKL_logo.png?raw=true" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#requirements">Requirements</a></li>
  <li><a href="#links">Links</a></li>
  <li><a href="#citation">Citation</a></li>
  <li><a href="#scmkl-documentation"><strong>scMKL Documentation</strong></a></li>
</ul>


            <h2>Submodules</h2>
            <ul>
                    <li><a href="scmkl/calculate_z.html">calculate_z</a></li>
                    <li><a href="scmkl/create_adata.html">create_adata</a></li>
                    <li><a href="scmkl/dataframes.html">dataframes</a></li>
                    <li><a href="scmkl/estimate_sigma.html">estimate_sigma</a></li>
                    <li><a href="scmkl/get_atac_groupings.html">get_atac_groupings</a></li>
                    <li><a href="scmkl/multimodal_processing.html">multimodal_processing</a></li>
                    <li><a href="scmkl/one_v_rest.html">one_v_rest</a></li>
                    <li><a href="scmkl/optimize_alpha.html">optimize_alpha</a></li>
                    <li><a href="scmkl/optimize_sparsity.html">optimize_sparsity</a></li>
                    <li><a href="scmkl/plotting.html">plotting</a></li>
                    <li><a href="scmkl/run.html">run</a></li>
                    <li><a href="scmkl/test.html">test</a></li>
                    <li><a href="scmkl/tfidf_normalize.html">tfidf_normalize</a></li>
                    <li><a href="scmkl/train_model.html">train_model</a></li>
            </ul>

            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#calculate_z">calculate_z</a>
            </li>
            <li>
                    <a class="function" href="#create_adata">create_adata</a>
            </li>
            <li>
                    <a class="function" href="#estimate_sigma">estimate_sigma</a>
            </li>
            <li>
                    <a class="function" href="#get_atac_groupings">get_atac_groupings</a>
            </li>
            <li>
                    <a class="function" href="#multimodal_processing">multimodal_processing</a>
            </li>
            <li>
                    <a class="function" href="#one_v_rest">one_v_rest</a>
            </li>
            <li>
                    <a class="function" href="#optimize_alpha">optimize_alpha</a>
            </li>
            <li>
                    <a class="function" href="#optimize_sparsity">optimize_sparsity</a>
            </li>
            <li>
                    <a class="function" href="#run">run</a>
            </li>
            <li>
                    <a class="function" href="#tfidf_normalize">tfidf_normalize</a>
            </li>
            <li>
                    <a class="function" href="#train_model">train_model</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
scmkl    </h1>

                        <div class="docstring"><h1 align="center">
<img src="https://github.com/ohsu-cedar-comp-hub/scMKL/blob/main/scMKL_logo.png?raw=true" width="500"/>
</h1><br>

<p><img src="https://img.shields.io/pypi/v/scmkl?label=pypi%20package" alt="PyPI" />
<img src="https://img.shields.io/pypi/dm/scmkl" alt="PyPI - Downloads" />
<a href="https://anaconda.org/ivango17/scmkl"><img src="https://anaconda.org/ivango17/scmkl/badges/version.svg" alt="Anaconda-Server Badge" /></a>
<a href="https://anaconda.org/ivango17/scmkl"><img src="https://anaconda.org/ivango17/scmkl/badges/downloads.svg" alt="Anaconda-Server Badge" /></a>
<a href="https://anaconda.org/ivango17/scmkl"><img src="https://anaconda.org/ivango17/scmkl/badges/latest_release_date.svg" alt="Anaconda-Server Badge" /></a></p>

<p>Single-cell analysis using Multiple Kernel Learning, scMKL, is a binary classification algorithm utilizing prior information to group features to enhance classification and aid understanding of distinguishing features in multi-omic data sets.</p>

<h2 id="installation">Installation</h2>

<h3 id="conda-install">Conda install</h3>

<p>Conda is the recommended method to install scMKL:</p>

<pre><code>conda create -n scMKL python=3.12 -c conda-forge ivango17::scmkl
</code></pre>

<h3 id="pip-install">Pip install</h3>

<p>First, create a virtual environment with <code>python&gt;=3.11.1,&lt;3.13</code>.</p>

<p>Then, install scMKL with:</p>

<pre><code># activate your new env with python&gt;=3.11.1 and &lt;3.13
pip install scmkl
</code></pre>

<p>If wheels do not build correctly, ensure <code>gcc</code> and <code>g++</code> are installed and up to date. They can be installed with <code>sudo apt install gcc</code> and <code>sudo apt install g++</code>.</p>

<h2 id="requirements">Requirements</h2>

<p>scMKL takes advantage of AnnData objects and can be implemented with just four pieces of data:</p>

<p>1) scRNA and/or scATAC matrices (can be <code>scipy.sparse</code> matrix)</p>

<p>2) An array of cell labels</p>

<p>3) An array of feature names (eg. gene symbols for RNA or peaks for ATAC)</p>

<p>4) A grouping dictionary where {'group_1' : [feature_5, feature_16], 'group_2' : [feature_1, feature_4, feature_9]}</p>

<p>For more information on formatting/creating the grouping dictionaries, see our example for creating an <a href="https://github.com/ohsu-cedar-comp-hub/scMKL/blob/main/example/getting_RNA_groupings.ipynb">RNA grouping</a> or <a href="https://github.com/ohsu-cedar-comp-hub/scMKL/blob/main/example/getting_ATAC_groupings.ipynb">ATAC grouping</a>.</p>

<p>For implementing scMKL, see our examples for your use case in <a href="https://github.com/ohsu-cedar-comp-hub/scMKL/tree/main/example">examples</a>.</p>

<h2 id="links">Links</h2>

<p>Repo: <a href="https://github.com/ohsu-cedar-comp-hub/scMKL">https://github.com/ohsu-cedar-comp-hub/scMKL</a></p>

<p>PyPI: <a href="https://pypi.org/project/scmkl/">https://pypi.org/project/scmkl/</a></p>

<p>Anaconda: <a href="https://anaconda.org/ivango17/scmkl">https://anaconda.org/ivango17/scmkl</a></p>

<p>API: <a href="https://ohsu-cedar-comp-hub.github.io/scMKL/">https://ohsu-cedar-comp-hub.github.io/scMKL/</a></p>

<h2 id="citation">Citation</h2>

<p>If you use scMKL in your research, please cite using:</p>

<pre><code>To be determined
</code></pre>

<p>Our Shiny for Python application for viewing data produced from this work can be found here: <a href="https://huggingface.co/spaces/scMKL-team/scMKL_analysis">scMKL_analysis</a></p>

<hr />

<h2 id="scmkl-documentation"><strong>scMKL Documentation</strong></h2>
</div>

                        <input id="mod-scmkl-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-scmkl-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos"> 1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos"> 2</span></a><span class="sd">.. include:: ../README.md</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos"> 3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos"> 4</span></a><span class="sd">----------------------------</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos"> 5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos"> 6</span></a><span class="sd">## **scMKL Documentation**</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos"> 7</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos"> 8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos"> 9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos">10</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;calculate_z&#39;</span><span class="p">,</span> 
</span><span id="L-11"><a href="#L-11"><span class="linenos">11</span></a>           <span class="s1">&#39;create_adata&#39;</span><span class="p">,</span> 
</span><span id="L-12"><a href="#L-12"><span class="linenos">12</span></a>           <span class="s1">&#39;dataframes&#39;</span><span class="p">,</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">13</span></a>           <span class="s1">&#39;estimate_sigma&#39;</span><span class="p">,</span> 
</span><span id="L-14"><a href="#L-14"><span class="linenos">14</span></a>           <span class="s1">&#39;get_atac_groupings&#39;</span><span class="p">,</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">15</span></a>           <span class="s1">&#39;multimodal_processing&#39;</span><span class="p">,</span> 
</span><span id="L-16"><a href="#L-16"><span class="linenos">16</span></a>           <span class="s1">&#39;one_v_rest&#39;</span><span class="p">,</span> 
</span><span id="L-17"><a href="#L-17"><span class="linenos">17</span></a>           <span class="s1">&#39;optimize_alpha&#39;</span><span class="p">,</span> 
</span><span id="L-18"><a href="#L-18"><span class="linenos">18</span></a>           <span class="s1">&#39;optimize_sparsity&#39;</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">19</span></a>           <span class="s1">&#39;plotting&#39;</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">20</span></a>           <span class="s1">&#39;run&#39;</span><span class="p">,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">21</span></a>           <span class="s1">&#39;test&#39;</span><span class="p">,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">22</span></a>           <span class="s1">&#39;tfidf_normalize&#39;</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">23</span></a>           <span class="s1">&#39;train_model&#39;</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">24</span></a>           <span class="p">]</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos">26</span></a><span class="kn">from</span> <span class="nn">scmkl._checks</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">27</span></a><span class="kn">from</span> <span class="nn">scmkl.calculate_z</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">28</span></a><span class="kn">from</span> <span class="nn">scmkl.create_adata</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">29</span></a><span class="kn">from</span> <span class="nn">scmkl.dataframes</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">30</span></a><span class="kn">from</span> <span class="nn">scmkl.estimate_sigma</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">31</span></a><span class="kn">from</span> <span class="nn">scmkl.get_atac_groupings</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">32</span></a><span class="kn">from</span> <span class="nn">scmkl.multimodal_processing</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">33</span></a><span class="kn">from</span> <span class="nn">scmkl.one_v_rest</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">34</span></a><span class="kn">from</span> <span class="nn">scmkl.optimize_alpha</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">35</span></a><span class="kn">from</span> <span class="nn">scmkl.optimize_sparsity</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">36</span></a><span class="kn">from</span> <span class="nn">scmkl.plotting</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">37</span></a><span class="kn">from</span> <span class="nn">scmkl.run</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">38</span></a><span class="kn">from</span> <span class="nn">scmkl.test</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">39</span></a><span class="kn">from</span> <span class="nn">scmkl.tfidf_normalize</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">40</span></a><span class="kn">from</span> <span class="nn">scmkl.train_model</span> <span class="kn">import</span> <span class="o">*</span>
</span></pre></div>


            </section>
                <section id="calculate_z">
                            <input id="calculate_z-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_z</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">adata</span>, </span><span class="param"><span class="n">n_features</span><span class="o">=</span><span class="mi">5000</span></span><span class="return-annotation">) -> <span class="n">anndata</span><span class="o">.</span><span class="n">_core</span><span class="o">.</span><span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span>:</span></span>

                <label class="view-source-button" for="calculate_z-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#calculate_z"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="calculate_z-105"><a href="#calculate_z-105"><span class="linenos">105</span></a><span class="k">def</span> <span class="nf">calculate_z</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">:</span>
</span><span id="calculate_z-106"><a href="#calculate_z-106"><span class="linenos">106</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="calculate_z-107"><a href="#calculate_z-107"><span class="linenos">107</span></a><span class="sd">    Function to calculate Z matrix.</span>
</span><span id="calculate_z-108"><a href="#calculate_z-108"><span class="linenos">108</span></a>
</span><span id="calculate_z-109"><a href="#calculate_z-109"><span class="linenos">109</span></a><span class="sd">    Parameters</span>
</span><span id="calculate_z-110"><a href="#calculate_z-110"><span class="linenos">110</span></a><span class="sd">    ----------</span>
</span><span id="calculate_z-111"><a href="#calculate_z-111"><span class="linenos">111</span></a><span class="sd">    **adata** : *AnnData*</span>
</span><span id="calculate_z-112"><a href="#calculate_z-112"><span class="linenos">112</span></a><span class="sd">        &gt; created by `create_adata()` with `adata.uns.keys()` </span>
</span><span id="calculate_z-113"><a href="#calculate_z-113"><span class="linenos">113</span></a><span class="sd">        `&#39;sigma&#39;`, `&#39;train_indices&#39;`, and `&#39;test_indices&#39;`. </span>
</span><span id="calculate_z-114"><a href="#calculate_z-114"><span class="linenos">114</span></a><span class="sd">        `&#39;sigma&#39;` key can be added by running `estimate_sigma()` on </span>
</span><span id="calculate_z-115"><a href="#calculate_z-115"><span class="linenos">115</span></a><span class="sd">        adata. </span>
</span><span id="calculate_z-116"><a href="#calculate_z-116"><span class="linenos">116</span></a>
</span><span id="calculate_z-117"><a href="#calculate_z-117"><span class="linenos">117</span></a><span class="sd">    **n_features** : *int* </span>
</span><span id="calculate_z-118"><a href="#calculate_z-118"><span class="linenos">118</span></a><span class="sd">        &gt; Number of random feature to use when calculating Z- used for </span>
</span><span id="calculate_z-119"><a href="#calculate_z-119"><span class="linenos">119</span></a><span class="sd">        scalability.</span>
</span><span id="calculate_z-120"><a href="#calculate_z-120"><span class="linenos">120</span></a>
</span><span id="calculate_z-121"><a href="#calculate_z-121"><span class="linenos">121</span></a><span class="sd">    Returns</span>
</span><span id="calculate_z-122"><a href="#calculate_z-122"><span class="linenos">122</span></a><span class="sd">    -------</span>
</span><span id="calculate_z-123"><a href="#calculate_z-123"><span class="linenos">123</span></a><span class="sd">    **adata** : *AnnData*</span>
</span><span id="calculate_z-124"><a href="#calculate_z-124"><span class="linenos">124</span></a><span class="sd">        &gt; adata with Z matrices accessible with `adata.uns[&#39;Z_train&#39;]` </span>
</span><span id="calculate_z-125"><a href="#calculate_z-125"><span class="linenos">125</span></a><span class="sd">        and `adata.uns[&#39;Z_test&#39;]`.</span>
</span><span id="calculate_z-126"><a href="#calculate_z-126"><span class="linenos">126</span></a>
</span><span id="calculate_z-127"><a href="#calculate_z-127"><span class="linenos">127</span></a><span class="sd">    Examples</span>
</span><span id="calculate_z-128"><a href="#calculate_z-128"><span class="linenos">128</span></a><span class="sd">    --------</span>
</span><span id="calculate_z-129"><a href="#calculate_z-129"><span class="linenos">129</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.estimate_sigma(adata)</span>
</span><span id="calculate_z-130"><a href="#calculate_z-130"><span class="linenos">130</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.calculate_z(adata)</span>
</span><span id="calculate_z-131"><a href="#calculate_z-131"><span class="linenos">131</span></a><span class="sd">    &gt;&gt;&gt; adata.uns.keys()</span>
</span><span id="calculate_z-132"><a href="#calculate_z-132"><span class="linenos">132</span></a><span class="sd">    dict_keys([&#39;Z_train&#39;, &#39;Z_test&#39;, &#39;sigmas&#39;, &#39;train_indices&#39;, </span>
</span><span id="calculate_z-133"><a href="#calculate_z-133"><span class="linenos">133</span></a><span class="sd">    &#39;test_indices&#39;])</span>
</span><span id="calculate_z-134"><a href="#calculate_z-134"><span class="linenos">134</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="calculate_z-135"><a href="#calculate_z-135"><span class="linenos">135</span></a>    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Sigma must be positive&#39;</span>
</span><span id="calculate_z-136"><a href="#calculate_z-136"><span class="linenos">136</span></a>
</span><span id="calculate_z-137"><a href="#calculate_z-137"><span class="linenos">137</span></a>    <span class="c1"># Number of groupings taking from group_dict</span>
</span><span id="calculate_z-138"><a href="#calculate_z-138"><span class="linenos">138</span></a>    <span class="n">n_pathway</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;group_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="calculate_z-139"><a href="#calculate_z-139"><span class="linenos">139</span></a>    <span class="n">D</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
</span><span id="calculate_z-140"><a href="#calculate_z-140"><span class="linenos">140</span></a>
</span><span id="calculate_z-141"><a href="#calculate_z-141"><span class="linenos">141</span></a>    <span class="c1"># Capturing training and testing indices</span>
</span><span id="calculate_z-142"><a href="#calculate_z-142"><span class="linenos">142</span></a>    <span class="n">train_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
</span><span id="calculate_z-143"><a href="#calculate_z-143"><span class="linenos">143</span></a>    <span class="n">test_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
</span><span id="calculate_z-144"><a href="#calculate_z-144"><span class="linenos">144</span></a>
</span><span id="calculate_z-145"><a href="#calculate_z-145"><span class="linenos">145</span></a>    <span class="c1"># Create Arrays to store concatenated group Z</span>
</span><span id="calculate_z-146"><a href="#calculate_z-146"><span class="linenos">146</span></a>    <span class="c1"># Each group of features will have a corresponding entry in each array</span>
</span><span id="calculate_z-147"><a href="#calculate_z-147"><span class="linenos">147</span></a>    <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_pathway</span>
</span><span id="calculate_z-148"><a href="#calculate_z-148"><span class="linenos">148</span></a>
</span><span id="calculate_z-149"><a href="#calculate_z-149"><span class="linenos">149</span></a>    <span class="n">Z_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">train_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_cols</span><span class="p">))</span>
</span><span id="calculate_z-150"><a href="#calculate_z-150"><span class="linenos">150</span></a>    <span class="n">Z_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">test_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_cols</span><span class="p">))</span>
</span><span id="calculate_z-151"><a href="#calculate_z-151"><span class="linenos">151</span></a>
</span><span id="calculate_z-152"><a href="#calculate_z-152"><span class="linenos">152</span></a>
</span><span id="calculate_z-153"><a href="#calculate_z-153"><span class="linenos">153</span></a>    <span class="c1"># Loop over each of the groups and creating Z for each</span>
</span><span id="calculate_z-154"><a href="#calculate_z-154"><span class="linenos">154</span></a>    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">group_features</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;group_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="calculate_z-155"><a href="#calculate_z-155"><span class="linenos">155</span></a>        
</span><span id="calculate_z-156"><a href="#calculate_z-156"><span class="linenos">156</span></a>        <span class="c1">#Extract features from mth group</span>
</span><span id="calculate_z-157"><a href="#calculate_z-157"><span class="linenos">157</span></a>        <span class="n">num_group_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_features</span><span class="p">)</span>
</span><span id="calculate_z-158"><a href="#calculate_z-158"><span class="linenos">158</span></a>
</span><span id="calculate_z-159"><a href="#calculate_z-159"><span class="linenos">159</span></a>        <span class="c1"># Sample up to n_features features- important for scalability if </span>
</span><span id="calculate_z-160"><a href="#calculate_z-160"><span class="linenos">160</span></a>        <span class="c1"># using large groupings</span>
</span><span id="calculate_z-161"><a href="#calculate_z-161"><span class="linenos">161</span></a>        <span class="c1"># Will use all features if the grouping contains fewer than n_features</span>
</span><span id="calculate_z-162"><a href="#calculate_z-162"><span class="linenos">162</span></a>        <span class="n">number_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">n_features</span><span class="p">,</span> <span class="n">num_group_features</span><span class="p">])</span>
</span><span id="calculate_z-163"><a href="#calculate_z-163"><span class="linenos">163</span></a>        <span class="n">group_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group_features</span><span class="p">))</span>
</span><span id="calculate_z-164"><a href="#calculate_z-164"><span class="linenos">164</span></a>        <span class="n">group_features</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">group_array</span><span class="p">,</span> 
</span><span id="calculate_z-165"><a href="#calculate_z-165"><span class="linenos">165</span></a>                                                      <span class="n">number_features</span><span class="p">,</span> 
</span><span id="calculate_z-166"><a href="#calculate_z-166"><span class="linenos">166</span></a>                                                      <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> 
</span><span id="calculate_z-167"><a href="#calculate_z-167"><span class="linenos">167</span></a>
</span><span id="calculate_z-168"><a href="#calculate_z-168"><span class="linenos">168</span></a>        <span class="c1"># Create data arrays containing only features within this group</span>
</span><span id="calculate_z-169"><a href="#calculate_z-169"><span class="linenos">169</span></a>        <span class="n">X_train</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">],:][:,</span> <span class="n">group_features</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
</span><span id="calculate_z-170"><a href="#calculate_z-170"><span class="linenos">170</span></a>        <span class="n">X_test</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">],:][:,</span> <span class="n">group_features</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
</span><span id="calculate_z-171"><a href="#calculate_z-171"><span class="linenos">171</span></a>
</span><span id="calculate_z-172"><a href="#calculate_z-172"><span class="linenos">172</span></a>        <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;tfidf&#39;</span><span class="p">]:</span>
</span><span id="calculate_z-173"><a href="#calculate_z-173"><span class="linenos">173</span></a>            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">_tfidf_train_test</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
</span><span id="calculate_z-174"><a href="#calculate_z-174"><span class="linenos">174</span></a>
</span><span id="calculate_z-175"><a href="#calculate_z-175"><span class="linenos">175</span></a>        <span class="c1"># Data filtering, and transformation according to given data_type</span>
</span><span id="calculate_z-176"><a href="#calculate_z-176"><span class="linenos">176</span></a>        <span class="c1"># Will remove low variance (&lt; 1e5) features regardless of data_type</span>
</span><span id="calculate_z-177"><a href="#calculate_z-177"><span class="linenos">177</span></a>        <span class="c1"># If given data_type is &#39;counts&#39; will log scale and z-score the data</span>
</span><span id="calculate_z-178"><a href="#calculate_z-178"><span class="linenos">178</span></a>        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">_process_data</span><span class="p">(</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">,</span> 
</span><span id="calculate_z-179"><a href="#calculate_z-179"><span class="linenos">179</span></a>                                        <span class="n">scale_data</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;scale_data&#39;</span><span class="p">],</span> 
</span><span id="calculate_z-180"><a href="#calculate_z-180"><span class="linenos">180</span></a>                                        <span class="n">return_dense</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>          
</span><span id="calculate_z-181"><a href="#calculate_z-181"><span class="linenos">181</span></a>
</span><span id="calculate_z-182"><a href="#calculate_z-182"><span class="linenos">182</span></a>        <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;reduction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
</span><span id="calculate_z-183"><a href="#calculate_z-183"><span class="linenos">183</span></a>
</span><span id="calculate_z-184"><a href="#calculate_z-184"><span class="linenos">184</span></a>            <span class="n">SVD_func</span> <span class="o">=</span> <span class="n">TruncatedSVD</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="calculate_z-185"><a href="#calculate_z-185"><span class="linenos">185</span></a>            
</span><span id="calculate_z-186"><a href="#calculate_z-186"><span class="linenos">186</span></a>            <span class="c1"># Remove first component as it corresponds with sequencing depth</span>
</span><span id="calculate_z-187"><a href="#calculate_z-187"><span class="linenos">187</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">SVD_func</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_array</span><span class="p">(</span><span class="n">X_train</span><span class="p">))[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="calculate_z-188"><a href="#calculate_z-188"><span class="linenos">188</span></a>            <span class="n">X_test</span> <span class="o">=</span> <span class="n">SVD_func</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_array</span><span class="p">(</span><span class="n">X_test</span><span class="p">))[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="calculate_z-189"><a href="#calculate_z-189"><span class="linenos">189</span></a>
</span><span id="calculate_z-190"><a href="#calculate_z-190"><span class="linenos">190</span></a>        <span class="k">elif</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;reduction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pca&#39;</span><span class="p">:</span>
</span><span id="calculate_z-191"><a href="#calculate_z-191"><span class="linenos">191</span></a>            <span class="n">PCA_func</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="calculate_z-192"><a href="#calculate_z-192"><span class="linenos">192</span></a>
</span><span id="calculate_z-193"><a href="#calculate_z-193"><span class="linenos">193</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">PCA_func</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
</span><span id="calculate_z-194"><a href="#calculate_z-194"><span class="linenos">194</span></a>            <span class="n">X_test</span> <span class="o">=</span> <span class="n">PCA_func</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
</span><span id="calculate_z-195"><a href="#calculate_z-195"><span class="linenos">195</span></a>
</span><span id="calculate_z-196"><a href="#calculate_z-196"><span class="linenos">196</span></a>        <span class="k">elif</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;reduction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
</span><span id="calculate_z-197"><a href="#calculate_z-197"><span class="linenos">197</span></a>
</span><span id="calculate_z-198"><a href="#calculate_z-198"><span class="linenos">198</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span> <span class="o">@</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">))</span>
</span><span id="calculate_z-199"><a href="#calculate_z-199"><span class="linenos">199</span></a>            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span> <span class="o">@</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">))</span>
</span><span id="calculate_z-200"><a href="#calculate_z-200"><span class="linenos">200</span></a>
</span><span id="calculate_z-201"><a href="#calculate_z-201"><span class="linenos">201</span></a>        <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">X_train</span><span class="p">):</span>
</span><span id="calculate_z-202"><a href="#calculate_z-202"><span class="linenos">202</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
</span><span id="calculate_z-203"><a href="#calculate_z-203"><span class="linenos">203</span></a>            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
</span><span id="calculate_z-204"><a href="#calculate_z-204"><span class="linenos">204</span></a>
</span><span id="calculate_z-205"><a href="#calculate_z-205"><span class="linenos">205</span></a>        <span class="c1"># Extract pre-calculated sigma used for approximating kernel</span>
</span><span id="calculate_z-206"><a href="#calculate_z-206"><span class="linenos">206</span></a>        <span class="n">adjusted_sigma</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>
</span><span id="calculate_z-207"><a href="#calculate_z-207"><span class="linenos">207</span></a>
</span><span id="calculate_z-208"><a href="#calculate_z-208"><span class="linenos">208</span></a>        <span class="c1"># Calculates approximate kernel according to chosen kernel function</span>
</span><span id="calculate_z-209"><a href="#calculate_z-209"><span class="linenos">209</span></a>        <span class="c1"># Distribution data comes from Fourier Transform of kernel function</span>
</span><span id="calculate_z-210"><a href="#calculate_z-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;kernel_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
</span><span id="calculate_z-211"><a href="#calculate_z-211"><span class="linenos">211</span></a>
</span><span id="calculate_z-212"><a href="#calculate_z-212"><span class="linenos">212</span></a>            <span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">adjusted_sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="calculate_z-213"><a href="#calculate_z-213"><span class="linenos">213</span></a>            <span class="n">sigma_p</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">gamma</span><span class="p">)</span>
</span><span id="calculate_z-214"><a href="#calculate_z-214"><span class="linenos">214</span></a>
</span><span id="calculate_z-215"><a href="#calculate_z-215"><span class="linenos">215</span></a>            <span class="n">W</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma_p</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
</span><span id="calculate_z-216"><a href="#calculate_z-216"><span class="linenos">216</span></a>            <span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">D</span><span class="p">)</span>
</span><span id="calculate_z-217"><a href="#calculate_z-217"><span class="linenos">217</span></a>
</span><span id="calculate_z-218"><a href="#calculate_z-218"><span class="linenos">218</span></a>        <span class="k">elif</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;kernel_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;laplacian&#39;</span><span class="p">:</span>
</span><span id="calculate_z-219"><a href="#calculate_z-219"><span class="linenos">219</span></a>
</span><span id="calculate_z-220"><a href="#calculate_z-220"><span class="linenos">220</span></a>            <span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">adjusted_sigma</span><span class="p">)</span>
</span><span id="calculate_z-221"><a href="#calculate_z-221"><span class="linenos">221</span></a>
</span><span id="calculate_z-222"><a href="#calculate_z-222"><span class="linenos">222</span></a>            <span class="n">W</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">standard_cauchy</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
</span><span id="calculate_z-223"><a href="#calculate_z-223"><span class="linenos">223</span></a>            <span class="n">W</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">W</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">))</span>
</span><span id="calculate_z-224"><a href="#calculate_z-224"><span class="linenos">224</span></a>
</span><span id="calculate_z-225"><a href="#calculate_z-225"><span class="linenos">225</span></a>        <span class="k">elif</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;kernel_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cauchy&#39;</span><span class="p">:</span>
</span><span id="calculate_z-226"><a href="#calculate_z-226"><span class="linenos">226</span></a>
</span><span id="calculate_z-227"><a href="#calculate_z-227"><span class="linenos">227</span></a>            <span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">adjusted_sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="calculate_z-228"><a href="#calculate_z-228"><span class="linenos">228</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
</span><span id="calculate_z-229"><a href="#calculate_z-229"><span class="linenos">229</span></a>
</span><span id="calculate_z-230"><a href="#calculate_z-230"><span class="linenos">230</span></a>            <span class="n">W</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">laplace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
</span><span id="calculate_z-231"><a href="#calculate_z-231"><span class="linenos">231</span></a>            <span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">))</span>
</span><span id="calculate_z-232"><a href="#calculate_z-232"><span class="linenos">232</span></a>
</span><span id="calculate_z-233"><a href="#calculate_z-233"><span class="linenos">233</span></a>
</span><span id="calculate_z-234"><a href="#calculate_z-234"><span class="linenos">234</span></a>        <span class="n">train_projection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
</span><span id="calculate_z-235"><a href="#calculate_z-235"><span class="linenos">235</span></a>        <span class="n">test_projection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
</span><span id="calculate_z-236"><a href="#calculate_z-236"><span class="linenos">236</span></a>        
</span><span id="calculate_z-237"><a href="#calculate_z-237"><span class="linenos">237</span></a>        <span class="c1"># Store group Z in whole-Z object. </span>
</span><span id="calculate_z-238"><a href="#calculate_z-238"><span class="linenos">238</span></a>        <span class="c1"># Preserves order to be able to extract meaningful groups</span>
</span><span id="calculate_z-239"><a href="#calculate_z-239"><span class="linenos">239</span></a>        <span class="n">x_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">D</span> <span class="p">,</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">D</span><span class="p">)</span>
</span><span id="calculate_z-240"><a href="#calculate_z-240"><span class="linenos">240</span></a>        <span class="n">sq_i_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">D</span><span class="p">)</span>
</span><span id="calculate_z-241"><a href="#calculate_z-241"><span class="linenos">241</span></a>
</span><span id="calculate_z-242"><a href="#calculate_z-242"><span class="linenos">242</span></a>        <span class="n">Z_train</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="n">x_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sq_i_d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">train_projection</span><span class="p">),</span> 
</span><span id="calculate_z-243"><a href="#calculate_z-243"><span class="linenos">243</span></a>                                                 <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">train_projection</span><span class="p">)))</span>
</span><span id="calculate_z-244"><a href="#calculate_z-244"><span class="linenos">244</span></a>        <span class="n">Z_test</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="n">x_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sq_i_d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">test_projection</span><span class="p">),</span> 
</span><span id="calculate_z-245"><a href="#calculate_z-245"><span class="linenos">245</span></a>                                                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">test_projection</span><span class="p">)))</span>
</span><span id="calculate_z-246"><a href="#calculate_z-246"><span class="linenos">246</span></a>
</span><span id="calculate_z-247"><a href="#calculate_z-247"><span class="linenos">247</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;Z_train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_train</span>
</span><span id="calculate_z-248"><a href="#calculate_z-248"><span class="linenos">248</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;Z_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_test</span>
</span><span id="calculate_z-249"><a href="#calculate_z-249"><span class="linenos">249</span></a>
</span><span id="calculate_z-250"><a href="#calculate_z-250"><span class="linenos">250</span></a>    <span class="k">return</span> <span class="n">adata</span>
</span></pre></div>


            <div class="docstring"><p>Function to calculate Z matrix.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>adata</strong> : <em>AnnData</em></p>

<blockquote>
  <p>created by <code><a href="#create_adata">create_adata()</a></code> with <code>adata.uns.keys()</code> 
      <code>'sigma'</code>, <code>'train_indices'</code>, and <code>'test_indices'</code>. 
      <code>'sigma'</code> key can be added by running <code><a href="#estimate_sigma">estimate_sigma()</a></code> on 
      adata. </p>
</blockquote>

<p><strong>n_features</strong> : <em>int</em> </p>

<blockquote>
  <p>Number of random feature to use when calculating Z- used for 
      scalability.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>adata</strong> : <em>AnnData</em></p>

<blockquote>
  <p>adata with Z matrices accessible with <code>adata.uns['Z_train']</code> 
      and <code>adata.uns['Z_test']</code>.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/estimate_sigma.html">scmkl.estimate_sigma</a></span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/calculate_z.html">scmkl.calculate_z</a></span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="go">dict_keys([&#39;Z_train&#39;, &#39;Z_test&#39;, &#39;sigmas&#39;, &#39;train_indices&#39;, </span>
<span class="go">&#39;test_indices&#39;])</span>
</code></pre>
</div>
</div>


                </section>
                <section id="create_adata">
                            <input id="create_adata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_adata</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">X</span>,</span><span class="param">	<span class="n">feature_names</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">cell_labels</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">group_dict</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">scale_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">split_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">D</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">remove_features</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">train_ratio</span><span class="o">=</span><span class="mf">0.8</span>,</span><span class="param">	<span class="n">distance_metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span>,</span><span class="param">	<span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;Gaussian&#39;</span>,</span><span class="param">	<span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">allow_multiclass</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">class_threshold</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span>,</span><span class="param">	<span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tfidf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="create_adata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_adata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_adata-214"><a href="#create_adata-214"><span class="linenos">214</span></a><span class="k">def</span> <span class="nf">create_adata</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cell_labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
</span><span id="create_adata-215"><a href="#create_adata-215"><span class="linenos">215</span></a>                 <span class="n">group_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">scale_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
</span><span id="create_adata-216"><a href="#create_adata-216"><span class="linenos">216</span></a>                 <span class="n">split_data</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">D</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="create_adata-217"><a href="#create_adata-217"><span class="linenos">217</span></a>                 <span class="n">remove_features</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">train_ratio</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
</span><span id="create_adata-218"><a href="#create_adata-218"><span class="linenos">218</span></a>                 <span class="n">distance_metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">kernel_type</span> <span class="o">=</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">,</span> 
</span><span id="create_adata-219"><a href="#create_adata-219"><span class="linenos">219</span></a>                 <span class="n">random_state</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">allow_multiclass</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="create_adata-220"><a href="#create_adata-220"><span class="linenos">220</span></a>                 <span class="n">class_threshold</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
</span><span id="create_adata-221"><a href="#create_adata-221"><span class="linenos">221</span></a>                 <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tfidf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="create_adata-222"><a href="#create_adata-222"><span class="linenos">222</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="create_adata-223"><a href="#create_adata-223"><span class="linenos">223</span></a><span class="sd">    Function to create an AnnData object to carry all relevant </span>
</span><span id="create_adata-224"><a href="#create_adata-224"><span class="linenos">224</span></a><span class="sd">    information going forward.</span>
</span><span id="create_adata-225"><a href="#create_adata-225"><span class="linenos">225</span></a>
</span><span id="create_adata-226"><a href="#create_adata-226"><span class="linenos">226</span></a><span class="sd">    Parameters</span>
</span><span id="create_adata-227"><a href="#create_adata-227"><span class="linenos">227</span></a><span class="sd">    ----------</span>
</span><span id="create_adata-228"><a href="#create_adata-228"><span class="linenos">228</span></a><span class="sd">    **X** : *scipy.sparse.csc_matrix* | *np.ndarray* | </span>
</span><span id="create_adata-229"><a href="#create_adata-229"><span class="linenos">229</span></a><span class="sd">            *pd.DataFrame*</span>
</span><span id="create_adata-230"><a href="#create_adata-230"><span class="linenos">230</span></a><span class="sd">        &gt; A data matrix of cells by features (sparse array </span>
</span><span id="create_adata-231"><a href="#create_adata-231"><span class="linenos">231</span></a><span class="sd">        recommended for large datasets).</span>
</span><span id="create_adata-232"><a href="#create_adata-232"><span class="linenos">232</span></a>
</span><span id="create_adata-233"><a href="#create_adata-233"><span class="linenos">233</span></a><span class="sd">    **feature_names** : *np.ndarray*</span>
</span><span id="create_adata-234"><a href="#create_adata-234"><span class="linenos">234</span></a><span class="sd">        &gt; array of feature names corresponding with the features </span>
</span><span id="create_adata-235"><a href="#create_adata-235"><span class="linenos">235</span></a><span class="sd">        in X.</span>
</span><span id="create_adata-236"><a href="#create_adata-236"><span class="linenos">236</span></a>
</span><span id="create_adata-237"><a href="#create_adata-237"><span class="linenos">237</span></a><span class="sd">    **cell_labels** : *np.ndarray*</span>
</span><span id="create_adata-238"><a href="#create_adata-238"><span class="linenos">238</span></a><span class="sd">        &gt; A numpy array of cell phenotypes corresponding with </span>
</span><span id="create_adata-239"><a href="#create_adata-239"><span class="linenos">239</span></a><span class="sd">        the cells in X.</span>
</span><span id="create_adata-240"><a href="#create_adata-240"><span class="linenos">240</span></a>
</span><span id="create_adata-241"><a href="#create_adata-241"><span class="linenos">241</span></a><span class="sd">    **group_dict** : *dict* </span>
</span><span id="create_adata-242"><a href="#create_adata-242"><span class="linenos">242</span></a><span class="sd">        &gt; Dictionary containing feature grouping information.</span>
</span><span id="create_adata-243"><a href="#create_adata-243"><span class="linenos">243</span></a><span class="sd">            - Example: {geneset: np.array([gene_1, gene_2, ..., </span>
</span><span id="create_adata-244"><a href="#create_adata-244"><span class="linenos">244</span></a><span class="sd">                        gene_n])}</span>
</span><span id="create_adata-245"><a href="#create_adata-245"><span class="linenos">245</span></a>
</span><span id="create_adata-246"><a href="#create_adata-246"><span class="linenos">246</span></a><span class="sd">    **scale_data** : *bool*  </span>
</span><span id="create_adata-247"><a href="#create_adata-247"><span class="linenos">247</span></a><span class="sd">        &gt; If `True`, data matrix is log transformed and standard </span>
</span><span id="create_adata-248"><a href="#create_adata-248"><span class="linenos">248</span></a><span class="sd">        scaled. </span>
</span><span id="create_adata-249"><a href="#create_adata-249"><span class="linenos">249</span></a><span class="sd">        </span>
</span><span id="create_adata-250"><a href="#create_adata-250"><span class="linenos">250</span></a><span class="sd">    **split_data** : *None* | *np.ndarray*</span>
</span><span id="create_adata-251"><a href="#create_adata-251"><span class="linenos">251</span></a><span class="sd">        &gt; If *None*, data will be split stratified by cell labels. </span>
</span><span id="create_adata-252"><a href="#create_adata-252"><span class="linenos">252</span></a><span class="sd">        Else, is an array of precalculated train/test split </span>
</span><span id="create_adata-253"><a href="#create_adata-253"><span class="linenos">253</span></a><span class="sd">        corresponding to samples. Can include labels for entire</span>
</span><span id="create_adata-254"><a href="#create_adata-254"><span class="linenos">254</span></a><span class="sd">        dataset to benchmark performance or for only training</span>
</span><span id="create_adata-255"><a href="#create_adata-255"><span class="linenos">255</span></a><span class="sd">        data to classify unknown cell types.</span>
</span><span id="create_adata-256"><a href="#create_adata-256"><span class="linenos">256</span></a><span class="sd">            - Example: np.array([&#39;train&#39;, &#39;test&#39;, ..., &#39;train&#39;])</span>
</span><span id="create_adata-257"><a href="#create_adata-257"><span class="linenos">257</span></a>
</span><span id="create_adata-258"><a href="#create_adata-258"><span class="linenos">258</span></a><span class="sd">    **D** : *int* </span>
</span><span id="create_adata-259"><a href="#create_adata-259"><span class="linenos">259</span></a><span class="sd">        &gt; Number of Random Fourier Features used to calculate Z. </span>
</span><span id="create_adata-260"><a href="#create_adata-260"><span class="linenos">260</span></a><span class="sd">        Should be a positive integer. Higher values of D will </span>
</span><span id="create_adata-261"><a href="#create_adata-261"><span class="linenos">261</span></a><span class="sd">        increase classification accuracy at the cost of computation </span>
</span><span id="create_adata-262"><a href="#create_adata-262"><span class="linenos">262</span></a><span class="sd">        time. If set to `None`, will be calculated given number of </span>
</span><span id="create_adata-263"><a href="#create_adata-263"><span class="linenos">263</span></a><span class="sd">        samples. </span>
</span><span id="create_adata-264"><a href="#create_adata-264"><span class="linenos">264</span></a><span class="sd">    </span>
</span><span id="create_adata-265"><a href="#create_adata-265"><span class="linenos">265</span></a><span class="sd">    **remove_features** : *bool* </span>
</span><span id="create_adata-266"><a href="#create_adata-266"><span class="linenos">266</span></a><span class="sd">        &gt; If `True`, will remove features from X and feature_names</span>
</span><span id="create_adata-267"><a href="#create_adata-267"><span class="linenos">267</span></a><span class="sd">        not in group_dict and remove features from groupings not in</span>
</span><span id="create_adata-268"><a href="#create_adata-268"><span class="linenos">268</span></a><span class="sd">        feature_names.</span>
</span><span id="create_adata-269"><a href="#create_adata-269"><span class="linenos">269</span></a>
</span><span id="create_adata-270"><a href="#create_adata-270"><span class="linenos">270</span></a><span class="sd">    **train_ratio** : *float*</span>
</span><span id="create_adata-271"><a href="#create_adata-271"><span class="linenos">271</span></a><span class="sd">        &gt; Ratio of number of training samples to entire data set. Note:</span>
</span><span id="create_adata-272"><a href="#create_adata-272"><span class="linenos">272</span></a><span class="sd">        if a threshold is applied, the ratio training samples may </span>
</span><span id="create_adata-273"><a href="#create_adata-273"><span class="linenos">273</span></a><span class="sd">        decrease depending on class balance and `class_threshold`</span>
</span><span id="create_adata-274"><a href="#create_adata-274"><span class="linenos">274</span></a><span class="sd">        parameter if `allow_multiclass = True`.</span>
</span><span id="create_adata-275"><a href="#create_adata-275"><span class="linenos">275</span></a>
</span><span id="create_adata-276"><a href="#create_adata-276"><span class="linenos">276</span></a><span class="sd">    **distance_metric** : *str* </span>
</span><span id="create_adata-277"><a href="#create_adata-277"><span class="linenos">277</span></a><span class="sd">        &gt; The pairwise distance metric used to estimate sigma. Must</span>
</span><span id="create_adata-278"><a href="#create_adata-278"><span class="linenos">278</span></a><span class="sd">        be one of the options used in scipy.spatial.distance.cdist.</span>
</span><span id="create_adata-279"><a href="#create_adata-279"><span class="linenos">279</span></a>
</span><span id="create_adata-280"><a href="#create_adata-280"><span class="linenos">280</span></a><span class="sd">    **kernel_type** : *str*</span>
</span><span id="create_adata-281"><a href="#create_adata-281"><span class="linenos">281</span></a><span class="sd">        &gt; The approximated kernel function used to calculate Zs.</span>
</span><span id="create_adata-282"><a href="#create_adata-282"><span class="linenos">282</span></a><span class="sd">        Must be one of `&#39;Gaussian&#39;`, `&#39;Laplacian&#39;`, or `&#39;Cauchy&#39;`.</span>
</span><span id="create_adata-283"><a href="#create_adata-283"><span class="linenos">283</span></a>
</span><span id="create_adata-284"><a href="#create_adata-284"><span class="linenos">284</span></a><span class="sd">    **random_state** : *int*</span>
</span><span id="create_adata-285"><a href="#create_adata-285"><span class="linenos">285</span></a><span class="sd">        &gt; Integer random_state used to set the seed for </span>
</span><span id="create_adata-286"><a href="#create_adata-286"><span class="linenos">286</span></a><span class="sd">        reproducibilty.</span>
</span><span id="create_adata-287"><a href="#create_adata-287"><span class="linenos">287</span></a>
</span><span id="create_adata-288"><a href="#create_adata-288"><span class="linenos">288</span></a><span class="sd">    **allow_multiclass** : *bool*</span>
</span><span id="create_adata-289"><a href="#create_adata-289"><span class="linenos">289</span></a><span class="sd">        &gt; If `False`, will ensure that cell labels are binary.</span>
</span><span id="create_adata-290"><a href="#create_adata-290"><span class="linenos">290</span></a>
</span><span id="create_adata-291"><a href="#create_adata-291"><span class="linenos">291</span></a><span class="sd">    **class_threshold** : *str* | *int*</span>
</span><span id="create_adata-292"><a href="#create_adata-292"><span class="linenos">292</span></a><span class="sd">        &gt; Number of samples allowed in the training data for each cell</span>
</span><span id="create_adata-293"><a href="#create_adata-293"><span class="linenos">293</span></a><span class="sd">        class in the training data. If `&#39;median&#39;`, the median number of</span>
</span><span id="create_adata-294"><a href="#create_adata-294"><span class="linenos">294</span></a><span class="sd">        cells per cell class will be the threshold for number of </span>
</span><span id="create_adata-295"><a href="#create_adata-295"><span class="linenos">295</span></a><span class="sd">        samples per class.</span>
</span><span id="create_adata-296"><a href="#create_adata-296"><span class="linenos">296</span></a>
</span><span id="create_adata-297"><a href="#create_adata-297"><span class="linenos">297</span></a><span class="sd">    **reduction**: *str* | *None*</span>
</span><span id="create_adata-298"><a href="#create_adata-298"><span class="linenos">298</span></a><span class="sd">        &gt; Choose which dimension reduction technique to perform on features</span>
</span><span id="create_adata-299"><a href="#create_adata-299"><span class="linenos">299</span></a><span class="sd">        within a group.  &#39;svd&#39; will run sklearn.decomposition.TruncatedSVD,</span>
</span><span id="create_adata-300"><a href="#create_adata-300"><span class="linenos">300</span></a><span class="sd">        &#39;linear&#39; will multiply by an array of 1s down to 50 dimensions.</span>
</span><span id="create_adata-301"><a href="#create_adata-301"><span class="linenos">301</span></a><span class="sd">        </span>
</span><span id="create_adata-302"><a href="#create_adata-302"><span class="linenos">302</span></a><span class="sd">    **tfidf**: *bool*</span>
</span><span id="create_adata-303"><a href="#create_adata-303"><span class="linenos">303</span></a><span class="sd">        &gt; Whether to calculate TFIDF transformation on peaks within </span>
</span><span id="create_adata-304"><a href="#create_adata-304"><span class="linenos">304</span></a><span class="sd">        groupings.</span>
</span><span id="create_adata-305"><a href="#create_adata-305"><span class="linenos">305</span></a><span class="sd">        </span>
</span><span id="create_adata-306"><a href="#create_adata-306"><span class="linenos">306</span></a><span class="sd">    Returns</span>
</span><span id="create_adata-307"><a href="#create_adata-307"><span class="linenos">307</span></a><span class="sd">    -------</span>
</span><span id="create_adata-308"><a href="#create_adata-308"><span class="linenos">308</span></a><span class="sd">    **adata** : *AnnData*</span>
</span><span id="create_adata-309"><a href="#create_adata-309"><span class="linenos">309</span></a><span class="sd">    &gt; *AnnData* with the following attributes and keys:</span>
</span><span id="create_adata-310"><a href="#create_adata-310"><span class="linenos">310</span></a>
</span><span id="create_adata-311"><a href="#create_adata-311"><span class="linenos">311</span></a><span class="sd">    &gt; `adata.X` : the data matrix.</span>
</span><span id="create_adata-312"><a href="#create_adata-312"><span class="linenos">312</span></a><span class="sd">    </span>
</span><span id="create_adata-313"><a href="#create_adata-313"><span class="linenos">313</span></a><span class="sd">    &gt; `adata.var_names` : the feature names corresponding to</span>
</span><span id="create_adata-314"><a href="#create_adata-314"><span class="linenos">314</span></a><span class="sd">    `adata.X`.</span>
</span><span id="create_adata-315"><a href="#create_adata-315"><span class="linenos">315</span></a>
</span><span id="create_adata-316"><a href="#create_adata-316"><span class="linenos">316</span></a><span class="sd">    &gt; `adata.obs[&#39;labels&#39;]` : cell classes/phenotypes from </span>
</span><span id="create_adata-317"><a href="#create_adata-317"><span class="linenos">317</span></a><span class="sd">    `cell_labels`.</span>
</span><span id="create_adata-318"><a href="#create_adata-318"><span class="linenos">318</span></a>
</span><span id="create_adata-319"><a href="#create_adata-319"><span class="linenos">319</span></a><span class="sd">    &gt; `adata.uns[&#39;train_indices&#39;]` : Indices for training data. </span>
</span><span id="create_adata-320"><a href="#create_adata-320"><span class="linenos">320</span></a>
</span><span id="create_adata-321"><a href="#create_adata-321"><span class="linenos">321</span></a><span class="sd">    &gt; `adata.uns[&#39;test_indices&#39;]` : Indices for testing data.</span>
</span><span id="create_adata-322"><a href="#create_adata-322"><span class="linenos">322</span></a>
</span><span id="create_adata-323"><a href="#create_adata-323"><span class="linenos">323</span></a><span class="sd">    &gt; `adata.uns[&#39;group_dict&#39;]` : Grouping information.</span>
</span><span id="create_adata-324"><a href="#create_adata-324"><span class="linenos">324</span></a>
</span><span id="create_adata-325"><a href="#create_adata-325"><span class="linenos">325</span></a><span class="sd">    &gt; `adata.uns[&#39;seed_obj&#39;]` : Seed object with seed equal to</span>
</span><span id="create_adata-326"><a href="#create_adata-326"><span class="linenos">326</span></a><span class="sd">    100 * `random_state`.</span>
</span><span id="create_adata-327"><a href="#create_adata-327"><span class="linenos">327</span></a>
</span><span id="create_adata-328"><a href="#create_adata-328"><span class="linenos">328</span></a><span class="sd">    &gt; `with adata.uns[&#39;D&#39;]` : Number of dimensions to scMKL with.</span>
</span><span id="create_adata-329"><a href="#create_adata-329"><span class="linenos">329</span></a>
</span><span id="create_adata-330"><a href="#create_adata-330"><span class="linenos">330</span></a><span class="sd">    &gt; `adata.uns[&#39;scale_data&#39;]` : *bool* for whether or not data is log</span>
</span><span id="create_adata-331"><a href="#create_adata-331"><span class="linenos">331</span></a><span class="sd">    transformed and scaled.</span>
</span><span id="create_adata-332"><a href="#create_adata-332"><span class="linenos">332</span></a>
</span><span id="create_adata-333"><a href="#create_adata-333"><span class="linenos">333</span></a><span class="sd">    &gt; `adata.uns[&#39;distance_metric&#39;]` : Distance metric as given.</span>
</span><span id="create_adata-334"><a href="#create_adata-334"><span class="linenos">334</span></a><span class="sd">    </span>
</span><span id="create_adata-335"><a href="#create_adata-335"><span class="linenos">335</span></a><span class="sd">    &gt; `adata.uns[&#39;kernel_type&#39;]` : Kernel function as given.</span>
</span><span id="create_adata-336"><a href="#create_adata-336"><span class="linenos">336</span></a>
</span><span id="create_adata-337"><a href="#create_adata-337"><span class="linenos">337</span></a><span class="sd">    &gt; `adata.uns[&#39;svd&#39;] : *bool* for whether to calculate svd reduction.</span>
</span><span id="create_adata-338"><a href="#create_adata-338"><span class="linenos">338</span></a>
</span><span id="create_adata-339"><a href="#create_adata-339"><span class="linenos">339</span></a><span class="sd">    &gt; `adata.uns[&#39;tfidf&#39;] : *bool* for whether to calculate tfidf per grouping.</span>
</span><span id="create_adata-340"><a href="#create_adata-340"><span class="linenos">340</span></a>
</span><span id="create_adata-341"><a href="#create_adata-341"><span class="linenos">341</span></a><span class="sd">    Examples</span>
</span><span id="create_adata-342"><a href="#create_adata-342"><span class="linenos">342</span></a><span class="sd">    --------</span>
</span><span id="create_adata-343"><a href="#create_adata-343"><span class="linenos">343</span></a><span class="sd">    &gt;&gt;&gt; data_mat = scipy.sparse.load_npz(&#39;MCF7_RNA_matrix.npz&#39;)</span>
</span><span id="create_adata-344"><a href="#create_adata-344"><span class="linenos">344</span></a><span class="sd">    &gt;&gt;&gt; gene_names = np.load(&#39;MCF7_gene_names.pkl&#39;, allow_pickle = True)</span>
</span><span id="create_adata-345"><a href="#create_adata-345"><span class="linenos">345</span></a><span class="sd">    &gt;&gt;&gt; group_dict = np.load(&#39;hallmark_genesets.pkl&#39;, </span>
</span><span id="create_adata-346"><a href="#create_adata-346"><span class="linenos">346</span></a><span class="sd">    &gt;&gt;&gt;                      allow_pickle = True)</span>
</span><span id="create_adata-347"><a href="#create_adata-347"><span class="linenos">347</span></a><span class="sd">    &gt;&gt;&gt; </span>
</span><span id="create_adata-348"><a href="#create_adata-348"><span class="linenos">348</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.create_adata(X = data_mat, </span>
</span><span id="create_adata-349"><a href="#create_adata-349"><span class="linenos">349</span></a><span class="sd">    ...                            feature_names = gene_names, </span>
</span><span id="create_adata-350"><a href="#create_adata-350"><span class="linenos">350</span></a><span class="sd">    ...                            group_dict = group_dict)</span>
</span><span id="create_adata-351"><a href="#create_adata-351"><span class="linenos">351</span></a><span class="sd">    &gt;&gt;&gt; adata</span>
</span><span id="create_adata-352"><a href="#create_adata-352"><span class="linenos">352</span></a><span class="sd">    AnnData object with n_obs × n_vars = 1000 × 4341</span>
</span><span id="create_adata-353"><a href="#create_adata-353"><span class="linenos">353</span></a><span class="sd">    obs: &#39;labels&#39;</span>
</span><span id="create_adata-354"><a href="#create_adata-354"><span class="linenos">354</span></a><span class="sd">    uns: &#39;group_dict&#39;, &#39;seed_obj&#39;, &#39;scale_data&#39;, &#39;D&#39;, &#39;kernel_type&#39;, </span>
</span><span id="create_adata-355"><a href="#create_adata-355"><span class="linenos">355</span></a><span class="sd">    &#39;distance_metric&#39;, &#39;train_indices&#39;, &#39;test_indices&#39;</span>
</span><span id="create_adata-356"><a href="#create_adata-356"><span class="linenos">356</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="create_adata-357"><a href="#create_adata-357"><span class="linenos">357</span></a>
</span><span id="create_adata-358"><a href="#create_adata-358"><span class="linenos">358</span></a>    <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Different number of features &quot;</span>
</span><span id="create_adata-359"><a href="#create_adata-359"><span class="linenos">359</span></a>                                              <span class="s2">&quot;in X than feature names&quot;</span><span class="p">)</span>
</span><span id="create_adata-360"><a href="#create_adata-360"><span class="linenos">360</span></a>    
</span><span id="create_adata-361"><a href="#create_adata-361"><span class="linenos">361</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_multiclass</span><span class="p">:</span>
</span><span id="create_adata-362"><a href="#create_adata-362"><span class="linenos">362</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cell_labels</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;cell_labels must contain &quot;</span>
</span><span id="create_adata-363"><a href="#create_adata-363"><span class="linenos">363</span></a>                                                  <span class="s2">&quot;2 classes&quot;</span><span class="p">)</span>
</span><span id="create_adata-364"><a href="#create_adata-364"><span class="linenos">364</span></a>    <span class="k">if</span> <span class="n">D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
</span><span id="create_adata-365"><a href="#create_adata-365"><span class="linenos">365</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">D</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;D must be a positive integer&#39;</span>
</span><span id="create_adata-366"><a href="#create_adata-366"><span class="linenos">366</span></a>
</span><span id="create_adata-367"><a href="#create_adata-367"><span class="linenos">367</span></a>    <span class="n">kernel_options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;laplacian&#39;</span><span class="p">,</span> <span class="s1">&#39;cauchy&#39;</span><span class="p">]</span>
</span><span id="create_adata-368"><a href="#create_adata-368"><span class="linenos">368</span></a>    <span class="k">assert</span> <span class="n">kernel_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">kernel_options</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Given kernel type not &quot;</span>
</span><span id="create_adata-369"><a href="#create_adata-369"><span class="linenos">369</span></a>                                                   <span class="s2">&quot;implemented. Gaussian, &quot;</span>
</span><span id="create_adata-370"><a href="#create_adata-370"><span class="linenos">370</span></a>                                                   <span class="s2">&quot;Laplacian, and Cauchy &quot;</span>
</span><span id="create_adata-371"><a href="#create_adata-371"><span class="linenos">371</span></a>                                                   <span class="s2">&quot;are the acceptable &quot;</span>
</span><span id="create_adata-372"><a href="#create_adata-372"><span class="linenos">372</span></a>                                                   <span class="s2">&quot;types.&quot;</span><span class="p">)</span>
</span><span id="create_adata-373"><a href="#create_adata-373"><span class="linenos">373</span></a>
</span><span id="create_adata-374"><a href="#create_adata-374"><span class="linenos">374</span></a>    <span class="n">X</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">group_dict</span> <span class="o">=</span> <span class="n">_filter_features</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> 
</span><span id="create_adata-375"><a href="#create_adata-375"><span class="linenos">375</span></a>                                                    <span class="n">feature_names</span><span class="p">,</span> 
</span><span id="create_adata-376"><a href="#create_adata-376"><span class="linenos">376</span></a>                                                    <span class="n">group_dict</span><span class="p">,</span> 
</span><span id="create_adata-377"><a href="#create_adata-377"><span class="linenos">377</span></a>                                                    <span class="n">remove_features</span><span class="p">)</span>
</span><span id="create_adata-378"><a href="#create_adata-378"><span class="linenos">378</span></a>
</span><span id="create_adata-379"><a href="#create_adata-379"><span class="linenos">379</span></a>    <span class="c1"># Create adata object and add column names</span>
</span><span id="create_adata-380"><a href="#create_adata-380"><span class="linenos">380</span></a>    <span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="create_adata-381"><a href="#create_adata-381"><span class="linenos">381</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">feature_names</span>
</span><span id="create_adata-382"><a href="#create_adata-382"><span class="linenos">382</span></a>
</span><span id="create_adata-383"><a href="#create_adata-383"><span class="linenos">383</span></a>    <span class="c1"># Add metadata to adata object</span>
</span><span id="create_adata-384"><a href="#create_adata-384"><span class="linenos">384</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;group_dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_dict</span>
</span><span id="create_adata-385"><a href="#create_adata-385"><span class="linenos">385</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">random_state</span><span class="p">)</span>
</span><span id="create_adata-386"><a href="#create_adata-386"><span class="linenos">386</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;scale_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_data</span>
</span><span id="create_adata-387"><a href="#create_adata-387"><span class="linenos">387</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span> <span class="k">if</span> <span class="n">D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">calculate_d</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="create_adata-388"><a href="#create_adata-388"><span class="linenos">388</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;kernel_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_type</span>
</span><span id="create_adata-389"><a href="#create_adata-389"><span class="linenos">389</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;distance_metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_metric</span>
</span><span id="create_adata-390"><a href="#create_adata-390"><span class="linenos">390</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;reduction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduction</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduction</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span>
</span><span id="create_adata-391"><a href="#create_adata-391"><span class="linenos">391</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;tfidf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tfidf</span>
</span><span id="create_adata-392"><a href="#create_adata-392"><span class="linenos">392</span></a>
</span><span id="create_adata-393"><a href="#create_adata-393"><span class="linenos">393</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">split_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="create_adata-394"><a href="#create_adata-394"><span class="linenos">394</span></a>        <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_labels</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Different number of cells &quot;</span>
</span><span id="create_adata-395"><a href="#create_adata-395"><span class="linenos">395</span></a>                                                <span class="s2">&quot;than labels&quot;</span><span class="p">)</span>
</span><span id="create_adata-396"><a href="#create_adata-396"><span class="linenos">396</span></a>        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_labels</span>
</span><span id="create_adata-397"><a href="#create_adata-397"><span class="linenos">397</span></a>
</span><span id="create_adata-398"><a href="#create_adata-398"><span class="linenos">398</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">allow_multiclass</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="create_adata-399"><a href="#create_adata-399"><span class="linenos">399</span></a>            <span class="n">split</span> <span class="o">=</span> <span class="n">_binary_split</span><span class="p">(</span><span class="n">cell_labels</span><span class="p">,</span> 
</span><span id="create_adata-400"><a href="#create_adata-400"><span class="linenos">400</span></a>                                  <span class="n">seed_obj</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">],</span>
</span><span id="create_adata-401"><a href="#create_adata-401"><span class="linenos">401</span></a>                                  <span class="n">train_ratio</span> <span class="o">=</span> <span class="n">train_ratio</span><span class="p">)</span>
</span><span id="create_adata-402"><a href="#create_adata-402"><span class="linenos">402</span></a>            <span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span> <span class="o">=</span> <span class="n">split</span>
</span><span id="create_adata-403"><a href="#create_adata-403"><span class="linenos">403</span></a>
</span><span id="create_adata-404"><a href="#create_adata-404"><span class="linenos">404</span></a>        <span class="k">elif</span> <span class="p">(</span><span class="n">allow_multiclass</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="create_adata-405"><a href="#create_adata-405"><span class="linenos">405</span></a>            <span class="n">split</span> <span class="o">=</span> <span class="n">_multi_class_split</span><span class="p">(</span><span class="n">cell_labels</span><span class="p">,</span> 
</span><span id="create_adata-406"><a href="#create_adata-406"><span class="linenos">406</span></a>                                       <span class="n">seed_obj</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">],</span> 
</span><span id="create_adata-407"><a href="#create_adata-407"><span class="linenos">407</span></a>                                       <span class="n">class_threshold</span> <span class="o">=</span> <span class="n">class_threshold</span><span class="p">,</span>
</span><span id="create_adata-408"><a href="#create_adata-408"><span class="linenos">408</span></a>                                       <span class="n">train_ratio</span> <span class="o">=</span> <span class="n">train_ratio</span><span class="p">)</span>
</span><span id="create_adata-409"><a href="#create_adata-409"><span class="linenos">409</span></a>            <span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span> <span class="o">=</span> <span class="n">split</span>
</span><span id="create_adata-410"><a href="#create_adata-410"><span class="linenos">410</span></a>
</span><span id="create_adata-411"><a href="#create_adata-411"><span class="linenos">411</span></a>        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;labeled_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="create_adata-412"><a href="#create_adata-412"><span class="linenos">412</span></a>
</span><span id="create_adata-413"><a href="#create_adata-413"><span class="linenos">413</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="create_adata-414"><a href="#create_adata-414"><span class="linenos">414</span></a>        <span class="n">x_eq_labs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_labels</span><span class="p">)</span>
</span><span id="create_adata-415"><a href="#create_adata-415"><span class="linenos">415</span></a>        <span class="n">train_eq_labs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_labels</span><span class="p">)</span>
</span><span id="create_adata-416"><a href="#create_adata-416"><span class="linenos">416</span></a>        <span class="k">assert</span> <span class="n">x_eq_labs</span> <span class="ow">or</span> <span class="n">train_eq_labs</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Must give labels for all cells &quot;</span>
</span><span id="create_adata-417"><a href="#create_adata-417"><span class="linenos">417</span></a>                                            <span class="s2">&quot;or only for training cells&quot;</span><span class="p">)</span>
</span><span id="create_adata-418"><a href="#create_adata-418"><span class="linenos">418</span></a>        
</span><span id="create_adata-419"><a href="#create_adata-419"><span class="linenos">419</span></a>        <span class="n">train_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">split_data</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="create_adata-420"><a href="#create_adata-420"><span class="linenos">420</span></a>        <span class="n">test_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">split_data</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="create_adata-421"><a href="#create_adata-421"><span class="linenos">421</span></a>
</span><span id="create_adata-422"><a href="#create_adata-422"><span class="linenos">422</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_indices</span><span class="p">):</span>
</span><span id="create_adata-423"><a href="#create_adata-423"><span class="linenos">423</span></a>
</span><span id="create_adata-424"><a href="#create_adata-424"><span class="linenos">424</span></a>            <span class="n">padded_cell_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
</span><span id="create_adata-425"><a href="#create_adata-425"><span class="linenos">425</span></a>            <span class="n">padded_cell_labels</span><span class="p">[</span><span class="n">train_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_labels</span>
</span><span id="create_adata-426"><a href="#create_adata-426"><span class="linenos">426</span></a>            <span class="n">padded_cell_labels</span><span class="p">[</span><span class="n">test_indices</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;padded_test_label&#39;</span>
</span><span id="create_adata-427"><a href="#create_adata-427"><span class="linenos">427</span></a>
</span><span id="create_adata-428"><a href="#create_adata-428"><span class="linenos">428</span></a>            <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">padded_cell_labels</span>
</span><span id="create_adata-429"><a href="#create_adata-429"><span class="linenos">429</span></a>            <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;labeled_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="create_adata-430"><a href="#create_adata-430"><span class="linenos">430</span></a>
</span><span id="create_adata-431"><a href="#create_adata-431"><span class="linenos">431</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_data</span><span class="p">):</span>
</span><span id="create_adata-432"><a href="#create_adata-432"><span class="linenos">432</span></a>            <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_labels</span>
</span><span id="create_adata-433"><a href="#create_adata-433"><span class="linenos">433</span></a>            <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;labeled_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="create_adata-434"><a href="#create_adata-434"><span class="linenos">434</span></a>
</span><span id="create_adata-435"><a href="#create_adata-435"><span class="linenos">435</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_indices</span>
</span><span id="create_adata-436"><a href="#create_adata-436"><span class="linenos">436</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_indices</span>
</span><span id="create_adata-437"><a href="#create_adata-437"><span class="linenos">437</span></a>
</span><span id="create_adata-438"><a href="#create_adata-438"><span class="linenos">438</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">scale_data</span><span class="p">:</span>
</span><span id="create_adata-439"><a href="#create_adata-439"><span class="linenos">439</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Data will not be log transformed and scaled &quot;</span>
</span><span id="create_adata-440"><a href="#create_adata-440"><span class="linenos">440</span></a>              <span class="s2">&quot;To change this behavior, set scale_data to True&quot;</span><span class="p">)</span>
</span><span id="create_adata-441"><a href="#create_adata-441"><span class="linenos">441</span></a>
</span><span id="create_adata-442"><a href="#create_adata-442"><span class="linenos">442</span></a>    <span class="k">return</span> <span class="n">adata</span>
</span></pre></div>


            <div class="docstring"><p>Function to create an AnnData object to carry all relevant 
information going forward.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>X</strong> : <em>scipy.sparse.csc_matrix</em> | <em>np.ndarray</em> | 
        <em>pd.DataFrame</em></p>

<blockquote>
  <p>A data matrix of cells by features (sparse array 
      recommended for large datasets).</p>
</blockquote>

<p><strong>feature_names</strong> : <em>np.ndarray</em></p>

<blockquote>
  <p>array of feature names corresponding with the features 
      in X.</p>
</blockquote>

<p><strong>cell_labels</strong> : <em>np.ndarray</em></p>

<blockquote>
  <p>A numpy array of cell phenotypes corresponding with 
      the cells in X.</p>
</blockquote>

<p><strong>group_dict</strong> : <em>dict</em> </p>

<blockquote>
  <p>Dictionary containing feature grouping information.
          - Example: {geneset: np.array([gene_1, gene_2, ..., 
                      gene_n])}</p>
</blockquote>

<p><strong>scale_data</strong> : <em>bool</em>  </p>

<blockquote>
  <p>If <code>True</code>, data matrix is log transformed and standard 
      scaled. </p>
</blockquote>

<p><strong>split_data</strong> : <em>None</em> | <em>np.ndarray</em></p>

<blockquote>
  <p>If <em>None</em>, data will be split stratified by cell labels. 
      Else, is an array of precalculated train/test split 
      corresponding to samples. Can include labels for entire
      dataset to benchmark performance or for only training
      data to classify unknown cell types.
          - Example: np.array(['train', 'test', ..., 'train'])</p>
</blockquote>

<p><strong>D</strong> : <em>int</em> </p>

<blockquote>
  <p>Number of Random Fourier Features used to calculate Z. 
      Should be a positive integer. Higher values of D will 
      increase classification accuracy at the cost of computation 
      time. If set to <code>None</code>, will be calculated given number of 
      samples. </p>
</blockquote>

<p><strong>remove_features</strong> : <em>bool</em> </p>

<blockquote>
  <p>If <code>True</code>, will remove features from X and feature_names
      not in group_dict and remove features from groupings not in
      feature_names.</p>
</blockquote>

<p><strong>train_ratio</strong> : <em>float</em></p>

<blockquote>
  <p>Ratio of number of training samples to entire data set. Note:
      if a threshold is applied, the ratio training samples may 
      decrease depending on class balance and <code>class_threshold</code>
      parameter if <code>allow_multiclass = True</code>.</p>
</blockquote>

<p><strong>distance_metric</strong> : <em>str</em> </p>

<blockquote>
  <p>The pairwise distance metric used to estimate sigma. Must
      be one of the options used in scipy.spatial.distance.cdist.</p>
</blockquote>

<p><strong>kernel_type</strong> : <em>str</em></p>

<blockquote>
  <p>The approximated kernel function used to calculate Zs.
      Must be one of <code>'Gaussian'</code>, <code>'Laplacian'</code>, or <code>'Cauchy'</code>.</p>
</blockquote>

<p><strong>random_state</strong> : <em>int</em></p>

<blockquote>
  <p>Integer random_state used to set the seed for 
      reproducibilty.</p>
</blockquote>

<p><strong>allow_multiclass</strong> : <em>bool</em></p>

<blockquote>
  <p>If <code>False</code>, will ensure that cell labels are binary.</p>
</blockquote>

<p><strong>class_threshold</strong> : <em>str</em> | <em>int</em></p>

<blockquote>
  <p>Number of samples allowed in the training data for each cell
      class in the training data. If <code>'median'</code>, the median number of
      cells per cell class will be the threshold for number of 
      samples per class.</p>
</blockquote>

<p><strong>reduction</strong>: <em>str</em> | <em>None</em></p>

<blockquote>
  <p>Choose which dimension reduction technique to perform on features
      within a group.  'svd' will run sklearn.decomposition.TruncatedSVD,
      'linear' will multiply by an array of 1s down to 50 dimensions.</p>
</blockquote>

<p><strong>tfidf</strong>: <em>bool</em></p>

<blockquote>
  <p>Whether to calculate TFIDF transformation on peaks within 
      groupings.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>adata</strong> : <em>AnnData</em></p>

<blockquote>
  <p><em>AnnData</em> with the following attributes and keys:</p>
</blockquote>

<blockquote>
  <p><code>adata.X</code> : the data matrix.</p>
</blockquote>

<blockquote>
  <p><code>adata.var_names</code> : the feature names corresponding to
  <code>adata.X</code>.</p>
</blockquote>

<blockquote>
  <p><code>adata.obs['labels']</code> : cell classes/phenotypes from 
  <code>cell_labels</code>.</p>
</blockquote>

<blockquote>
  <p><code>adata.uns['train_indices']</code> : Indices for training data. </p>
</blockquote>

<blockquote>
  <p><code>adata.uns['test_indices']</code> : Indices for testing data.</p>
</blockquote>

<blockquote>
  <p><code>adata.uns['group_dict']</code> : Grouping information.</p>
</blockquote>

<blockquote>
  <p><code>adata.uns['seed_obj']</code> : Seed object with seed equal to
  100 * <code>random_state</code>.</p>
</blockquote>

<blockquote>
  <p><code>with adata.uns['D']</code> : Number of dimensions to scMKL with.</p>
</blockquote>

<blockquote>
  <p><code>adata.uns['scale_data']</code> : <em>bool</em> for whether or not data is log
  transformed and scaled.</p>
</blockquote>

<blockquote>
  <p><code>adata.uns['distance_metric']</code> : Distance metric as given.</p>
</blockquote>

<blockquote>
  <p><code>adata.uns['kernel_type']</code> : Kernel function as given.</p>
</blockquote>

<blockquote>
  <p>`adata.uns['svd'] : <em>bool</em> for whether to calculate svd reduction.</p>
</blockquote>

<blockquote>
  <p>`adata.uns['tfidf'] : <em>bool</em> for whether to calculate tfidf per grouping.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">data_mat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">load_npz</span><span class="p">(</span><span class="s1">&#39;MCF7_RNA_matrix.npz&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gene_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;MCF7_gene_names.pkl&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">group_dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;hallmark_genesets.pkl&#39;</span><span class="p">,</span> 
<span class="gp">&gt;&gt;&gt; </span>                     <span class="n">allow_pickle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/create_adata.html">scmkl.create_adata</a></span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">data_mat</span><span class="p">,</span> 
<span class="gp">... </span>                           <span class="n">feature_names</span> <span class="o">=</span> <span class="n">gene_names</span><span class="p">,</span> 
<span class="gp">... </span>                           <span class="n">group_dict</span> <span class="o">=</span> <span class="n">group_dict</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span>
<span class="go">AnnData object with n_obs × n_vars = 1000 × 4341</span>
<span class="go">obs: &#39;labels&#39;</span>
<span class="go">uns: &#39;group_dict&#39;, &#39;seed_obj&#39;, &#39;scale_data&#39;, &#39;D&#39;, &#39;kernel_type&#39;, </span>
<span class="go">&#39;distance_metric&#39;, &#39;train_indices&#39;, &#39;test_indices&#39;</span>
</code></pre>
</div>
</div>


                </section>
                <section id="estimate_sigma">
                            <input id="estimate_sigma-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">estimate_sigma</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">adata</span>, </span><span class="param"><span class="n">n_features</span><span class="o">=</span><span class="mi">5000</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="estimate_sigma-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#estimate_sigma"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="estimate_sigma-9"><a href="#estimate_sigma-9"><span class="linenos">  9</span></a><span class="k">def</span> <span class="nf">estimate_sigma</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">):</span>
</span><span id="estimate_sigma-10"><a href="#estimate_sigma-10"><span class="linenos"> 10</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="estimate_sigma-11"><a href="#estimate_sigma-11"><span class="linenos"> 11</span></a><span class="sd">    Calculate kernel widths to inform distribution for projection of </span>
</span><span id="estimate_sigma-12"><a href="#estimate_sigma-12"><span class="linenos"> 12</span></a><span class="sd">    Fourier Features. Calculates one sigma per group of features.</span>
</span><span id="estimate_sigma-13"><a href="#estimate_sigma-13"><span class="linenos"> 13</span></a>
</span><span id="estimate_sigma-14"><a href="#estimate_sigma-14"><span class="linenos"> 14</span></a><span class="sd">    Parameters</span>
</span><span id="estimate_sigma-15"><a href="#estimate_sigma-15"><span class="linenos"> 15</span></a><span class="sd">    ----------</span>
</span><span id="estimate_sigma-16"><a href="#estimate_sigma-16"><span class="linenos"> 16</span></a><span class="sd">    **adata** : *AnnData* </span>
</span><span id="estimate_sigma-17"><a href="#estimate_sigma-17"><span class="linenos"> 17</span></a><span class="sd">        &gt; Created by `create_adata`.</span>
</span><span id="estimate_sigma-18"><a href="#estimate_sigma-18"><span class="linenos"> 18</span></a><span class="sd">    </span>
</span><span id="estimate_sigma-19"><a href="#estimate_sigma-19"><span class="linenos"> 19</span></a><span class="sd">    **n_features** : *int*  </span>
</span><span id="estimate_sigma-20"><a href="#estimate_sigma-20"><span class="linenos"> 20</span></a><span class="sd">        &gt; Number of random features to include when estimating sigma. </span>
</span><span id="estimate_sigma-21"><a href="#estimate_sigma-21"><span class="linenos"> 21</span></a><span class="sd">        Will be scaled for the whole pathway set according to a </span>
</span><span id="estimate_sigma-22"><a href="#estimate_sigma-22"><span class="linenos"> 22</span></a><span class="sd">        heuristic. Used for scalability.</span>
</span><span id="estimate_sigma-23"><a href="#estimate_sigma-23"><span class="linenos"> 23</span></a><span class="sd">    </span>
</span><span id="estimate_sigma-24"><a href="#estimate_sigma-24"><span class="linenos"> 24</span></a><span class="sd">    Returns</span>
</span><span id="estimate_sigma-25"><a href="#estimate_sigma-25"><span class="linenos"> 25</span></a><span class="sd">    -------</span>
</span><span id="estimate_sigma-26"><a href="#estimate_sigma-26"><span class="linenos"> 26</span></a><span class="sd">    **adata** : *AnnData*</span>
</span><span id="estimate_sigma-27"><a href="#estimate_sigma-27"><span class="linenos"> 27</span></a><span class="sd">        &gt; Key added `adata.uns[&#39;sigma&#39;]`.</span>
</span><span id="estimate_sigma-28"><a href="#estimate_sigma-28"><span class="linenos"> 28</span></a>
</span><span id="estimate_sigma-29"><a href="#estimate_sigma-29"><span class="linenos"> 29</span></a><span class="sd">    Examples</span>
</span><span id="estimate_sigma-30"><a href="#estimate_sigma-30"><span class="linenos"> 30</span></a><span class="sd">    --------</span>
</span><span id="estimate_sigma-31"><a href="#estimate_sigma-31"><span class="linenos"> 31</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.estimate_sigma(adata)</span>
</span><span id="estimate_sigma-32"><a href="#estimate_sigma-32"><span class="linenos"> 32</span></a><span class="sd">    &gt;&gt;&gt; adata.uns[&#39;sigma&#39;]</span>
</span><span id="estimate_sigma-33"><a href="#estimate_sigma-33"><span class="linenos"> 33</span></a><span class="sd">    array([10.4640895 , 10.82011454,  6.16769438,  9.86156855, ...])</span>
</span><span id="estimate_sigma-34"><a href="#estimate_sigma-34"><span class="linenos"> 34</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="estimate_sigma-35"><a href="#estimate_sigma-35"><span class="linenos"> 35</span></a>    <span class="n">sigma_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="estimate_sigma-36"><a href="#estimate_sigma-36"><span class="linenos"> 36</span></a>
</span><span id="estimate_sigma-37"><a href="#estimate_sigma-37"><span class="linenos"> 37</span></a>    <span class="c1"># Loop over every group in group_dict</span>
</span><span id="estimate_sigma-38"><a href="#estimate_sigma-38"><span class="linenos"> 38</span></a>    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">group_features</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;group_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="estimate_sigma-39"><a href="#estimate_sigma-39"><span class="linenos"> 39</span></a>
</span><span id="estimate_sigma-40"><a href="#estimate_sigma-40"><span class="linenos"> 40</span></a>        <span class="c1"># Select only features in that group and downsample for scalability</span>
</span><span id="estimate_sigma-41"><a href="#estimate_sigma-41"><span class="linenos"> 41</span></a>        <span class="n">num_group_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_features</span><span class="p">)</span>
</span><span id="estimate_sigma-42"><a href="#estimate_sigma-42"><span class="linenos"> 42</span></a>        <span class="n">group_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group_features</span><span class="p">))</span>
</span><span id="estimate_sigma-43"><a href="#estimate_sigma-43"><span class="linenos"> 43</span></a>        <span class="n">n_feats</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">n_features</span><span class="p">,</span> <span class="n">num_group_features</span><span class="p">])</span>
</span><span id="estimate_sigma-44"><a href="#estimate_sigma-44"><span class="linenos"> 44</span></a>        <span class="n">group_features</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">group_array</span><span class="p">,</span> <span class="n">n_feats</span><span class="p">,</span> 
</span><span id="estimate_sigma-45"><a href="#estimate_sigma-45"><span class="linenos"> 45</span></a>                                                      <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> 
</span><span id="estimate_sigma-46"><a href="#estimate_sigma-46"><span class="linenos"> 46</span></a>
</span><span id="estimate_sigma-47"><a href="#estimate_sigma-47"><span class="linenos"> 47</span></a>        <span class="c1"># Use on the train data to estimate sigma</span>
</span><span id="estimate_sigma-48"><a href="#estimate_sigma-48"><span class="linenos"> 48</span></a>        <span class="n">X_train</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">],</span> <span class="n">group_features</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
</span><span id="estimate_sigma-49"><a href="#estimate_sigma-49"><span class="linenos"> 49</span></a>
</span><span id="estimate_sigma-50"><a href="#estimate_sigma-50"><span class="linenos"> 50</span></a>        
</span><span id="estimate_sigma-51"><a href="#estimate_sigma-51"><span class="linenos"> 51</span></a>        <span class="c1"># Sample cells for scalability</span>
</span><span id="estimate_sigma-52"><a href="#estimate_sigma-52"><span class="linenos"> 52</span></a>        <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="estimate_sigma-53"><a href="#estimate_sigma-53"><span class="linenos"> 53</span></a>        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="mi">2000</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="estimate_sigma-54"><a href="#estimate_sigma-54"><span class="linenos"> 54</span></a>        <span class="n">distance_indices</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sample_idx</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> 
</span><span id="estimate_sigma-55"><a href="#estimate_sigma-55"><span class="linenos"> 55</span></a>                                                        <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="estimate_sigma-56"><a href="#estimate_sigma-56"><span class="linenos"> 56</span></a>
</span><span id="estimate_sigma-57"><a href="#estimate_sigma-57"><span class="linenos"> 57</span></a>        <span class="n">X_train</span> <span class="o">=</span> <span class="n">_process_data</span><span class="p">(</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">,</span> 
</span><span id="estimate_sigma-58"><a href="#estimate_sigma-58"><span class="linenos"> 58</span></a>                                 <span class="n">scale_data</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;scale_data&#39;</span><span class="p">],</span> 
</span><span id="estimate_sigma-59"><a href="#estimate_sigma-59"><span class="linenos"> 59</span></a>                                 <span class="n">return_dense</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="estimate_sigma-60"><a href="#estimate_sigma-60"><span class="linenos"> 60</span></a>        
</span><span id="estimate_sigma-61"><a href="#estimate_sigma-61"><span class="linenos"> 61</span></a>
</span><span id="estimate_sigma-62"><a href="#estimate_sigma-62"><span class="linenos"> 62</span></a>        <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;tfidf&#39;</span><span class="p">]:</span>
</span><span id="estimate_sigma-63"><a href="#estimate_sigma-63"><span class="linenos"> 63</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">_tfidf</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;normalize&#39;</span><span class="p">)</span>
</span><span id="estimate_sigma-64"><a href="#estimate_sigma-64"><span class="linenos"> 64</span></a>
</span><span id="estimate_sigma-65"><a href="#estimate_sigma-65"><span class="linenos"> 65</span></a>        <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;reduction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;svd&#39;</span><span class="p">:</span>
</span><span id="estimate_sigma-66"><a href="#estimate_sigma-66"><span class="linenos"> 66</span></a>
</span><span id="estimate_sigma-67"><a href="#estimate_sigma-67"><span class="linenos"> 67</span></a>            <span class="n">SVD_func</span> <span class="o">=</span> <span class="n">TruncatedSVD</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="estimate_sigma-68"><a href="#estimate_sigma-68"><span class="linenos"> 68</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">SVD_func</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_array</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">distance_indices</span><span class="p">,:]))[:,</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="estimate_sigma-69"><a href="#estimate_sigma-69"><span class="linenos"> 69</span></a>
</span><span id="estimate_sigma-70"><a href="#estimate_sigma-70"><span class="linenos"> 70</span></a>        <span class="k">elif</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;reduction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pca&#39;</span><span class="p">:</span>
</span><span id="estimate_sigma-71"><a href="#estimate_sigma-71"><span class="linenos"> 71</span></a>            <span class="n">PCA_func</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="estimate_sigma-72"><a href="#estimate_sigma-72"><span class="linenos"> 72</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">PCA_func</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">distance_indices</span><span class="p">,:]))</span>
</span><span id="estimate_sigma-73"><a href="#estimate_sigma-73"><span class="linenos"> 73</span></a>
</span><span id="estimate_sigma-74"><a href="#estimate_sigma-74"><span class="linenos"> 74</span></a>        <span class="k">elif</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;reduction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
</span><span id="estimate_sigma-75"><a href="#estimate_sigma-75"><span class="linenos"> 75</span></a>
</span><span id="estimate_sigma-76"><a href="#estimate_sigma-76"><span class="linenos"> 76</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">distance_indices</span><span class="p">]</span> <span class="o">@</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;seed_obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">distance_indices</span><span class="p">),</span> <span class="mi">50</span><span class="p">))</span>
</span><span id="estimate_sigma-77"><a href="#estimate_sigma-77"><span class="linenos"> 77</span></a>
</span><span id="estimate_sigma-78"><a href="#estimate_sigma-78"><span class="linenos"> 78</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="estimate_sigma-79"><a href="#estimate_sigma-79"><span class="linenos"> 79</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">distance_indices</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="estimate_sigma-80"><a href="#estimate_sigma-80"><span class="linenos"> 80</span></a>
</span><span id="estimate_sigma-81"><a href="#estimate_sigma-81"><span class="linenos"> 81</span></a>        <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">X_train</span><span class="p">):</span>
</span><span id="estimate_sigma-82"><a href="#estimate_sigma-82"><span class="linenos"> 82</span></a>            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</span><span id="estimate_sigma-83"><a href="#estimate_sigma-83"><span class="linenos"> 83</span></a>
</span><span id="estimate_sigma-84"><a href="#estimate_sigma-84"><span class="linenos"> 84</span></a>        <span class="c1"># Calculate Distance Matrix with specified metric</span>
</span><span id="estimate_sigma-85"><a href="#estimate_sigma-85"><span class="linenos"> 85</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> 
</span><span id="estimate_sigma-86"><a href="#estimate_sigma-86"><span class="linenos"> 86</span></a>                                             <span class="n">X_train</span><span class="p">,</span> 
</span><span id="estimate_sigma-87"><a href="#estimate_sigma-87"><span class="linenos"> 87</span></a>                                             <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;distance_metric&#39;</span><span class="p">])</span>
</span><span id="estimate_sigma-88"><a href="#estimate_sigma-88"><span class="linenos"> 88</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
</span><span id="estimate_sigma-89"><a href="#estimate_sigma-89"><span class="linenos"> 89</span></a>
</span><span id="estimate_sigma-90"><a href="#estimate_sigma-90"><span class="linenos"> 90</span></a>        <span class="c1"># sigma = 0 is numerically unusable in later steps</span>
</span><span id="estimate_sigma-91"><a href="#estimate_sigma-91"><span class="linenos"> 91</span></a>        <span class="c1"># Using such a small sigma will result in wide distribution, and </span>
</span><span id="estimate_sigma-92"><a href="#estimate_sigma-92"><span class="linenos"> 92</span></a>        <span class="c1"># typically a non-predictive Z</span>
</span><span id="estimate_sigma-93"><a href="#estimate_sigma-93"><span class="linenos"> 93</span></a>        <span class="k">if</span> <span class="n">sigma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="estimate_sigma-94"><a href="#estimate_sigma-94"><span class="linenos"> 94</span></a>            <span class="n">sigma</span> <span class="o">+=</span> <span class="mf">1e-5</span>
</span><span id="estimate_sigma-95"><a href="#estimate_sigma-95"><span class="linenos"> 95</span></a>
</span><span id="estimate_sigma-96"><a href="#estimate_sigma-96"><span class="linenos"> 96</span></a>        <span class="k">if</span> <span class="n">n_features</span> <span class="o">&lt;</span> <span class="n">num_group_features</span><span class="p">:</span>
</span><span id="estimate_sigma-97"><a href="#estimate_sigma-97"><span class="linenos"> 97</span></a>            <span class="c1"># Heuristic we calculated to account for fewer features used in </span>
</span><span id="estimate_sigma-98"><a href="#estimate_sigma-98"><span class="linenos"> 98</span></a>            <span class="c1"># distance calculation</span>
</span><span id="estimate_sigma-99"><a href="#estimate_sigma-99"><span class="linenos"> 99</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">num_group_features</span> <span class="o">/</span> <span class="n">n_features</span> 
</span><span id="estimate_sigma-100"><a href="#estimate_sigma-100"><span class="linenos">100</span></a>
</span><span id="estimate_sigma-101"><a href="#estimate_sigma-101"><span class="linenos">101</span></a>        <span class="n">sigma_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
</span><span id="estimate_sigma-102"><a href="#estimate_sigma-102"><span class="linenos">102</span></a>    
</span><span id="estimate_sigma-103"><a href="#estimate_sigma-103"><span class="linenos">103</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_list</span><span class="p">)</span>
</span><span id="estimate_sigma-104"><a href="#estimate_sigma-104"><span class="linenos">104</span></a>        
</span><span id="estimate_sigma-105"><a href="#estimate_sigma-105"><span class="linenos">105</span></a>    <span class="k">return</span> <span class="n">adata</span>
</span></pre></div>


            <div class="docstring"><p>Calculate kernel widths to inform distribution for projection of 
Fourier Features. Calculates one sigma per group of features.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>adata</strong> : <em>AnnData</em> </p>

<blockquote>
  <p>Created by <code><a href="#create_adata">create_adata</a></code>.</p>
</blockquote>

<p><strong>n_features</strong> : <em>int</em>  </p>

<blockquote>
  <p>Number of random features to include when estimating sigma. 
      Will be scaled for the whole pathway set according to a 
      heuristic. Used for scalability.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>adata</strong> : <em>AnnData</em></p>

<blockquote>
  <p>Key added <code>adata.uns['sigma']</code>.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/estimate_sigma.html">scmkl.estimate_sigma</a></span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
<span class="go">array([10.4640895 , 10.82011454,  6.16769438,  9.86156855, ...])</span>
</code></pre>
</div>
</div>


                </section>
                <section id="get_atac_groupings">
                            <input id="get_atac_groupings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_atac_groupings</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">gene_anno</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">gene_sets</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">feature_names</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">set</span>,</span><span class="param">	<span class="n">len_up</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span>,</span><span class="param">	<span class="n">len_down</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="get_atac_groupings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_atac_groupings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_atac_groupings-262"><a href="#get_atac_groupings-262"><span class="linenos">262</span></a><span class="k">def</span> <span class="nf">get_atac_groupings</span><span class="p">(</span><span class="n">gene_anno</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gene_sets</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
</span><span id="get_atac_groupings-263"><a href="#get_atac_groupings-263"><span class="linenos">263</span></a>                       <span class="n">feature_names</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">set</span><span class="p">,</span>
</span><span id="get_atac_groupings-264"><a href="#get_atac_groupings-264"><span class="linenos">264</span></a>                       <span class="n">len_up</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">len_down</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="get_atac_groupings-265"><a href="#get_atac_groupings-265"><span class="linenos">265</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="get_atac_groupings-266"><a href="#get_atac_groupings-266"><span class="linenos">266</span></a><span class="sd">    Creates a peak set where keys are gene set names from `gene_sets` </span>
</span><span id="get_atac_groupings-267"><a href="#get_atac_groupings-267"><span class="linenos">267</span></a><span class="sd">    and values are arrays of features pulled from `feature_names`. </span>
</span><span id="get_atac_groupings-268"><a href="#get_atac_groupings-268"><span class="linenos">268</span></a><span class="sd">    Features are added to each peak set given overlap between regions </span>
</span><span id="get_atac_groupings-269"><a href="#get_atac_groupings-269"><span class="linenos">269</span></a><span class="sd">    in single-cell data matrix and inferred gene promoter regions in </span>
</span><span id="get_atac_groupings-270"><a href="#get_atac_groupings-270"><span class="linenos">270</span></a><span class="sd">    `gene_anno`.</span>
</span><span id="get_atac_groupings-271"><a href="#get_atac_groupings-271"><span class="linenos">271</span></a>
</span><span id="get_atac_groupings-272"><a href="#get_atac_groupings-272"><span class="linenos">272</span></a><span class="sd">    Parameters</span>
</span><span id="get_atac_groupings-273"><a href="#get_atac_groupings-273"><span class="linenos">273</span></a><span class="sd">    ----------</span>
</span><span id="get_atac_groupings-274"><a href="#get_atac_groupings-274"><span class="linenos">274</span></a><span class="sd">    **gene_anno** : *pd.DataFrame*</span>
</span><span id="get_atac_groupings-275"><a href="#get_atac_groupings-275"><span class="linenos">275</span></a><span class="sd">        &gt; Gene annotations in GTF format as a pd.DataFrame with columns</span>
</span><span id="get_atac_groupings-276"><a href="#get_atac_groupings-276"><span class="linenos">276</span></a><span class="sd">        [&#39;chr&#39;, &#39;start&#39;, &#39;end&#39;, &#39;strand&#39;, &#39;gene_name&#39;].</span>
</span><span id="get_atac_groupings-277"><a href="#get_atac_groupings-277"><span class="linenos">277</span></a>
</span><span id="get_atac_groupings-278"><a href="#get_atac_groupings-278"><span class="linenos">278</span></a><span class="sd">    **gene_sets** : *dict*</span>
</span><span id="get_atac_groupings-279"><a href="#get_atac_groupings-279"><span class="linenos">279</span></a><span class="sd">        &gt; Gene set names as keys and an iterable object of gene names</span>
</span><span id="get_atac_groupings-280"><a href="#get_atac_groupings-280"><span class="linenos">280</span></a><span class="sd">        as values.</span>
</span><span id="get_atac_groupings-281"><a href="#get_atac_groupings-281"><span class="linenos">281</span></a>
</span><span id="get_atac_groupings-282"><a href="#get_atac_groupings-282"><span class="linenos">282</span></a><span class="sd">    **feature_names** : *np.ndarray* | *pd.Series* | *list* | *set*</span>
</span><span id="get_atac_groupings-283"><a href="#get_atac_groupings-283"><span class="linenos">283</span></a><span class="sd">        &gt; Feature names corresponding to a single_cell ATAC data </span>
</span><span id="get_atac_groupings-284"><a href="#get_atac_groupings-284"><span class="linenos">284</span></a><span class="sd">        matrix.</span>
</span><span id="get_atac_groupings-285"><a href="#get_atac_groupings-285"><span class="linenos">285</span></a>
</span><span id="get_atac_groupings-286"><a href="#get_atac_groupings-286"><span class="linenos">286</span></a><span class="sd">    Returns</span>
</span><span id="get_atac_groupings-287"><a href="#get_atac_groupings-287"><span class="linenos">287</span></a><span class="sd">    -------</span>
</span><span id="get_atac_groupings-288"><a href="#get_atac_groupings-288"><span class="linenos">288</span></a><span class="sd">    **atac_grouping** : *dict*</span>
</span><span id="get_atac_groupings-289"><a href="#get_atac_groupings-289"><span class="linenos">289</span></a><span class="sd">        &gt; Keys are the names from `gene_sets` and values</span>
</span><span id="get_atac_groupings-290"><a href="#get_atac_groupings-290"><span class="linenos">290</span></a><span class="sd">        are a list of regions from `feature_names` that overlap with </span>
</span><span id="get_atac_groupings-291"><a href="#get_atac_groupings-291"><span class="linenos">291</span></a><span class="sd">        promotor regions respective to genes in `gene_sets` (i.e., if </span>
</span><span id="get_atac_groupings-292"><a href="#get_atac_groupings-292"><span class="linenos">292</span></a><span class="sd">        ATAC feature in `feature_names` overlaps with promotor region </span>
</span><span id="get_atac_groupings-293"><a href="#get_atac_groupings-293"><span class="linenos">293</span></a><span class="sd">        from a gene in a gene set from `gene_sets`, that region will be</span>
</span><span id="get_atac_groupings-294"><a href="#get_atac_groupings-294"><span class="linenos">294</span></a><span class="sd">        added to the new dictionary under the respective gene set </span>
</span><span id="get_atac_groupings-295"><a href="#get_atac_groupings-295"><span class="linenos">295</span></a><span class="sd">        name).</span>
</span><span id="get_atac_groupings-296"><a href="#get_atac_groupings-296"><span class="linenos">296</span></a>
</span><span id="get_atac_groupings-297"><a href="#get_atac_groupings-297"><span class="linenos">297</span></a><span class="sd">    Examples</span>
</span><span id="get_atac_groupings-298"><a href="#get_atac_groupings-298"><span class="linenos">298</span></a><span class="sd">    --------</span>
</span><span id="get_atac_groupings-299"><a href="#get_atac_groupings-299"><span class="linenos">299</span></a><span class="sd">    &gt;&gt;&gt; # Reading in a gene set and the peak names from scATAC dataset</span>
</span><span id="get_atac_groupings-300"><a href="#get_atac_groupings-300"><span class="linenos">300</span></a><span class="sd">    &gt;&gt;&gt; gene_sets = np.load(&quot;data/RNA_hallmark_groupings.pkl&quot;, </span>
</span><span id="get_atac_groupings-301"><a href="#get_atac_groupings-301"><span class="linenos">301</span></a><span class="sd">    ...                     allow_pickle = True)</span>
</span><span id="get_atac_groupings-302"><a href="#get_atac_groupings-302"><span class="linenos">302</span></a><span class="sd">    &gt;&gt;&gt; peaks = np.load(&quot;data/MCF7_ATAC_feature_names.npy&quot;, </span>
</span><span id="get_atac_groupings-303"><a href="#get_atac_groupings-303"><span class="linenos">303</span></a><span class="sd">    ...                 allow_pickle = True)</span>
</span><span id="get_atac_groupings-304"><a href="#get_atac_groupings-304"><span class="linenos">304</span></a><span class="sd">    &gt;&gt;&gt; </span>
</span><span id="get_atac_groupings-305"><a href="#get_atac_groupings-305"><span class="linenos">305</span></a><span class="sd">    &gt;&gt;&gt; # Reading in GTF file</span>
</span><span id="get_atac_groupings-306"><a href="#get_atac_groupings-306"><span class="linenos">306</span></a><span class="sd">    &gt;&gt;&gt; gtf_path = &quot;data/hg38_subset_protein_coding.annotation.gtf&quot;</span>
</span><span id="get_atac_groupings-307"><a href="#get_atac_groupings-307"><span class="linenos">307</span></a><span class="sd">    &gt;&gt;&gt; gtf = pd.read_csv(gtf_path, sep = &quot;\t&quot;, header = None, </span>
</span><span id="get_atac_groupings-308"><a href="#get_atac_groupings-308"><span class="linenos">308</span></a><span class="sd">    ...                   skip_blank_lines = True, comment = &quot;#&quot;)</span>
</span><span id="get_atac_groupings-309"><a href="#get_atac_groupings-309"><span class="linenos">309</span></a><span class="sd">    &gt;&gt;&gt; </span>
</span><span id="get_atac_groupings-310"><a href="#get_atac_groupings-310"><span class="linenos">310</span></a><span class="sd">    &gt;&gt;&gt; # Naming columns</span>
</span><span id="get_atac_groupings-311"><a href="#get_atac_groupings-311"><span class="linenos">311</span></a><span class="sd">    &gt;&gt;&gt; gtf.columns = [&#39;chr&#39;, &#39;source&#39;, &#39;feature&#39;, &#39;start&#39;, &#39;end&#39;, </span>
</span><span id="get_atac_groupings-312"><a href="#get_atac_groupings-312"><span class="linenos">312</span></a><span class="sd">    ...                &#39;score&#39;, &#39;strand&#39;, &#39;frame&#39;, &#39;attribute&#39;]</span>
</span><span id="get_atac_groupings-313"><a href="#get_atac_groupings-313"><span class="linenos">313</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="get_atac_groupings-314"><a href="#get_atac_groupings-314"><span class="linenos">314</span></a><span class="sd">    &gt;&gt;&gt; # Subsetting to only protein coding genes</span>
</span><span id="get_atac_groupings-315"><a href="#get_atac_groupings-315"><span class="linenos">315</span></a><span class="sd">    &gt;&gt;&gt; prot_rows = gtf[&#39;attribute&#39;].str.contains(&#39;protein_coding&#39;)</span>
</span><span id="get_atac_groupings-316"><a href="#get_atac_groupings-316"><span class="linenos">316</span></a><span class="sd">    &gt;&gt;&gt; gtf = gtf[prot_rows]</span>
</span><span id="get_atac_groupings-317"><a href="#get_atac_groupings-317"><span class="linenos">317</span></a><span class="sd">    &gt;&gt;&gt; gtf = gtf[gtf[&#39;feature&#39;] == &#39;gene&#39;]</span>
</span><span id="get_atac_groupings-318"><a href="#get_atac_groupings-318"><span class="linenos">318</span></a><span class="sd">    &gt;&gt;&gt; </span>
</span><span id="get_atac_groupings-319"><a href="#get_atac_groupings-319"><span class="linenos">319</span></a><span class="sd">    &gt;&gt;&gt; # Capturing gene name from attributes column</span>
</span><span id="get_atac_groupings-320"><a href="#get_atac_groupings-320"><span class="linenos">320</span></a><span class="sd">    &gt;&gt;&gt; gtf[&#39;gene_name&#39;] = [re.findall(r&#39;(?&lt;=gene_name &quot;)[A-z0-9]+&#39;, </span>
</span><span id="get_atac_groupings-321"><a href="#get_atac_groupings-321"><span class="linenos">321</span></a><span class="sd">    ...                                attr)[0] </span>
</span><span id="get_atac_groupings-322"><a href="#get_atac_groupings-322"><span class="linenos">322</span></a><span class="sd">    ...                     for attr in gtf[&#39;attribute&#39;]]</span>
</span><span id="get_atac_groupings-323"><a href="#get_atac_groupings-323"><span class="linenos">323</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="get_atac_groupings-324"><a href="#get_atac_groupings-324"><span class="linenos">324</span></a><span class="sd">    &gt;&gt;&gt; atac_grouping = scmkl.get_atac_groupings(gene_anno = gtf,</span>
</span><span id="get_atac_groupings-325"><a href="#get_atac_groupings-325"><span class="linenos">325</span></a><span class="sd">    ...                                         gene_sets = gene_sets,</span>
</span><span id="get_atac_groupings-326"><a href="#get_atac_groupings-326"><span class="linenos">326</span></a><span class="sd">    ...                                         feature_names = peaks)</span>
</span><span id="get_atac_groupings-327"><a href="#get_atac_groupings-327"><span class="linenos">327</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="get_atac_groupings-328"><a href="#get_atac_groupings-328"><span class="linenos">328</span></a><span class="sd">    &gt;&gt;&gt; atac_grouping.keys()</span>
</span><span id="get_atac_groupings-329"><a href="#get_atac_groupings-329"><span class="linenos">329</span></a><span class="sd">    dict_keys([&#39;HALLMARK_TNFA_SIGNALING_VIA_NFKB&#39;, ...])</span>
</span><span id="get_atac_groupings-330"><a href="#get_atac_groupings-330"><span class="linenos">330</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="get_atac_groupings-331"><a href="#get_atac_groupings-331"><span class="linenos">331</span></a>    <span class="c1"># Getting a unique set of gene names from gene_sets</span>
</span><span id="get_atac_groupings-332"><a href="#get_atac_groupings-332"><span class="linenos">332</span></a>    <span class="n">all_genes</span> <span class="o">=</span> <span class="p">{</span><span class="n">gene</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">gene_sets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="get_atac_groupings-333"><a href="#get_atac_groupings-333"><span class="linenos">333</span></a>                 <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">gene_sets</span><span class="p">[</span><span class="n">group</span><span class="p">]}</span>
</span><span id="get_atac_groupings-334"><a href="#get_atac_groupings-334"><span class="linenos">334</span></a>    
</span><span id="get_atac_groupings-335"><a href="#get_atac_groupings-335"><span class="linenos">335</span></a>    <span class="c1"># Filtering out NaN values</span>
</span><span id="get_atac_groupings-336"><a href="#get_atac_groupings-336"><span class="linenos">336</span></a>    <span class="n">all_genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">gene</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">all_genes</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">]</span>
</span><span id="get_atac_groupings-337"><a href="#get_atac_groupings-337"><span class="linenos">337</span></a>
</span><span id="get_atac_groupings-338"><a href="#get_atac_groupings-338"><span class="linenos">338</span></a>    <span class="c1"># Filtering out annotations for genes not present in gene_sets</span>
</span><span id="get_atac_groupings-339"><a href="#get_atac_groupings-339"><span class="linenos">339</span></a>    <span class="n">gene_anno</span> <span class="o">=</span> <span class="n">gene_anno</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gene_anno</span><span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">],</span> <span class="n">all_genes</span><span class="p">)]</span>
</span><span id="get_atac_groupings-340"><a href="#get_atac_groupings-340"><span class="linenos">340</span></a>
</span><span id="get_atac_groupings-341"><a href="#get_atac_groupings-341"><span class="linenos">341</span></a>    <span class="c1"># Adjusting start and end columns to represent promotor regions</span>
</span><span id="get_atac_groupings-342"><a href="#get_atac_groupings-342"><span class="linenos">342</span></a>    <span class="n">gene_anno</span> <span class="o">=</span> <span class="n">_adjust_regions</span><span class="p">(</span><span class="n">gene_anno</span> <span class="o">=</span> <span class="n">gene_anno</span><span class="p">,</span> 
</span><span id="get_atac_groupings-343"><a href="#get_atac_groupings-343"><span class="linenos">343</span></a>                                <span class="n">len_up</span> <span class="o">=</span> <span class="n">len_up</span><span class="p">,</span> <span class="n">len_down</span> <span class="o">=</span> <span class="n">len_down</span><span class="p">)</span>
</span><span id="get_atac_groupings-344"><a href="#get_atac_groupings-344"><span class="linenos">344</span></a>
</span><span id="get_atac_groupings-345"><a href="#get_atac_groupings-345"><span class="linenos">345</span></a>    <span class="c1"># Creating a dictionary from assay features where [chr] : (start, end)</span>
</span><span id="get_atac_groupings-346"><a href="#get_atac_groupings-346"><span class="linenos">346</span></a>    <span class="n">feature_dict</span> <span class="o">=</span> <span class="n">_create_feature_dict</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span>
</span><span id="get_atac_groupings-347"><a href="#get_atac_groupings-347"><span class="linenos">347</span></a>
</span><span id="get_atac_groupings-348"><a href="#get_atac_groupings-348"><span class="linenos">348</span></a>    <span class="c1"># Creating data structures from gene_anno for comparing regions</span>
</span><span id="get_atac_groupings-349"><a href="#get_atac_groupings-349"><span class="linenos">349</span></a>    <span class="n">peak_gene_dict</span><span class="p">,</span> <span class="n">ga_regions</span> <span class="o">=</span> <span class="n">_create_region_dicts</span><span class="p">(</span><span class="n">gene_anno</span><span class="p">)</span>
</span><span id="get_atac_groupings-350"><a href="#get_atac_groupings-350"><span class="linenos">350</span></a>
</span><span id="get_atac_groupings-351"><a href="#get_atac_groupings-351"><span class="linenos">351</span></a>    <span class="c1"># Capturing the separator type used in assay</span>
</span><span id="get_atac_groupings-352"><a href="#get_atac_groupings-352"><span class="linenos">352</span></a>    <span class="n">chr_sep</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span> <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span>
</span><span id="get_atac_groupings-353"><a href="#get_atac_groupings-353"><span class="linenos">353</span></a>
</span><span id="get_atac_groupings-354"><a href="#get_atac_groupings-354"><span class="linenos">354</span></a>    <span class="n">atac_groupings</span> <span class="o">=</span> <span class="n">_compare_regions</span><span class="p">(</span><span class="n">feature_dict</span> <span class="o">=</span> <span class="n">feature_dict</span><span class="p">,</span>
</span><span id="get_atac_groupings-355"><a href="#get_atac_groupings-355"><span class="linenos">355</span></a>                                     <span class="n">ga_regions</span> <span class="o">=</span> <span class="n">ga_regions</span><span class="p">,</span>
</span><span id="get_atac_groupings-356"><a href="#get_atac_groupings-356"><span class="linenos">356</span></a>                                     <span class="n">peak_gene_dict</span> <span class="o">=</span> <span class="n">peak_gene_dict</span><span class="p">,</span>
</span><span id="get_atac_groupings-357"><a href="#get_atac_groupings-357"><span class="linenos">357</span></a>                                     <span class="n">gene_sets</span> <span class="o">=</span> <span class="n">gene_sets</span><span class="p">,</span>
</span><span id="get_atac_groupings-358"><a href="#get_atac_groupings-358"><span class="linenos">358</span></a>                                     <span class="n">chr_sep</span> <span class="o">=</span> <span class="n">chr_sep</span><span class="p">)</span>
</span><span id="get_atac_groupings-359"><a href="#get_atac_groupings-359"><span class="linenos">359</span></a>    
</span><span id="get_atac_groupings-360"><a href="#get_atac_groupings-360"><span class="linenos">360</span></a>    <span class="k">return</span> <span class="n">atac_groupings</span>
</span></pre></div>


            <div class="docstring"><p>Creates a peak set where keys are gene set names from <code>gene_sets</code> 
and values are arrays of features pulled from <code>feature_names</code>. 
Features are added to each peak set given overlap between regions 
in single-cell data matrix and inferred gene promoter regions in 
<code>gene_anno</code>.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>gene_anno</strong> : <em>pd.DataFrame</em></p>

<blockquote>
  <p>Gene annotations in GTF format as a pd.DataFrame with columns
      ['chr', 'start', 'end', 'strand', 'gene_name'].</p>
</blockquote>

<p><strong>gene_sets</strong> : <em>dict</em></p>

<blockquote>
  <p>Gene set names as keys and an iterable object of gene names
      as values.</p>
</blockquote>

<p><strong>feature_names</strong> : <em>np.ndarray</em> | <em>pd.Series</em> | <em>list</em> | <em>set</em></p>

<blockquote>
  <p>Feature names corresponding to a single_cell ATAC data 
      matrix.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>atac_grouping</strong> : <em>dict</em></p>

<blockquote>
  <p>Keys are the names from <code>gene_sets</code> and values
      are a list of regions from <code>feature_names</code> that overlap with 
      promotor regions respective to genes in <code>gene_sets</code> (i.e., if 
      ATAC feature in <code>feature_names</code> overlaps with promotor region 
      from a gene in a gene set from <code>gene_sets</code>, that region will be
      added to the new dictionary under the respective gene set 
      name).</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Reading in a gene set and the peak names from scATAC dataset</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gene_sets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;data/RNA_hallmark_groupings.pkl&quot;</span><span class="p">,</span> 
<span class="gp">... </span>                    <span class="n">allow_pickle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;data/MCF7_ATAC_feature_names.npy&quot;</span><span class="p">,</span> 
<span class="gp">... </span>                <span class="n">allow_pickle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Reading in GTF file</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gtf_path</span> <span class="o">=</span> <span class="s2">&quot;data/hg38_subset_protein_coding.annotation.gtf&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gtf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">gtf_path</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;     &quot;</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="gp">... </span>                  <span class="n">skip_blank_lines</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Naming columns</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gtf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> 
<span class="gp">... </span>               <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;strand&#39;</span><span class="p">,</span> <span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="s1">&#39;attribute&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Subsetting to only protein coding genes</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">prot_rows</span> <span class="o">=</span> <span class="n">gtf</span><span class="p">[</span><span class="s1">&#39;attribute&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;protein_coding&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gtf</span> <span class="o">=</span> <span class="n">gtf</span><span class="p">[</span><span class="n">prot_rows</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gtf</span> <span class="o">=</span> <span class="n">gtf</span><span class="p">[</span><span class="n">gtf</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gene&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Capturing gene name from attributes column</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gtf</span><span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=gene_name &quot;)[A-z0-9]+&#39;</span><span class="p">,</span> 
<span class="gp">... </span>                               <span class="n">attr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
<span class="gp">... </span>                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">gtf</span><span class="p">[</span><span class="s1">&#39;attribute&#39;</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">atac_grouping</span> <span class="o">=</span> <span class="n"><a href="scmkl/get_atac_groupings.html">scmkl.get_atac_groupings</a></span><span class="p">(</span><span class="n">gene_anno</span> <span class="o">=</span> <span class="n">gtf</span><span class="p">,</span>
<span class="gp">... </span>                                        <span class="n">gene_sets</span> <span class="o">=</span> <span class="n">gene_sets</span><span class="p">,</span>
<span class="gp">... </span>                                        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">atac_grouping</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="go">dict_keys([&#39;HALLMARK_TNFA_SIGNALING_VIA_NFKB&#39;, ...])</span>
</code></pre>
</div>
</div>


                </section>
                <section id="multimodal_processing">
                            <input id="multimodal_processing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">multimodal_processing</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">adatas</span><span class="p">:</span> <span class="nb">list</span>, </span><span class="param"><span class="n">names</span><span class="p">:</span> <span class="nb">list</span>, </span><span class="param"><span class="n">tfidf</span><span class="p">:</span> <span class="nb">list</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="multimodal_processing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#multimodal_processing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="multimodal_processing-97"><a href="#multimodal_processing-97"><span class="linenos"> 97</span></a><span class="k">def</span> <span class="nf">multimodal_processing</span><span class="p">(</span><span class="n">adatas</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">names</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">tfidf</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="multimodal_processing-98"><a href="#multimodal_processing-98"><span class="linenos"> 98</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="multimodal_processing-99"><a href="#multimodal_processing-99"><span class="linenos"> 99</span></a><span class="sd">    Combines and processes a list of adata objects.</span>
</span><span id="multimodal_processing-100"><a href="#multimodal_processing-100"><span class="linenos">100</span></a>
</span><span id="multimodal_processing-101"><a href="#multimodal_processing-101"><span class="linenos">101</span></a><span class="sd">    Parameters</span>
</span><span id="multimodal_processing-102"><a href="#multimodal_processing-102"><span class="linenos">102</span></a><span class="sd">    ----------</span>
</span><span id="multimodal_processing-103"><a href="#multimodal_processing-103"><span class="linenos">103</span></a><span class="sd">    **adatas** : *list[AnnData]* </span>
</span><span id="multimodal_processing-104"><a href="#multimodal_processing-104"><span class="linenos">104</span></a><span class="sd">        &gt; List of AnnData objects where each object is a different </span>
</span><span id="multimodal_processing-105"><a href="#multimodal_processing-105"><span class="linenos">105</span></a><span class="sd">        modality for the same cells.</span>
</span><span id="multimodal_processing-106"><a href="#multimodal_processing-106"><span class="linenos">106</span></a>
</span><span id="multimodal_processing-107"><a href="#multimodal_processing-107"><span class="linenos">107</span></a><span class="sd">    **names** : *list[str]*</span>
</span><span id="multimodal_processing-108"><a href="#multimodal_processing-108"><span class="linenos">108</span></a><span class="sd">        &gt; List of string names for each modality repective to each </span>
</span><span id="multimodal_processing-109"><a href="#multimodal_processing-109"><span class="linenos">109</span></a><span class="sd">        object in `adatas`.</span>
</span><span id="multimodal_processing-110"><a href="#multimodal_processing-110"><span class="linenos">110</span></a><span class="sd">    </span>
</span><span id="multimodal_processing-111"><a href="#multimodal_processing-111"><span class="linenos">111</span></a><span class="sd">    **tfidf** : *bool* </span>
</span><span id="multimodal_processing-112"><a href="#multimodal_processing-112"><span class="linenos">112</span></a><span class="sd">        &gt; List where if element i is `True`, adata[i] will be TFIDF </span>
</span><span id="multimodal_processing-113"><a href="#multimodal_processing-113"><span class="linenos">113</span></a><span class="sd">        normalized.</span>
</span><span id="multimodal_processing-114"><a href="#multimodal_processing-114"><span class="linenos">114</span></a>
</span><span id="multimodal_processing-115"><a href="#multimodal_processing-115"><span class="linenos">115</span></a><span class="sd">    Returns</span>
</span><span id="multimodal_processing-116"><a href="#multimodal_processing-116"><span class="linenos">116</span></a><span class="sd">    -------</span>
</span><span id="multimodal_processing-117"><a href="#multimodal_processing-117"><span class="linenos">117</span></a><span class="sd">    **adata** : *AnnData* </span>
</span><span id="multimodal_processing-118"><a href="#multimodal_processing-118"><span class="linenos">118</span></a><span class="sd">        &gt; Concatenated from objects from `adatas` with Z matrices </span>
</span><span id="multimodal_processing-119"><a href="#multimodal_processing-119"><span class="linenos">119</span></a><span class="sd">        calculated.</span>
</span><span id="multimodal_processing-120"><a href="#multimodal_processing-120"><span class="linenos">120</span></a>
</span><span id="multimodal_processing-121"><a href="#multimodal_processing-121"><span class="linenos">121</span></a><span class="sd">    Examples</span>
</span><span id="multimodal_processing-122"><a href="#multimodal_processing-122"><span class="linenos">122</span></a><span class="sd">    --------</span>
</span><span id="multimodal_processing-123"><a href="#multimodal_processing-123"><span class="linenos">123</span></a><span class="sd">    &gt;&gt;&gt; rna_adata = scmkl.create_adata(X = mcf7_rna_mat, </span>
</span><span id="multimodal_processing-124"><a href="#multimodal_processing-124"><span class="linenos">124</span></a><span class="sd">    ...                                feature_names = gene_names, </span>
</span><span id="multimodal_processing-125"><a href="#multimodal_processing-125"><span class="linenos">125</span></a><span class="sd">    ...                                scale_data = True, </span>
</span><span id="multimodal_processing-126"><a href="#multimodal_processing-126"><span class="linenos">126</span></a><span class="sd">    ...                                cell_labels = cell_labels, </span>
</span><span id="multimodal_processing-127"><a href="#multimodal_processing-127"><span class="linenos">127</span></a><span class="sd">    ...                                 group_dict = rna_grouping)</span>
</span><span id="multimodal_processing-128"><a href="#multimodal_processing-128"><span class="linenos">128</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="multimodal_processing-129"><a href="#multimodal_processing-129"><span class="linenos">129</span></a><span class="sd">    &gt;&gt;&gt; atac_adata = scmkl.create_adata(X = mcf7_atac_mat, </span>
</span><span id="multimodal_processing-130"><a href="#multimodal_processing-130"><span class="linenos">130</span></a><span class="sd">    ...                                 feature_names = peak_names, </span>
</span><span id="multimodal_processing-131"><a href="#multimodal_processing-131"><span class="linenos">131</span></a><span class="sd">    ...                                 scale_data = False, </span>
</span><span id="multimodal_processing-132"><a href="#multimodal_processing-132"><span class="linenos">132</span></a><span class="sd">    ...                                 cell_labels = cell_labels, </span>
</span><span id="multimodal_processing-133"><a href="#multimodal_processing-133"><span class="linenos">133</span></a><span class="sd">    ...                                 group_dict = atac_grouping)</span>
</span><span id="multimodal_processing-134"><a href="#multimodal_processing-134"><span class="linenos">134</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="multimodal_processing-135"><a href="#multimodal_processing-135"><span class="linenos">135</span></a><span class="sd">    &gt;&gt;&gt; adatas = [rna_adata, atac_adata]</span>
</span><span id="multimodal_processing-136"><a href="#multimodal_processing-136"><span class="linenos">136</span></a><span class="sd">    &gt;&gt;&gt; mod_names = [&#39;rna&#39;, &#39;atac&#39;]</span>
</span><span id="multimodal_processing-137"><a href="#multimodal_processing-137"><span class="linenos">137</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.multimodal_processing(adatas = adatas, </span>
</span><span id="multimodal_processing-138"><a href="#multimodal_processing-138"><span class="linenos">138</span></a><span class="sd">    ...                                     names = mod_names,</span>
</span><span id="multimodal_processing-139"><a href="#multimodal_processing-139"><span class="linenos">139</span></a><span class="sd">    ...                                     tfidf = [False, True])</span>
</span><span id="multimodal_processing-140"><a href="#multimodal_processing-140"><span class="linenos">140</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="multimodal_processing-141"><a href="#multimodal_processing-141"><span class="linenos">141</span></a><span class="sd">    &gt;&gt;&gt; adata</span>
</span><span id="multimodal_processing-142"><a href="#multimodal_processing-142"><span class="linenos">142</span></a><span class="sd">    AnnData object with n_obs × n_vars = 1000 × 12676</span>
</span><span id="multimodal_processing-143"><a href="#multimodal_processing-143"><span class="linenos">143</span></a><span class="sd">    obs: &#39;labels&#39;</span>
</span><span id="multimodal_processing-144"><a href="#multimodal_processing-144"><span class="linenos">144</span></a><span class="sd">    var: &#39;labels&#39;</span>
</span><span id="multimodal_processing-145"><a href="#multimodal_processing-145"><span class="linenos">145</span></a><span class="sd">    uns: &#39;D&#39;, &#39;kernel_type&#39;, &#39;distance_metric&#39;, &#39;train_indices&#39;,  </span>
</span><span id="multimodal_processing-146"><a href="#multimodal_processing-146"><span class="linenos">146</span></a><span class="sd">    &#39;test_indices&#39;, &#39;Z_train&#39;, &#39;Z_test&#39;, &#39;group_dict&#39;, &#39;seed_obj&#39;</span>
</span><span id="multimodal_processing-147"><a href="#multimodal_processing-147"><span class="linenos">147</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="multimodal_processing-148"><a href="#multimodal_processing-148"><span class="linenos">148</span></a>    <span class="kn">import</span> <span class="nn">warnings</span> 
</span><span id="multimodal_processing-149"><a href="#multimodal_processing-149"><span class="linenos">149</span></a>    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span><span id="multimodal_processing-150"><a href="#multimodal_processing-150"><span class="linenos">150</span></a>
</span><span id="multimodal_processing-151"><a href="#multimodal_processing-151"><span class="linenos">151</span></a>    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">adata</span> <span class="ow">in</span> <span class="n">adatas</span><span class="p">]),</span> <span class="p">(</span><span class="s2">&quot;Different number of &quot;</span>
</span><span id="multimodal_processing-152"><a href="#multimodal_processing-152"><span class="linenos">152</span></a>                                                       <span class="s2">&quot;cells present in &quot;</span>
</span><span id="multimodal_processing-153"><a href="#multimodal_processing-153"><span class="linenos">153</span></a>                                                       <span class="s2">&quot;each object&quot;</span><span class="p">)</span>
</span><span id="multimodal_processing-154"><a href="#multimodal_processing-154"><span class="linenos">154</span></a>    
</span><span id="multimodal_processing-155"><a href="#multimodal_processing-155"><span class="linenos">155</span></a>    <span class="c1"># True if all train indices match</span>
</span><span id="multimodal_processing-156"><a href="#multimodal_processing-156"><span class="linenos">156</span></a>    <span class="n">same_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">adatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">],</span> 
</span><span id="multimodal_processing-157"><a href="#multimodal_processing-157"><span class="linenos">157</span></a>                                        <span class="n">adatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">])</span> 
</span><span id="multimodal_processing-158"><a href="#multimodal_processing-158"><span class="linenos">158</span></a>                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">))])</span>
</span><span id="multimodal_processing-159"><a href="#multimodal_processing-159"><span class="linenos">159</span></a>
</span><span id="multimodal_processing-160"><a href="#multimodal_processing-160"><span class="linenos">160</span></a>    <span class="c1"># True if all test indices match</span>
</span><span id="multimodal_processing-161"><a href="#multimodal_processing-161"><span class="linenos">161</span></a>    <span class="n">same_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">adatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">],</span> 
</span><span id="multimodal_processing-162"><a href="#multimodal_processing-162"><span class="linenos">162</span></a>                                       <span class="n">adatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">])</span> 
</span><span id="multimodal_processing-163"><a href="#multimodal_processing-163"><span class="linenos">163</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">))])</span>
</span><span id="multimodal_processing-164"><a href="#multimodal_processing-164"><span class="linenos">164</span></a>
</span><span id="multimodal_processing-165"><a href="#multimodal_processing-165"><span class="linenos">165</span></a>    <span class="k">assert</span> <span class="n">same_train</span><span class="p">,</span> <span class="s1">&#39;Different train indices&#39;</span>
</span><span id="multimodal_processing-166"><a href="#multimodal_processing-166"><span class="linenos">166</span></a>    <span class="k">assert</span> <span class="n">same_test</span><span class="p">,</span> <span class="s1">&#39;Different test indices&#39;</span>
</span><span id="multimodal_processing-167"><a href="#multimodal_processing-167"><span class="linenos">167</span></a>
</span><span id="multimodal_processing-168"><a href="#multimodal_processing-168"><span class="linenos">168</span></a>    <span class="c1"># Creates a boolean array for each modality of cells with non-empty rows</span>
</span><span id="multimodal_processing-169"><a href="#multimodal_processing-169"><span class="linenos">169</span></a>    <span class="n">non_empty_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_sparse_var</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> 
</span><span id="multimodal_processing-170"><a href="#multimodal_processing-170"><span class="linenos">170</span></a>                      <span class="k">for</span> <span class="n">adata</span> <span class="ow">in</span> <span class="n">adatas</span><span class="p">]</span>
</span><span id="multimodal_processing-171"><a href="#multimodal_processing-171"><span class="linenos">171</span></a>
</span><span id="multimodal_processing-172"><a href="#multimodal_processing-172"><span class="linenos">172</span></a>    <span class="c1"># Returns a 1d array where sample feature sums</span>
</span><span id="multimodal_processing-173"><a href="#multimodal_processing-173"><span class="linenos">173</span></a>    <span class="c1"># across all modalities are more than 0</span>
</span><span id="multimodal_processing-174"><a href="#multimodal_processing-174"><span class="linenos">174</span></a>    <span class="n">non_empty_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="o">*</span><span class="n">non_empty_rows</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="multimodal_processing-175"><a href="#multimodal_processing-175"><span class="linenos">175</span></a>
</span><span id="multimodal_processing-176"><a href="#multimodal_processing-176"><span class="linenos">176</span></a>    <span class="c1"># Initializing final train test split array</span>
</span><span id="multimodal_processing-177"><a href="#multimodal_processing-177"><span class="linenos">177</span></a>    <span class="n">train_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">adatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="multimodal_processing-178"><a href="#multimodal_processing-178"><span class="linenos">178</span></a>    <span class="n">train_test</span><span class="p">[</span><span class="n">adatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
</span><span id="multimodal_processing-179"><a href="#multimodal_processing-179"><span class="linenos">179</span></a>
</span><span id="multimodal_processing-180"><a href="#multimodal_processing-180"><span class="linenos">180</span></a>    <span class="c1"># Capturing train test split with empty rows filtered out</span>
</span><span id="multimodal_processing-181"><a href="#multimodal_processing-181"><span class="linenos">181</span></a>    <span class="n">train_test</span> <span class="o">=</span> <span class="n">train_test</span><span class="p">[</span><span class="n">non_empty_rows</span><span class="p">]</span>
</span><span id="multimodal_processing-182"><a href="#multimodal_processing-182"><span class="linenos">182</span></a>    <span class="n">train_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">train_test</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="multimodal_processing-183"><a href="#multimodal_processing-183"><span class="linenos">183</span></a>    <span class="n">test_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">train_test</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="multimodal_processing-184"><a href="#multimodal_processing-184"><span class="linenos">184</span></a>
</span><span id="multimodal_processing-185"><a href="#multimodal_processing-185"><span class="linenos">185</span></a>    <span class="c1"># Adding train test split arrays to AnnData objects </span>
</span><span id="multimodal_processing-186"><a href="#multimodal_processing-186"><span class="linenos">186</span></a>    <span class="c1"># and filtering out empty samples</span>
</span><span id="multimodal_processing-187"><a href="#multimodal_processing-187"><span class="linenos">187</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">adata</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adatas</span><span class="p">):</span>
</span><span id="multimodal_processing-188"><a href="#multimodal_processing-188"><span class="linenos">188</span></a>        <span class="n">adatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_indices</span>
</span><span id="multimodal_processing-189"><a href="#multimodal_processing-189"><span class="linenos">189</span></a>        <span class="n">adatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_indices</span>
</span><span id="multimodal_processing-190"><a href="#multimodal_processing-190"><span class="linenos">190</span></a>        <span class="n">adatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">non_empty_rows</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="multimodal_processing-191"><a href="#multimodal_processing-191"><span class="linenos">191</span></a>        <span class="c1"># tfidf normalizing if corresponding element in tfidf is True</span>
</span><span id="multimodal_processing-192"><a href="#multimodal_processing-192"><span class="linenos">192</span></a>        <span class="k">if</span> <span class="n">tfidf</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="multimodal_processing-193"><a href="#multimodal_processing-193"><span class="linenos">193</span></a>            <span class="n">adatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tfidf_normalize</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</span><span id="multimodal_processing-194"><a href="#multimodal_processing-194"><span class="linenos">194</span></a>
</span><span id="multimodal_processing-195"><a href="#multimodal_processing-195"><span class="linenos">195</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimating Sigma for </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="multimodal_processing-196"><a href="#multimodal_processing-196"><span class="linenos">196</span></a>        <span class="n">adatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimate_sigma</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="multimodal_processing-197"><a href="#multimodal_processing-197"><span class="linenos">197</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating Z for </span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="multimodal_processing-198"><a href="#multimodal_processing-198"><span class="linenos">198</span></a>        <span class="n">adatas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_z</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span>
</span><span id="multimodal_processing-199"><a href="#multimodal_processing-199"><span class="linenos">199</span></a>
</span><span id="multimodal_processing-200"><a href="#multimodal_processing-200"><span class="linenos">200</span></a>    <span class="k">if</span> <span class="s1">&#39;labels&#39;</span> <span class="ow">in</span> <span class="n">adatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span>
</span><span id="multimodal_processing-201"><a href="#multimodal_processing-201"><span class="linenos">201</span></a>        <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">adata</span> <span class="ow">in</span> <span class="n">adatas</span><span class="p">]</span>
</span><span id="multimodal_processing-202"><a href="#multimodal_processing-202"><span class="linenos">202</span></a>        <span class="c1"># Ensuring cell labels for each AnnData object are the same</span>
</span><span id="multimodal_processing-203"><a href="#multimodal_processing-203"><span class="linenos">203</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)):</span>
</span><span id="multimodal_processing-204"><a href="#multimodal_processing-204"><span class="linenos">204</span></a>            <span class="n">same_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">all_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="multimodal_processing-205"><a href="#multimodal_processing-205"><span class="linenos">205</span></a>            <span class="k">assert</span> <span class="n">same_labels</span><span class="p">,</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cell labels between AnnData object in &quot;</span>
</span><span id="multimodal_processing-206"><a href="#multimodal_processing-206"><span class="linenos">206</span></a>                                 <span class="sa">f</span><span class="s2">&quot;position 0 and position </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> in adatas do &quot;</span>
</span><span id="multimodal_processing-207"><a href="#multimodal_processing-207"><span class="linenos">207</span></a>                                 <span class="s2">&quot;not match&quot;</span><span class="p">)</span>
</span><span id="multimodal_processing-208"><a href="#multimodal_processing-208"><span class="linenos">208</span></a>
</span><span id="multimodal_processing-209"><a href="#multimodal_processing-209"><span class="linenos">209</span></a>    <span class="n">adata</span> <span class="o">=</span> <span class="n">_combine_modalities</span><span class="p">(</span><span class="n">adatas</span> <span class="o">=</span> <span class="n">adatas</span><span class="p">,</span>
</span><span id="multimodal_processing-210"><a href="#multimodal_processing-210"><span class="linenos">210</span></a>                                <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="p">,</span>
</span><span id="multimodal_processing-211"><a href="#multimodal_processing-211"><span class="linenos">211</span></a>                                <span class="n">combination</span> <span class="o">=</span> <span class="s1">&#39;concatenate&#39;</span><span class="p">)</span>
</span><span id="multimodal_processing-212"><a href="#multimodal_processing-212"><span class="linenos">212</span></a>
</span><span id="multimodal_processing-213"><a href="#multimodal_processing-213"><span class="linenos">213</span></a>    <span class="k">del</span> <span class="n">adatas</span>
</span><span id="multimodal_processing-214"><a href="#multimodal_processing-214"><span class="linenos">214</span></a>    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="multimodal_processing-215"><a href="#multimodal_processing-215"><span class="linenos">215</span></a>
</span><span id="multimodal_processing-216"><a href="#multimodal_processing-216"><span class="linenos">216</span></a>    <span class="k">return</span> <span class="n">adata</span>    
</span></pre></div>


            <div class="docstring"><p>Combines and processes a list of adata objects.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>adatas</strong> : <em>list[AnnData]</em> </p>

<blockquote>
  <p>List of AnnData objects where each object is a different 
      modality for the same cells.</p>
</blockquote>

<p><strong>names</strong> : <em>list[str]</em></p>

<blockquote>
  <p>List of string names for each modality repective to each 
      object in <code>adatas</code>.</p>
</blockquote>

<p><strong>tfidf</strong> : <em>bool</em> </p>

<blockquote>
  <p>List where if element i is <code>True</code>, adata[i] will be TFIDF 
      normalized.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>adata</strong> : <em>AnnData</em> </p>

<blockquote>
  <p>Concatenated from objects from <code>adatas</code> with Z matrices 
      calculated.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">rna_adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/create_adata.html">scmkl.create_adata</a></span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">mcf7_rna_mat</span><span class="p">,</span> 
<span class="gp">... </span>                               <span class="n">feature_names</span> <span class="o">=</span> <span class="n">gene_names</span><span class="p">,</span> 
<span class="gp">... </span>                               <span class="n">scale_data</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
<span class="gp">... </span>                               <span class="n">cell_labels</span> <span class="o">=</span> <span class="n">cell_labels</span><span class="p">,</span> 
<span class="gp">... </span>                                <span class="n">group_dict</span> <span class="o">=</span> <span class="n">rna_grouping</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">atac_adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/create_adata.html">scmkl.create_adata</a></span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">mcf7_atac_mat</span><span class="p">,</span> 
<span class="gp">... </span>                                <span class="n">feature_names</span> <span class="o">=</span> <span class="n">peak_names</span><span class="p">,</span> 
<span class="gp">... </span>                                <span class="n">scale_data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
<span class="gp">... </span>                                <span class="n">cell_labels</span> <span class="o">=</span> <span class="n">cell_labels</span><span class="p">,</span> 
<span class="gp">... </span>                                <span class="n">group_dict</span> <span class="o">=</span> <span class="n">atac_grouping</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">rna_adata</span><span class="p">,</span> <span class="n">atac_adata</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mod_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rna&#39;</span><span class="p">,</span> <span class="s1">&#39;atac&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/multimodal_processing.html">scmkl.multimodal_processing</a></span><span class="p">(</span><span class="n">adatas</span> <span class="o">=</span> <span class="n">adatas</span><span class="p">,</span> 
<span class="gp">... </span>                                    <span class="n">names</span> <span class="o">=</span> <span class="n">mod_names</span><span class="p">,</span>
<span class="gp">... </span>                                    <span class="n">tfidf</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span>
<span class="go">AnnData object with n_obs × n_vars = 1000 × 12676</span>
<span class="go">obs: &#39;labels&#39;</span>
<span class="go">var: &#39;labels&#39;</span>
<span class="go">uns: &#39;D&#39;, &#39;kernel_type&#39;, &#39;distance_metric&#39;, &#39;train_indices&#39;,  </span>
<span class="go">&#39;test_indices&#39;, &#39;Z_train&#39;, &#39;Z_test&#39;, &#39;group_dict&#39;, &#39;seed_obj&#39;</span>
</code></pre>
</div>
</div>


                </section>
                <section id="one_v_rest">
                            <input id="one_v_rest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">one_v_rest</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">adatas</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">names</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">alpha_list</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">tfidf</span><span class="p">:</span> <span class="nb">list</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="one_v_rest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#one_v_rest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="one_v_rest-108"><a href="#one_v_rest-108"><span class="linenos">108</span></a><span class="k">def</span> <span class="nf">one_v_rest</span><span class="p">(</span><span class="n">adatas</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">names</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">alpha_list</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
</span><span id="one_v_rest-109"><a href="#one_v_rest-109"><span class="linenos">109</span></a>              <span class="n">tfidf</span> <span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="one_v_rest-110"><a href="#one_v_rest-110"><span class="linenos">110</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="one_v_rest-111"><a href="#one_v_rest-111"><span class="linenos">111</span></a><span class="sd">    For each cell class, creates model(s) comparing that class to all </span>
</span><span id="one_v_rest-112"><a href="#one_v_rest-112"><span class="linenos">112</span></a><span class="sd">    others. Then, predicts on the training data using `scmkl.run()`.</span>
</span><span id="one_v_rest-113"><a href="#one_v_rest-113"><span class="linenos">113</span></a><span class="sd">    Only labels in both training and testing will be run.</span>
</span><span id="one_v_rest-114"><a href="#one_v_rest-114"><span class="linenos">114</span></a>
</span><span id="one_v_rest-115"><a href="#one_v_rest-115"><span class="linenos">115</span></a><span class="sd">    Parameters</span>
</span><span id="one_v_rest-116"><a href="#one_v_rest-116"><span class="linenos">116</span></a><span class="sd">    ----------</span>
</span><span id="one_v_rest-117"><a href="#one_v_rest-117"><span class="linenos">117</span></a><span class="sd">    **adatas** : *list[AnnData]* </span>
</span><span id="one_v_rest-118"><a href="#one_v_rest-118"><span class="linenos">118</span></a><span class="sd">        &gt; List of AnnData objects created by create_adata()</span>
</span><span id="one_v_rest-119"><a href="#one_v_rest-119"><span class="linenos">119</span></a><span class="sd">        where each AnnData is one modality and composed of both </span>
</span><span id="one_v_rest-120"><a href="#one_v_rest-120"><span class="linenos">120</span></a><span class="sd">        training and testing samples. Requires that `&#39;train_indices&#39;`</span>
</span><span id="one_v_rest-121"><a href="#one_v_rest-121"><span class="linenos">121</span></a><span class="sd">        and `&#39;test_indices&#39;` are the same across all AnnDatas.</span>
</span><span id="one_v_rest-122"><a href="#one_v_rest-122"><span class="linenos">122</span></a>
</span><span id="one_v_rest-123"><a href="#one_v_rest-123"><span class="linenos">123</span></a><span class="sd">    **names** : *list[str]* </span>
</span><span id="one_v_rest-124"><a href="#one_v_rest-124"><span class="linenos">124</span></a><span class="sd">        &gt; List of string variables that describe each modality</span>
</span><span id="one_v_rest-125"><a href="#one_v_rest-125"><span class="linenos">125</span></a><span class="sd">        respective to adatas for labeling.</span>
</span><span id="one_v_rest-126"><a href="#one_v_rest-126"><span class="linenos">126</span></a><span class="sd">        </span>
</span><span id="one_v_rest-127"><a href="#one_v_rest-127"><span class="linenos">127</span></a><span class="sd">    **alpha_list** : *np.ndarray* | *float*</span>
</span><span id="one_v_rest-128"><a href="#one_v_rest-128"><span class="linenos">128</span></a><span class="sd">        &gt; An array of alpha values to create each model with.</span>
</span><span id="one_v_rest-129"><a href="#one_v_rest-129"><span class="linenos">129</span></a>
</span><span id="one_v_rest-130"><a href="#one_v_rest-130"><span class="linenos">130</span></a><span class="sd">    **tfidf** : *list[bool]* </span>
</span><span id="one_v_rest-131"><a href="#one_v_rest-131"><span class="linenos">131</span></a><span class="sd">        &gt; List where if element i is `True`, adata[i] will be TFIDF </span>
</span><span id="one_v_rest-132"><a href="#one_v_rest-132"><span class="linenos">132</span></a><span class="sd">        normalized.</span>
</span><span id="one_v_rest-133"><a href="#one_v_rest-133"><span class="linenos">133</span></a>
</span><span id="one_v_rest-134"><a href="#one_v_rest-134"><span class="linenos">134</span></a><span class="sd">    Returns</span>
</span><span id="one_v_rest-135"><a href="#one_v_rest-135"><span class="linenos">135</span></a><span class="sd">    -------</span>
</span><span id="one_v_rest-136"><a href="#one_v_rest-136"><span class="linenos">136</span></a><span class="sd">    **results** : *dict*</span>
</span><span id="one_v_rest-137"><a href="#one_v_rest-137"><span class="linenos">137</span></a><span class="sd">    &gt; Contains keys for each cell class with results from cell class</span>
</span><span id="one_v_rest-138"><a href="#one_v_rest-138"><span class="linenos">138</span></a><span class="sd">    versus all other samples. See `scmkl.run()` for futher details.</span>
</span><span id="one_v_rest-139"><a href="#one_v_rest-139"><span class="linenos">139</span></a>
</span><span id="one_v_rest-140"><a href="#one_v_rest-140"><span class="linenos">140</span></a><span class="sd">    Examples</span>
</span><span id="one_v_rest-141"><a href="#one_v_rest-141"><span class="linenos">141</span></a><span class="sd">    --------</span>
</span><span id="one_v_rest-142"><a href="#one_v_rest-142"><span class="linenos">142</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.create_adata(X = data_mat, </span>
</span><span id="one_v_rest-143"><a href="#one_v_rest-143"><span class="linenos">143</span></a><span class="sd">    ...                            feature_names = gene_names, </span>
</span><span id="one_v_rest-144"><a href="#one_v_rest-144"><span class="linenos">144</span></a><span class="sd">    ...                            group_dict = group_dict)</span>
</span><span id="one_v_rest-145"><a href="#one_v_rest-145"><span class="linenos">145</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="one_v_rest-146"><a href="#one_v_rest-146"><span class="linenos">146</span></a><span class="sd">    &gt;&gt;&gt; results = scmkl.one_v_rest(adatas = [adata], names = [&#39;rna&#39;],</span>
</span><span id="one_v_rest-147"><a href="#one_v_rest-147"><span class="linenos">147</span></a><span class="sd">    ...                           alpha_list = np.array([0.05, 0.1]),</span>
</span><span id="one_v_rest-148"><a href="#one_v_rest-148"><span class="linenos">148</span></a><span class="sd">    ...                           tfidf = [False])</span>
</span><span id="one_v_rest-149"><a href="#one_v_rest-149"><span class="linenos">149</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="one_v_rest-150"><a href="#one_v_rest-150"><span class="linenos">150</span></a><span class="sd">    &gt;&gt;&gt; adata.keys()</span>
</span><span id="one_v_rest-151"><a href="#one_v_rest-151"><span class="linenos">151</span></a><span class="sd">    dict_keys([&#39;B cells&#39;, &#39;Monocytes&#39;, &#39;Dendritic cells&#39;, ...])</span>
</span><span id="one_v_rest-152"><a href="#one_v_rest-152"><span class="linenos">152</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="one_v_rest-153"><a href="#one_v_rest-153"><span class="linenos">153</span></a>    <span class="c1"># Formatting checks ensuring all adata elements are </span>
</span><span id="one_v_rest-154"><a href="#one_v_rest-154"><span class="linenos">154</span></a>    <span class="c1"># AnnData objects and train/test indices are all the same</span>
</span><span id="one_v_rest-155"><a href="#one_v_rest-155"><span class="linenos">155</span></a>    <span class="n">_check_adatas</span><span class="p">(</span><span class="n">adatas</span><span class="p">,</span> <span class="n">check_obs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">check_uns</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="one_v_rest-156"><a href="#one_v_rest-156"><span class="linenos">156</span></a>
</span><span id="one_v_rest-157"><a href="#one_v_rest-157"><span class="linenos">157</span></a>    <span class="c1"># Extracting train and test indices</span>
</span><span id="one_v_rest-158"><a href="#one_v_rest-158"><span class="linenos">158</span></a>    <span class="n">train_indices</span> <span class="o">=</span> <span class="n">adatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">]</span>
</span><span id="one_v_rest-159"><a href="#one_v_rest-159"><span class="linenos">159</span></a>    <span class="n">test_indices</span> <span class="o">=</span> <span class="n">adatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]</span>
</span><span id="one_v_rest-160"><a href="#one_v_rest-160"><span class="linenos">160</span></a>
</span><span id="one_v_rest-161"><a href="#one_v_rest-161"><span class="linenos">161</span></a>    <span class="c1"># Checking and capturing cell labels</span>
</span><span id="one_v_rest-162"><a href="#one_v_rest-162"><span class="linenos">162</span></a>    <span class="n">uniq_labels</span> <span class="o">=</span> <span class="n">_eval_labels</span><span class="p">(</span>  <span class="n">cell_labels</span> <span class="o">=</span> <span class="n">adatas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span> 
</span><span id="one_v_rest-163"><a href="#one_v_rest-163"><span class="linenos">163</span></a>                                <span class="n">train_indices</span> <span class="o">=</span> <span class="n">train_indices</span><span class="p">,</span>
</span><span id="one_v_rest-164"><a href="#one_v_rest-164"><span class="linenos">164</span></a>                                 <span class="n">test_indices</span> <span class="o">=</span> <span class="n">test_indices</span><span class="p">)</span>
</span><span id="one_v_rest-165"><a href="#one_v_rest-165"><span class="linenos">165</span></a>
</span><span id="one_v_rest-166"><a href="#one_v_rest-166"><span class="linenos">166</span></a>
</span><span id="one_v_rest-167"><a href="#one_v_rest-167"><span class="linenos">167</span></a>    <span class="c1"># Calculating Z matrices, method depends on whether there are multiple </span>
</span><span id="one_v_rest-168"><a href="#one_v_rest-168"><span class="linenos">168</span></a>    <span class="c1"># adatas (modalities)</span>
</span><span id="one_v_rest-169"><a href="#one_v_rest-169"><span class="linenos">169</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adatas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="one_v_rest-170"><a href="#one_v_rest-170"><span class="linenos">170</span></a>        <span class="n">adata</span> <span class="o">=</span> <span class="n">estimate_sigma</span><span class="p">(</span><span class="n">adatas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_features</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="one_v_rest-171"><a href="#one_v_rest-171"><span class="linenos">171</span></a>        <span class="n">adata</span> <span class="o">=</span> <span class="n">calculate_z</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span>
</span><span id="one_v_rest-172"><a href="#one_v_rest-172"><span class="linenos">172</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="one_v_rest-173"><a href="#one_v_rest-173"><span class="linenos">173</span></a>        <span class="n">adata</span> <span class="o">=</span> <span class="n">multimodal_processing</span><span class="p">(</span><span class="n">adatas</span> <span class="o">=</span> <span class="n">adatas</span><span class="p">,</span> 
</span><span id="one_v_rest-174"><a href="#one_v_rest-174"><span class="linenos">174</span></a>                                        <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="p">,</span> 
</span><span id="one_v_rest-175"><a href="#one_v_rest-175"><span class="linenos">175</span></a>                                        <span class="n">tfidf</span> <span class="o">=</span> <span class="n">tfidf</span><span class="p">,</span> 
</span><span id="one_v_rest-176"><a href="#one_v_rest-176"><span class="linenos">176</span></a>                                        <span class="n">z_calculation</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="one_v_rest-177"><a href="#one_v_rest-177"><span class="linenos">177</span></a>
</span><span id="one_v_rest-178"><a href="#one_v_rest-178"><span class="linenos">178</span></a>    <span class="k">del</span> <span class="n">adatas</span>
</span><span id="one_v_rest-179"><a href="#one_v_rest-179"><span class="linenos">179</span></a>    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="one_v_rest-180"><a href="#one_v_rest-180"><span class="linenos">180</span></a>
</span><span id="one_v_rest-181"><a href="#one_v_rest-181"><span class="linenos">181</span></a>    <span class="c1"># Initializing for capturing model outputs</span>
</span><span id="one_v_rest-182"><a href="#one_v_rest-182"><span class="linenos">182</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="one_v_rest-183"><a href="#one_v_rest-183"><span class="linenos">183</span></a>
</span><span id="one_v_rest-184"><a href="#one_v_rest-184"><span class="linenos">184</span></a>    <span class="c1"># Capturing cell labels before overwriting</span>
</span><span id="one_v_rest-185"><a href="#one_v_rest-185"><span class="linenos">185</span></a>    <span class="n">cell_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">])</span>
</span><span id="one_v_rest-186"><a href="#one_v_rest-186"><span class="linenos">186</span></a>
</span><span id="one_v_rest-187"><a href="#one_v_rest-187"><span class="linenos">187</span></a>    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">uniq_labels</span><span class="p">:</span>
</span><span id="one_v_rest-188"><a href="#one_v_rest-188"><span class="linenos">188</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comparing </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> to other types&quot;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="one_v_rest-189"><a href="#one_v_rest-189"><span class="linenos">189</span></a>        <span class="n">cur_labels</span> <span class="o">=</span> <span class="n">cell_labels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="one_v_rest-190"><a href="#one_v_rest-190"><span class="linenos">190</span></a>        <span class="n">cur_labels</span><span class="p">[</span><span class="n">cell_labels</span> <span class="o">!=</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>
</span><span id="one_v_rest-191"><a href="#one_v_rest-191"><span class="linenos">191</span></a>        
</span><span id="one_v_rest-192"><a href="#one_v_rest-192"><span class="linenos">192</span></a>        <span class="c1"># Replacing cell labels for current cell type vs rest</span>
</span><span id="one_v_rest-193"><a href="#one_v_rest-193"><span class="linenos">193</span></a>        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_labels</span>
</span><span id="one_v_rest-194"><a href="#one_v_rest-194"><span class="linenos">194</span></a>
</span><span id="one_v_rest-195"><a href="#one_v_rest-195"><span class="linenos">195</span></a>        <span class="c1"># Running scMKL</span>
</span><span id="one_v_rest-196"><a href="#one_v_rest-196"><span class="linenos">196</span></a>        <span class="n">results</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">alpha_list</span><span class="p">,</span> <span class="n">return_probs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="one_v_rest-197"><a href="#one_v_rest-197"><span class="linenos">197</span></a>
</span><span id="one_v_rest-198"><a href="#one_v_rest-198"><span class="linenos">198</span></a>    <span class="c1"># Getting final predictions</span>
</span><span id="one_v_rest-199"><a href="#one_v_rest-199"><span class="linenos">199</span></a>    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">alpha_list</span><span class="p">)</span>
</span><span id="one_v_rest-200"><a href="#one_v_rest-200"><span class="linenos">200</span></a>    <span class="n">prob_table</span><span class="p">,</span> <span class="n">pred_class</span><span class="p">,</span> <span class="n">low_conf</span> <span class="o">=</span> <span class="n">_prob_table</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
</span><span id="one_v_rest-201"><a href="#one_v_rest-201"><span class="linenos">201</span></a>
</span><span id="one_v_rest-202"><a href="#one_v_rest-202"><span class="linenos">202</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Probability_table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_table</span>
</span><span id="one_v_rest-203"><a href="#one_v_rest-203"><span class="linenos">203</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Predicted_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_class</span>
</span><span id="one_v_rest-204"><a href="#one_v_rest-204"><span class="linenos">204</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Truth_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_labels</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]]</span>
</span><span id="one_v_rest-205"><a href="#one_v_rest-205"><span class="linenos">205</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Low_confidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">low_conf</span>
</span><span id="one_v_rest-206"><a href="#one_v_rest-206"><span class="linenos">206</span></a>
</span><span id="one_v_rest-207"><a href="#one_v_rest-207"><span class="linenos">207</span></a>    <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>For each cell class, creates model(s) comparing that class to all 
others. Then, predicts on the training data using <code><a href="scmkl/run.html">scmkl.run</a></code>.
Only labels in both training and testing will be run.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>adatas</strong> : <em>list[AnnData]</em> </p>

<blockquote>
  <p>List of AnnData objects created by create_adata()
      where each AnnData is one modality and composed of both 
      training and testing samples. Requires that <code>'train_indices'</code>
      and <code>'test_indices'</code> are the same across all AnnDatas.</p>
</blockquote>

<p><strong>names</strong> : <em>list[str]</em> </p>

<blockquote>
  <p>List of string variables that describe each modality
      respective to adatas for labeling.</p>
</blockquote>

<p><strong>alpha_list</strong> : <em>np.ndarray</em> | <em>float</em></p>

<blockquote>
  <p>An array of alpha values to create each model with.</p>
</blockquote>

<p><strong>tfidf</strong> : <em>list[bool]</em> </p>

<blockquote>
  <p>List where if element i is <code>True</code>, adata[i] will be TFIDF 
      normalized.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>results</strong> : <em>dict</em></p>

<blockquote>
  <p>Contains keys for each cell class with results from cell class
  versus all other samples. See <code><a href="scmkl/run.html">scmkl.run</a></code> for futher details.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/create_adata.html">scmkl.create_adata</a></span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">data_mat</span><span class="p">,</span> 
<span class="gp">... </span>                           <span class="n">feature_names</span> <span class="o">=</span> <span class="n">gene_names</span><span class="p">,</span> 
<span class="gp">... </span>                           <span class="n">group_dict</span> <span class="o">=</span> <span class="n">group_dict</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n"><a href="scmkl/one_v_rest.html">scmkl.one_v_rest</a></span><span class="p">(</span><span class="n">adatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="p">],</span> <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rna&#39;</span><span class="p">],</span>
<span class="gp">... </span>                          <span class="n">alpha_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]),</span>
<span class="gp">... </span>                          <span class="n">tfidf</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="go">dict_keys([&#39;B cells&#39;, &#39;Monocytes&#39;, &#39;Dendritic cells&#39;, ...])</span>
</code></pre>
</div>
</div>


                </section>
                <section id="optimize_alpha">
                            <input id="optimize_alpha-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">optimize_alpha</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">adata</span>,</span><span class="param">	<span class="n">group_size</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">tfidf</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">alpha_array</span><span class="o">=</span><span class="n">array</span><span class="p">([</span><span class="mf">1.9</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>,</span><span class="param">	<span class="n">k</span><span class="o">=</span><span class="mi">4</span>,</span><span class="param">	<span class="n">metric</span><span class="o">=</span><span class="s1">&#39;AUROC&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="optimize_alpha-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#optimize_alpha"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="optimize_alpha-104"><a href="#optimize_alpha-104"><span class="linenos">104</span></a><span class="k">def</span> <span class="nf">optimize_alpha</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group_size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tfidf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
</span><span id="optimize_alpha-105"><a href="#optimize_alpha-105"><span class="linenos">105</span></a>                   <span class="n">alpha_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.9</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span> 
</span><span id="optimize_alpha-106"><a href="#optimize_alpha-106"><span class="linenos">106</span></a>                   <span class="n">k</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;AUROC&#39;</span><span class="p">):</span>
</span><span id="optimize_alpha-107"><a href="#optimize_alpha-107"><span class="linenos">107</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="optimize_alpha-108"><a href="#optimize_alpha-108"><span class="linenos">108</span></a><span class="sd">    Iteratively train a grouplasso model and update alpha to find the </span>
</span><span id="optimize_alpha-109"><a href="#optimize_alpha-109"><span class="linenos">109</span></a><span class="sd">    parameter yielding best performing sparsity. This function </span>
</span><span id="optimize_alpha-110"><a href="#optimize_alpha-110"><span class="linenos">110</span></a><span class="sd">    currently only works for binary experiments.</span>
</span><span id="optimize_alpha-111"><a href="#optimize_alpha-111"><span class="linenos">111</span></a>
</span><span id="optimize_alpha-112"><a href="#optimize_alpha-112"><span class="linenos">112</span></a><span class="sd">    Parameters</span>
</span><span id="optimize_alpha-113"><a href="#optimize_alpha-113"><span class="linenos">113</span></a><span class="sd">    ----------</span>
</span><span id="optimize_alpha-114"><a href="#optimize_alpha-114"><span class="linenos">114</span></a><span class="sd">    **adata** : *AnnData* | *list[AnnData]*</span>
</span><span id="optimize_alpha-115"><a href="#optimize_alpha-115"><span class="linenos">115</span></a><span class="sd">        &gt; `AnnData`(s) with `&#39;Z_train&#39;` and `&#39;Z_test&#39;` in </span>
</span><span id="optimize_alpha-116"><a href="#optimize_alpha-116"><span class="linenos">116</span></a><span class="sd">        `adata.uns.keys()`.</span>
</span><span id="optimize_alpha-117"><a href="#optimize_alpha-117"><span class="linenos">117</span></a>
</span><span id="optimize_alpha-118"><a href="#optimize_alpha-118"><span class="linenos">118</span></a><span class="sd">    **group_size** : *None* | *int*</span>
</span><span id="optimize_alpha-119"><a href="#optimize_alpha-119"><span class="linenos">119</span></a><span class="sd">        &gt; Argument describing how the features are grouped. If *None*, </span>
</span><span id="optimize_alpha-120"><a href="#optimize_alpha-120"><span class="linenos">120</span></a><span class="sd">        `2 * adata.uns[&#39;D&#39;] will be used. </span>
</span><span id="optimize_alpha-121"><a href="#optimize_alpha-121"><span class="linenos">121</span></a><span class="sd">        For more information see </span>
</span><span id="optimize_alpha-122"><a href="#optimize_alpha-122"><span class="linenos">122</span></a><span class="sd">        [celer documentation](https://mathurinm.github.io/celer/generated/celer.GroupLasso.html).</span>
</span><span id="optimize_alpha-123"><a href="#optimize_alpha-123"><span class="linenos">123</span></a>
</span><span id="optimize_alpha-124"><a href="#optimize_alpha-124"><span class="linenos">124</span></a><span class="sd">    **tfidf** : *bool* </span>
</span><span id="optimize_alpha-125"><a href="#optimize_alpha-125"><span class="linenos">125</span></a><span class="sd">        &gt; If `True`, TFIDF normalization will be run at each fold.</span>
</span><span id="optimize_alpha-126"><a href="#optimize_alpha-126"><span class="linenos">126</span></a><span class="sd">    </span>
</span><span id="optimize_alpha-127"><a href="#optimize_alpha-127"><span class="linenos">127</span></a><span class="sd">    **alpha_array** : *np.ndarray*</span>
</span><span id="optimize_alpha-128"><a href="#optimize_alpha-128"><span class="linenos">128</span></a><span class="sd">        &gt; Array of all alpha values to be tested.</span>
</span><span id="optimize_alpha-129"><a href="#optimize_alpha-129"><span class="linenos">129</span></a>
</span><span id="optimize_alpha-130"><a href="#optimize_alpha-130"><span class="linenos">130</span></a><span class="sd">    **k** : *int*</span>
</span><span id="optimize_alpha-131"><a href="#optimize_alpha-131"><span class="linenos">131</span></a><span class="sd">        &gt; Number of folds to perform cross validation over.</span>
</span><span id="optimize_alpha-132"><a href="#optimize_alpha-132"><span class="linenos">132</span></a><span class="sd">            </span>
</span><span id="optimize_alpha-133"><a href="#optimize_alpha-133"><span class="linenos">133</span></a><span class="sd">    **metric**: *str*</span>
</span><span id="optimize_alpha-134"><a href="#optimize_alpha-134"><span class="linenos">134</span></a><span class="sd">        &gt; Which metric to use to optimize alpha. Options</span>
</span><span id="optimize_alpha-135"><a href="#optimize_alpha-135"><span class="linenos">135</span></a><span class="sd">        are `&#39;AUROC&#39;`, `&#39;Accuracy&#39;`, `&#39;F1-Score&#39;`, `&#39;Precision&#39;`, and </span>
</span><span id="optimize_alpha-136"><a href="#optimize_alpha-136"><span class="linenos">136</span></a><span class="sd">        `&#39;Recall&#39;`</span>
</span><span id="optimize_alpha-137"><a href="#optimize_alpha-137"><span class="linenos">137</span></a>
</span><span id="optimize_alpha-138"><a href="#optimize_alpha-138"><span class="linenos">138</span></a><span class="sd">    Returns</span>
</span><span id="optimize_alpha-139"><a href="#optimize_alpha-139"><span class="linenos">139</span></a><span class="sd">    -------</span>
</span><span id="optimize_alpha-140"><a href="#optimize_alpha-140"><span class="linenos">140</span></a><span class="sd">    **alpha_star** : *int*</span>
</span><span id="optimize_alpha-141"><a href="#optimize_alpha-141"><span class="linenos">141</span></a><span class="sd">        &gt; The best performing alpha value from cross validation on </span>
</span><span id="optimize_alpha-142"><a href="#optimize_alpha-142"><span class="linenos">142</span></a><span class="sd">        training data.</span>
</span><span id="optimize_alpha-143"><a href="#optimize_alpha-143"><span class="linenos">143</span></a>
</span><span id="optimize_alpha-144"><a href="#optimize_alpha-144"><span class="linenos">144</span></a><span class="sd">    Examples</span>
</span><span id="optimize_alpha-145"><a href="#optimize_alpha-145"><span class="linenos">145</span></a><span class="sd">    --------</span>
</span><span id="optimize_alpha-146"><a href="#optimize_alpha-146"><span class="linenos">146</span></a><span class="sd">    &gt;&gt;&gt; alpha_star = scmkl.optimize_alpha(adata)</span>
</span><span id="optimize_alpha-147"><a href="#optimize_alpha-147"><span class="linenos">147</span></a><span class="sd">    &gt;&gt;&gt; alpha_star</span>
</span><span id="optimize_alpha-148"><a href="#optimize_alpha-148"><span class="linenos">148</span></a><span class="sd">    0.1</span>
</span><span id="optimize_alpha-149"><a href="#optimize_alpha-149"><span class="linenos">149</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="optimize_alpha-150"><a href="#optimize_alpha-150"><span class="linenos">150</span></a>
</span><span id="optimize_alpha-151"><a href="#optimize_alpha-151"><span class="linenos">151</span></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Must be a positive integer number of folds&#39;</span>
</span><span id="optimize_alpha-152"><a href="#optimize_alpha-152"><span class="linenos">152</span></a>
</span><span id="optimize_alpha-153"><a href="#optimize_alpha-153"><span class="linenos">153</span></a>    <span class="kn">import</span> <span class="nn">warnings</span> 
</span><span id="optimize_alpha-154"><a href="#optimize_alpha-154"><span class="linenos">154</span></a>    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span><span id="optimize_alpha-155"><a href="#optimize_alpha-155"><span class="linenos">155</span></a>
</span><span id="optimize_alpha-156"><a href="#optimize_alpha-156"><span class="linenos">156</span></a>    <span class="k">if</span> <span class="n">group_size</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="optimize_alpha-157"><a href="#optimize_alpha-157"><span class="linenos">157</span></a>        <span class="n">group_size</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="optimize_alpha-158"><a href="#optimize_alpha-158"><span class="linenos">158</span></a>
</span><span id="optimize_alpha-159"><a href="#optimize_alpha-159"><span class="linenos">159</span></a>    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="optimize_alpha-160"><a href="#optimize_alpha-160"><span class="linenos">160</span></a>        <span class="n">alpha_star</span> <span class="o">=</span> <span class="n">_multimodal_optimize_alpha</span><span class="p">(</span><span class="n">adatas</span> <span class="o">=</span> <span class="n">adata</span><span class="p">,</span> <span class="n">group_size</span> <span class="o">=</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">tfidf</span> <span class="o">=</span> <span class="n">tfidf</span><span class="p">,</span> <span class="n">alpha_array</span> <span class="o">=</span> <span class="n">alpha_array</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="p">)</span>
</span><span id="optimize_alpha-161"><a href="#optimize_alpha-161"><span class="linenos">161</span></a>        <span class="k">return</span> <span class="n">alpha_star</span>
</span><span id="optimize_alpha-162"><a href="#optimize_alpha-162"><span class="linenos">162</span></a>
</span><span id="optimize_alpha-163"><a href="#optimize_alpha-163"><span class="linenos">163</span></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="optimize_alpha-164"><a href="#optimize_alpha-164"><span class="linenos">164</span></a>    
</span><span id="optimize_alpha-165"><a href="#optimize_alpha-165"><span class="linenos">165</span></a>    <span class="c1"># Splits the labels evenly between folds</span>
</span><span id="optimize_alpha-166"><a href="#optimize_alpha-166"><span class="linenos">166</span></a>    <span class="n">positive_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="optimize_alpha-167"><a href="#optimize_alpha-167"><span class="linenos">167</span></a>    <span class="n">negative_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">positive_indices</span><span class="p">)</span>
</span><span id="optimize_alpha-168"><a href="#optimize_alpha-168"><span class="linenos">168</span></a>
</span><span id="optimize_alpha-169"><a href="#optimize_alpha-169"><span class="linenos">169</span></a>    <span class="n">positive_annotations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_indices</span><span class="p">))</span> <span class="o">%</span> <span class="n">k</span>
</span><span id="optimize_alpha-170"><a href="#optimize_alpha-170"><span class="linenos">170</span></a>    <span class="n">negative_annotations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">negative_indices</span><span class="p">))</span> <span class="o">%</span> <span class="n">k</span>
</span><span id="optimize_alpha-171"><a href="#optimize_alpha-171"><span class="linenos">171</span></a>
</span><span id="optimize_alpha-172"><a href="#optimize_alpha-172"><span class="linenos">172</span></a>    <span class="n">metric_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">alpha_array</span><span class="p">),</span> <span class="n">k</span><span class="p">))</span>
</span><span id="optimize_alpha-173"><a href="#optimize_alpha-173"><span class="linenos">173</span></a>
</span><span id="optimize_alpha-174"><a href="#optimize_alpha-174"><span class="linenos">174</span></a>    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="optimize_alpha-175"><a href="#optimize_alpha-175"><span class="linenos">175</span></a>
</span><span id="optimize_alpha-176"><a href="#optimize_alpha-176"><span class="linenos">176</span></a>    <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
</span><span id="optimize_alpha-177"><a href="#optimize_alpha-177"><span class="linenos">177</span></a>
</span><span id="optimize_alpha-178"><a href="#optimize_alpha-178"><span class="linenos">178</span></a>        <span class="n">cv_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">],:]</span>
</span><span id="optimize_alpha-179"><a href="#optimize_alpha-179"><span class="linenos">179</span></a>
</span><span id="optimize_alpha-180"><a href="#optimize_alpha-180"><span class="linenos">180</span></a>        <span class="c1"># Create CV train/test indices</span>
</span><span id="optimize_alpha-181"><a href="#optimize_alpha-181"><span class="linenos">181</span></a>        <span class="n">fold_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">positive_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">positive_annotations</span> <span class="o">!=</span> <span class="n">fold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span> 
</span><span id="optimize_alpha-182"><a href="#optimize_alpha-182"><span class="linenos">182</span></a>                                     <span class="n">negative_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">negative_annotations</span> <span class="o">!=</span> <span class="n">fold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]))</span>
</span><span id="optimize_alpha-183"><a href="#optimize_alpha-183"><span class="linenos">183</span></a>        <span class="n">fold_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">positive_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">positive_annotations</span> <span class="o">==</span> <span class="n">fold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span> 
</span><span id="optimize_alpha-184"><a href="#optimize_alpha-184"><span class="linenos">184</span></a>                                    <span class="n">negative_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">negative_annotations</span> <span class="o">==</span> <span class="n">fold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]))</span>
</span><span id="optimize_alpha-185"><a href="#optimize_alpha-185"><span class="linenos">185</span></a>
</span><span id="optimize_alpha-186"><a href="#optimize_alpha-186"><span class="linenos">186</span></a>        <span class="n">cv_adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold_train</span>
</span><span id="optimize_alpha-187"><a href="#optimize_alpha-187"><span class="linenos">187</span></a>        <span class="n">cv_adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold_test</span>
</span><span id="optimize_alpha-188"><a href="#optimize_alpha-188"><span class="linenos">188</span></a>
</span><span id="optimize_alpha-189"><a href="#optimize_alpha-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="n">tfidf</span><span class="p">:</span>
</span><span id="optimize_alpha-190"><a href="#optimize_alpha-190"><span class="linenos">190</span></a>            <span class="n">cv_adata</span> <span class="o">=</span> <span class="n">tfidf_normalize</span><span class="p">(</span><span class="n">cv_adata</span><span class="p">,</span> <span class="n">binarize</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="optimize_alpha-191"><a href="#optimize_alpha-191"><span class="linenos">191</span></a>
</span><span id="optimize_alpha-192"><a href="#optimize_alpha-192"><span class="linenos">192</span></a>        <span class="n">cv_adata</span> <span class="o">=</span> <span class="n">estimate_sigma</span><span class="p">(</span><span class="n">cv_adata</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
</span><span id="optimize_alpha-193"><a href="#optimize_alpha-193"><span class="linenos">193</span></a>        <span class="n">cv_adata</span> <span class="o">=</span> <span class="n">calculate_z</span><span class="p">(</span><span class="n">cv_adata</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span> <span class="mi">5000</span><span class="p">)</span>
</span><span id="optimize_alpha-194"><a href="#optimize_alpha-194"><span class="linenos">194</span></a>
</span><span id="optimize_alpha-195"><a href="#optimize_alpha-195"><span class="linenos">195</span></a>        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="optimize_alpha-196"><a href="#optimize_alpha-196"><span class="linenos">196</span></a>
</span><span id="optimize_alpha-197"><a href="#optimize_alpha-197"><span class="linenos">197</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alpha_array</span><span class="p">):</span>
</span><span id="optimize_alpha-198"><a href="#optimize_alpha-198"><span class="linenos">198</span></a>
</span><span id="optimize_alpha-199"><a href="#optimize_alpha-199"><span class="linenos">199</span></a>            <span class="n">cv_adata</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">cv_adata</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">)</span>
</span><span id="optimize_alpha-200"><a href="#optimize_alpha-200"><span class="linenos">200</span></a>            <span class="n">_</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">cv_adata</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="p">])</span>
</span><span id="optimize_alpha-201"><a href="#optimize_alpha-201"><span class="linenos">201</span></a>            <span class="n">metric_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
</span><span id="optimize_alpha-202"><a href="#optimize_alpha-202"><span class="linenos">202</span></a>
</span><span id="optimize_alpha-203"><a href="#optimize_alpha-203"><span class="linenos">203</span></a>            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="optimize_alpha-204"><a href="#optimize_alpha-204"><span class="linenos">204</span></a>
</span><span id="optimize_alpha-205"><a href="#optimize_alpha-205"><span class="linenos">205</span></a>        <span class="k">del</span> <span class="n">cv_adata</span>
</span><span id="optimize_alpha-206"><a href="#optimize_alpha-206"><span class="linenos">206</span></a>        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="optimize_alpha-207"><a href="#optimize_alpha-207"><span class="linenos">207</span></a>        
</span><span id="optimize_alpha-208"><a href="#optimize_alpha-208"><span class="linenos">208</span></a>    <span class="c1"># Take AUROC mean across the k folds to find alpha yielding highest AUROC</span>
</span><span id="optimize_alpha-209"><a href="#optimize_alpha-209"><span class="linenos">209</span></a>    <span class="n">alpha_star</span> <span class="o">=</span> <span class="n">alpha_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">metric_array</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))]</span>
</span><span id="optimize_alpha-210"><a href="#optimize_alpha-210"><span class="linenos">210</span></a>    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="optimize_alpha-211"><a href="#optimize_alpha-211"><span class="linenos">211</span></a>    
</span><span id="optimize_alpha-212"><a href="#optimize_alpha-212"><span class="linenos">212</span></a>
</span><span id="optimize_alpha-213"><a href="#optimize_alpha-213"><span class="linenos">213</span></a>    <span class="k">return</span> <span class="n">alpha_star</span>
</span></pre></div>


            <div class="docstring"><p>Iteratively train a grouplasso model and update alpha to find the 
parameter yielding best performing sparsity. This function 
currently only works for binary experiments.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>adata</strong> : <em>AnnData</em> | <em>list[AnnData]</em></p>

<blockquote>
  <p><code>AnnData</code>(s) with <code>'Z_train'</code> and <code>'Z_test'</code> in 
      <code>adata.uns.keys()</code>.</p>
</blockquote>

<p><strong>group_size</strong> : <em>None</em> | <em>int</em></p>

<blockquote>
  <p>Argument describing how the features are grouped. If <em>None</em>, 
      `2 * adata.uns['D'] will be used. 
      For more information see 
      <a href="https://mathurinm.github.io/celer/generated/celer.GroupLasso.html">celer documentation</a>.</p>
</blockquote>

<p><strong>tfidf</strong> : <em>bool</em> </p>

<blockquote>
  <p>If <code>True</code>, TFIDF normalization will be run at each fold.</p>
</blockquote>

<p><strong>alpha_array</strong> : <em>np.ndarray</em></p>

<blockquote>
  <p>Array of all alpha values to be tested.</p>
</blockquote>

<p><strong>k</strong> : <em>int</em></p>

<blockquote>
  <p>Number of folds to perform cross validation over.</p>
</blockquote>

<p><strong>metric</strong>: <em>str</em></p>

<blockquote>
  <p>Which metric to use to optimize alpha. Options
      are <code>'AUROC'</code>, <code>'Accuracy'</code>, <code>'F1-Score'</code>, <code>'Precision'</code>, and 
      <code>'Recall'</code></p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>alpha_star</strong> : <em>int</em></p>

<blockquote>
  <p>The best performing alpha value from cross validation on 
      training data.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">alpha_star</span> <span class="o">=</span> <span class="n"><a href="scmkl/optimize_alpha.html">scmkl.optimize_alpha</a></span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">alpha_star</span>
<span class="go">0.1</span>
</code></pre>
</div>
</div>


                </section>
                <section id="optimize_sparsity">
                            <input id="optimize_sparsity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">optimize_sparsity</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">adata</span>,</span><span class="param">	<span class="n">group_size</span>,</span><span class="param">	<span class="n">starting_alpha</span><span class="o">=</span><span class="mf">1.9</span>,</span><span class="param">	<span class="n">increment</span><span class="o">=</span><span class="mf">0.2</span>,</span><span class="param">	<span class="n">target</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">n_iter</span><span class="o">=</span><span class="mi">10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="optimize_sparsity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#optimize_sparsity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="optimize_sparsity-8"><a href="#optimize_sparsity-8"><span class="linenos">  8</span></a><span class="k">def</span> <span class="nf">optimize_sparsity</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">starting_alpha</span> <span class="o">=</span> <span class="mf">1.9</span><span class="p">,</span> 
</span><span id="optimize_sparsity-9"><a href="#optimize_sparsity-9"><span class="linenos">  9</span></a>                      <span class="n">increment</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_iter</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
</span><span id="optimize_sparsity-10"><a href="#optimize_sparsity-10"><span class="linenos"> 10</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="optimize_sparsity-11"><a href="#optimize_sparsity-11"><span class="linenos"> 11</span></a><span class="sd">    Iteratively train a grouplasso model and update alpha to find the </span>
</span><span id="optimize_sparsity-12"><a href="#optimize_sparsity-12"><span class="linenos"> 12</span></a><span class="sd">    parameter yielding the desired sparsity.</span>
</span><span id="optimize_sparsity-13"><a href="#optimize_sparsity-13"><span class="linenos"> 13</span></a><span class="sd">    </span>
</span><span id="optimize_sparsity-14"><a href="#optimize_sparsity-14"><span class="linenos"> 14</span></a><span class="sd">    Parameters</span>
</span><span id="optimize_sparsity-15"><a href="#optimize_sparsity-15"><span class="linenos"> 15</span></a><span class="sd">    ----------</span>
</span><span id="optimize_sparsity-16"><a href="#optimize_sparsity-16"><span class="linenos"> 16</span></a><span class="sd">    **adata** : *AnnData*</span>
</span><span id="optimize_sparsity-17"><a href="#optimize_sparsity-17"><span class="linenos"> 17</span></a><span class="sd">        &gt; `AnnData` with `&#39;Z_train&#39;` and `&#39;Z_test&#39;` in </span>
</span><span id="optimize_sparsity-18"><a href="#optimize_sparsity-18"><span class="linenos"> 18</span></a><span class="sd">        `adata.uns.keys()`.</span>
</span><span id="optimize_sparsity-19"><a href="#optimize_sparsity-19"><span class="linenos"> 19</span></a>
</span><span id="optimize_sparsity-20"><a href="#optimize_sparsity-20"><span class="linenos"> 20</span></a><span class="sd">    **group_size** : *int* </span>
</span><span id="optimize_sparsity-21"><a href="#optimize_sparsity-21"><span class="linenos"> 21</span></a><span class="sd">        &gt; Argument describing how the features are grouped. Should be</span>
</span><span id="optimize_sparsity-22"><a href="#optimize_sparsity-22"><span class="linenos"> 22</span></a><span class="sd">        `2 * D`. For more information see celer documentation.</span>
</span><span id="optimize_sparsity-23"><a href="#optimize_sparsity-23"><span class="linenos"> 23</span></a>
</span><span id="optimize_sparsity-24"><a href="#optimize_sparsity-24"><span class="linenos"> 24</span></a><span class="sd">    **starting_alpha** : *float*</span>
</span><span id="optimize_sparsity-25"><a href="#optimize_sparsity-25"><span class="linenos"> 25</span></a><span class="sd">        &gt; The alpha value to start the search at.</span>
</span><span id="optimize_sparsity-26"><a href="#optimize_sparsity-26"><span class="linenos"> 26</span></a><span class="sd">    </span>
</span><span id="optimize_sparsity-27"><a href="#optimize_sparsity-27"><span class="linenos"> 27</span></a><span class="sd">    **increment** : *float* </span>
</span><span id="optimize_sparsity-28"><a href="#optimize_sparsity-28"><span class="linenos"> 28</span></a><span class="sd">        &gt; Amount to adjust alpha by between iterations.</span>
</span><span id="optimize_sparsity-29"><a href="#optimize_sparsity-29"><span class="linenos"> 29</span></a><span class="sd">    </span>
</span><span id="optimize_sparsity-30"><a href="#optimize_sparsity-30"><span class="linenos"> 30</span></a><span class="sd">    **target** : *int*</span>
</span><span id="optimize_sparsity-31"><a href="#optimize_sparsity-31"><span class="linenos"> 31</span></a><span class="sd">        &gt; The desired number of groups selected by the model.</span>
</span><span id="optimize_sparsity-32"><a href="#optimize_sparsity-32"><span class="linenos"> 32</span></a>
</span><span id="optimize_sparsity-33"><a href="#optimize_sparsity-33"><span class="linenos"> 33</span></a><span class="sd">    **n_iter** : *int*</span>
</span><span id="optimize_sparsity-34"><a href="#optimize_sparsity-34"><span class="linenos"> 34</span></a><span class="sd">        &gt; The maximum number of iterations to run.</span>
</span><span id="optimize_sparsity-35"><a href="#optimize_sparsity-35"><span class="linenos"> 35</span></a><span class="sd">            </span>
</span><span id="optimize_sparsity-36"><a href="#optimize_sparsity-36"><span class="linenos"> 36</span></a><span class="sd">    Returns</span>
</span><span id="optimize_sparsity-37"><a href="#optimize_sparsity-37"><span class="linenos"> 37</span></a><span class="sd">    -------</span>
</span><span id="optimize_sparsity-38"><a href="#optimize_sparsity-38"><span class="linenos"> 38</span></a><span class="sd">    **sparsity_dict** : *dict*</span>
</span><span id="optimize_sparsity-39"><a href="#optimize_sparsity-39"><span class="linenos"> 39</span></a><span class="sd">        &gt; Tested alpha as keys and the number of selected pathways as </span>
</span><span id="optimize_sparsity-40"><a href="#optimize_sparsity-40"><span class="linenos"> 40</span></a><span class="sd">        the values.</span>
</span><span id="optimize_sparsity-41"><a href="#optimize_sparsity-41"><span class="linenos"> 41</span></a><span class="sd">        </span>
</span><span id="optimize_sparsity-42"><a href="#optimize_sparsity-42"><span class="linenos"> 42</span></a><span class="sd">    **alpha** : *float*</span>
</span><span id="optimize_sparsity-43"><a href="#optimize_sparsity-43"><span class="linenos"> 43</span></a><span class="sd">        &gt;The alpha value yielding the number of selected groups closest </span>
</span><span id="optimize_sparsity-44"><a href="#optimize_sparsity-44"><span class="linenos"> 44</span></a><span class="sd">        to the target.</span>
</span><span id="optimize_sparsity-45"><a href="#optimize_sparsity-45"><span class="linenos"> 45</span></a>
</span><span id="optimize_sparsity-46"><a href="#optimize_sparsity-46"><span class="linenos"> 46</span></a><span class="sd">    Examples</span>
</span><span id="optimize_sparsity-47"><a href="#optimize_sparsity-47"><span class="linenos"> 47</span></a><span class="sd">    --------</span>
</span><span id="optimize_sparsity-48"><a href="#optimize_sparsity-48"><span class="linenos"> 48</span></a><span class="sd">    &gt;&gt;&gt; sparcity_dict, alpha = scmkl.optimize_sparsity(adata, (2 * D), </span>
</span><span id="optimize_sparsity-49"><a href="#optimize_sparsity-49"><span class="linenos"> 49</span></a><span class="sd">    ...                                                target = 1)</span>
</span><span id="optimize_sparsity-50"><a href="#optimize_sparsity-50"><span class="linenos"> 50</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="optimize_sparsity-51"><a href="#optimize_sparsity-51"><span class="linenos"> 51</span></a><span class="sd">    &gt;&gt;&gt; alpha</span>
</span><span id="optimize_sparsity-52"><a href="#optimize_sparsity-52"><span class="linenos"> 52</span></a><span class="sd">    0.01</span>
</span><span id="optimize_sparsity-53"><a href="#optimize_sparsity-53"><span class="linenos"> 53</span></a>
</span><span id="optimize_sparsity-54"><a href="#optimize_sparsity-54"><span class="linenos"> 54</span></a><span class="sd">    See Also</span>
</span><span id="optimize_sparsity-55"><a href="#optimize_sparsity-55"><span class="linenos"> 55</span></a><span class="sd">    --------</span>
</span><span id="optimize_sparsity-56"><a href="#optimize_sparsity-56"><span class="linenos"> 56</span></a><span class="sd">    celer.GroupLasso : </span>
</span><span id="optimize_sparsity-57"><a href="#optimize_sparsity-57"><span class="linenos"> 57</span></a><span class="sd">    https://mathurinm.github.io/celer/generated/celer.GroupLasso.html</span>
</span><span id="optimize_sparsity-58"><a href="#optimize_sparsity-58"><span class="linenos"> 58</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="optimize_sparsity-59"><a href="#optimize_sparsity-59"><span class="linenos"> 59</span></a>    <span class="k">assert</span> <span class="n">increment</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">increment</span> <span class="o">&lt;</span> <span class="n">starting_alpha</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Choose a positive &quot;</span>
</span><span id="optimize_sparsity-60"><a href="#optimize_sparsity-60"><span class="linenos"> 60</span></a>                                                          <span class="s2">&quot;increment less &quot;</span>
</span><span id="optimize_sparsity-61"><a href="#optimize_sparsity-61"><span class="linenos"> 61</span></a>                                                          <span class="s2">&quot;than alpha&quot;</span><span class="p">)</span>
</span><span id="optimize_sparsity-62"><a href="#optimize_sparsity-62"><span class="linenos"> 62</span></a>    <span class="k">assert</span> <span class="n">target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Choose an integer &quot;</span>
</span><span id="optimize_sparsity-63"><a href="#optimize_sparsity-63"><span class="linenos"> 63</span></a>                                                    <span class="s2">&quot;target number of groups &quot;</span>
</span><span id="optimize_sparsity-64"><a href="#optimize_sparsity-64"><span class="linenos"> 64</span></a>                                                     <span class="s2">&quot;that is greater than 0&quot;</span><span class="p">)</span>
</span><span id="optimize_sparsity-65"><a href="#optimize_sparsity-65"><span class="linenos"> 65</span></a>    <span class="k">assert</span> <span class="n">n_iter</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_iter</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Choose an integer &quot;</span>
</span><span id="optimize_sparsity-66"><a href="#optimize_sparsity-66"><span class="linenos"> 66</span></a>                                                    <span class="s2">&quot;number of iterations &quot;</span>
</span><span id="optimize_sparsity-67"><a href="#optimize_sparsity-67"><span class="linenos"> 67</span></a>                                                    <span class="s2">&quot;that is greater than 0&quot;</span><span class="p">)</span>
</span><span id="optimize_sparsity-68"><a href="#optimize_sparsity-68"><span class="linenos"> 68</span></a>
</span><span id="optimize_sparsity-69"><a href="#optimize_sparsity-69"><span class="linenos"> 69</span></a>    <span class="n">sparsity_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="optimize_sparsity-70"><a href="#optimize_sparsity-70"><span class="linenos"> 70</span></a>    <span class="n">alpha</span> <span class="o">=</span> <span class="n">starting_alpha</span>
</span><span id="optimize_sparsity-71"><a href="#optimize_sparsity-71"><span class="linenos"> 71</span></a>
</span><span id="optimize_sparsity-72"><a href="#optimize_sparsity-72"><span class="linenos"> 72</span></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
</span><span id="optimize_sparsity-73"><a href="#optimize_sparsity-73"><span class="linenos"> 73</span></a>        <span class="n">adata</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
</span><span id="optimize_sparsity-74"><a href="#optimize_sparsity-74"><span class="linenos"> 74</span></a>        <span class="n">num_selected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">find_selected_groups</span><span class="p">(</span><span class="n">adata</span><span class="p">))</span>
</span><span id="optimize_sparsity-75"><a href="#optimize_sparsity-75"><span class="linenos"> 75</span></a>
</span><span id="optimize_sparsity-76"><a href="#optimize_sparsity-76"><span class="linenos"> 76</span></a>        <span class="n">sparsity_dict</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span> <span class="o">=</span> <span class="n">num_selected</span>
</span><span id="optimize_sparsity-77"><a href="#optimize_sparsity-77"><span class="linenos"> 77</span></a>
</span><span id="optimize_sparsity-78"><a href="#optimize_sparsity-78"><span class="linenos"> 78</span></a>        <span class="k">if</span> <span class="n">num_selected</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
</span><span id="optimize_sparsity-79"><a href="#optimize_sparsity-79"><span class="linenos"> 79</span></a>            <span class="c1">#Decreasing alpha will increase the number of selected pathways</span>
</span><span id="optimize_sparsity-80"><a href="#optimize_sparsity-80"><span class="linenos"> 80</span></a>            <span class="k">if</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">increment</span> <span class="ow">in</span> <span class="n">sparsity_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="optimize_sparsity-81"><a href="#optimize_sparsity-81"><span class="linenos"> 81</span></a>                <span class="c1"># Make increment smaller so the model can&#39;t go back and forth </span>
</span><span id="optimize_sparsity-82"><a href="#optimize_sparsity-82"><span class="linenos"> 82</span></a>                <span class="c1"># between alpha values</span>
</span><span id="optimize_sparsity-83"><a href="#optimize_sparsity-83"><span class="linenos"> 83</span></a>                <span class="n">increment</span> <span class="o">/=</span> <span class="mi">2</span>
</span><span id="optimize_sparsity-84"><a href="#optimize_sparsity-84"><span class="linenos"> 84</span></a>            <span class="c1"># Ensures that alpha will never be negative</span>
</span><span id="optimize_sparsity-85"><a href="#optimize_sparsity-85"><span class="linenos"> 85</span></a>            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">increment</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">])</span> 
</span><span id="optimize_sparsity-86"><a href="#optimize_sparsity-86"><span class="linenos"> 86</span></a>
</span><span id="optimize_sparsity-87"><a href="#optimize_sparsity-87"><span class="linenos"> 87</span></a>        <span class="k">elif</span> <span class="n">num_selected</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
</span><span id="optimize_sparsity-88"><a href="#optimize_sparsity-88"><span class="linenos"> 88</span></a>            <span class="k">if</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">increment</span> <span class="ow">in</span> <span class="n">sparsity_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="optimize_sparsity-89"><a href="#optimize_sparsity-89"><span class="linenos"> 89</span></a>                <span class="n">increment</span> <span class="o">/=</span> <span class="mi">2</span>
</span><span id="optimize_sparsity-90"><a href="#optimize_sparsity-90"><span class="linenos"> 90</span></a>
</span><span id="optimize_sparsity-91"><a href="#optimize_sparsity-91"><span class="linenos"> 91</span></a>            <span class="n">alpha</span> <span class="o">+=</span> <span class="n">increment</span>
</span><span id="optimize_sparsity-92"><a href="#optimize_sparsity-92"><span class="linenos"> 92</span></a>        <span class="k">elif</span> <span class="n">num_selected</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
</span><span id="optimize_sparsity-93"><a href="#optimize_sparsity-93"><span class="linenos"> 93</span></a>            <span class="k">break</span>
</span><span id="optimize_sparsity-94"><a href="#optimize_sparsity-94"><span class="linenos"> 94</span></a>
</span><span id="optimize_sparsity-95"><a href="#optimize_sparsity-95"><span class="linenos"> 95</span></a>    <span class="c1"># Find the alpha that minimizes the difference between target and observed</span>
</span><span id="optimize_sparsity-96"><a href="#optimize_sparsity-96"><span class="linenos"> 96</span></a>    <span class="c1"># number of selected groups</span>
</span><span id="optimize_sparsity-97"><a href="#optimize_sparsity-97"><span class="linenos"> 97</span></a>    <span class="n">spar_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">selected</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> 
</span><span id="optimize_sparsity-98"><a href="#optimize_sparsity-98"><span class="linenos"> 98</span></a>                          <span class="k">for</span> <span class="n">selected</span> <span class="ow">in</span> <span class="n">sparsity_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
</span><span id="optimize_sparsity-99"><a href="#optimize_sparsity-99"><span class="linenos"> 99</span></a>    <span class="n">optimal_alpha</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sparsity_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">spar_idx</span><span class="p">]</span>
</span><span id="optimize_sparsity-100"><a href="#optimize_sparsity-100"><span class="linenos">100</span></a>    <span class="k">return</span> <span class="n">sparsity_dict</span><span class="p">,</span> <span class="n">optimal_alpha</span>
</span></pre></div>


            <div class="docstring"><p>Iteratively train a grouplasso model and update alpha to find the 
parameter yielding the desired sparsity.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>adata</strong> : <em>AnnData</em></p>

<blockquote>
  <p><code>AnnData</code> with <code>'Z_train'</code> and <code>'Z_test'</code> in 
      <code>adata.uns.keys()</code>.</p>
</blockquote>

<p><strong>group_size</strong> : <em>int</em> </p>

<blockquote>
  <p>Argument describing how the features are grouped. Should be
      <code>2 * D</code>. For more information see celer documentation.</p>
</blockquote>

<p><strong>starting_alpha</strong> : <em>float</em></p>

<blockquote>
  <p>The alpha value to start the search at.</p>
</blockquote>

<p><strong>increment</strong> : <em>float</em> </p>

<blockquote>
  <p>Amount to adjust alpha by between iterations.</p>
</blockquote>

<p><strong>target</strong> : <em>int</em></p>

<blockquote>
  <p>The desired number of groups selected by the model.</p>
</blockquote>

<p><strong>n_iter</strong> : <em>int</em></p>

<blockquote>
  <p>The maximum number of iterations to run.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>sparsity_dict</strong> : <em>dict</em></p>

<blockquote>
  <p>Tested alpha as keys and the number of selected pathways as 
      the values.</p>
</blockquote>

<p><strong>alpha</strong> : <em>float</em></p>

<blockquote>
  <p>The alpha value yielding the number of selected groups closest 
      to the target.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">sparcity_dict</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n"><a href="scmkl/optimize_sparsity.html">scmkl.optimize_sparsity</a></span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D</span><span class="p">),</span> 
<span class="gp">... </span>                                               <span class="n">target</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">alpha</span>
<span class="go">0.01</span>
</code></pre>
</div>

<h2 id="see-also">See Also</h2>

<p>celer.GroupLasso : 
<a href="https://mathurinm.github.io/celer/generated/celer.GroupLasso.html">https://mathurinm.github.io/celer/generated/celer.GroupLasso.html</a></p>
</div>


                </section>
                <section id="run">
                            <input id="run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">adata</span><span class="p">:</span> <span class="n">anndata</span><span class="o">.</span><span class="n">_core</span><span class="o">.</span><span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span>,</span><span class="param">	<span class="n">alpha_list</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">metrics</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">return_probs</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="run-11"><a href="#run-11"><span class="linenos"> 11</span></a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">adata</span> <span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span> <span class="n">alpha_list</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
</span><span id="run-12"><a href="#run-12"><span class="linenos"> 12</span></a>        <span class="n">metrics</span> <span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_probs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="run-13"><a href="#run-13"><span class="linenos"> 13</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="run-14"><a href="#run-14"><span class="linenos"> 14</span></a><span class="sd">    Wrapper function for training and test with multiple alpha values.</span>
</span><span id="run-15"><a href="#run-15"><span class="linenos"> 15</span></a><span class="sd">    Returns metrics, predictions, group weights, and resource usage.</span>
</span><span id="run-16"><a href="#run-16"><span class="linenos"> 16</span></a>
</span><span id="run-17"><a href="#run-17"><span class="linenos"> 17</span></a><span class="sd">    Parameters</span>
</span><span id="run-18"><a href="#run-18"><span class="linenos"> 18</span></a><span class="sd">    ----------</span>
</span><span id="run-19"><a href="#run-19"><span class="linenos"> 19</span></a><span class="sd">    **adata** : *AnnData* </span>
</span><span id="run-20"><a href="#run-20"><span class="linenos"> 20</span></a><span class="sd">        &gt; A processed *AnnData* with `&#39;Z_train&#39;`, `&#39;Z_test&#39;`, and </span>
</span><span id="run-21"><a href="#run-21"><span class="linenos"> 21</span></a><span class="sd">        `&#39;group_dict&#39;` keys in `adata.uns`.</span>
</span><span id="run-22"><a href="#run-22"><span class="linenos"> 22</span></a><span class="sd">    </span>
</span><span id="run-23"><a href="#run-23"><span class="linenos"> 23</span></a><span class="sd">    **alpha_list** : *np.ndarray* </span>
</span><span id="run-24"><a href="#run-24"><span class="linenos"> 24</span></a><span class="sd">        &gt; `alpha` values to create models using. Alpha refers to the </span>
</span><span id="run-25"><a href="#run-25"><span class="linenos"> 25</span></a><span class="sd">        penalty parameter in Group Lasso. Larger alphas force group </span>
</span><span id="run-26"><a href="#run-26"><span class="linenos"> 26</span></a><span class="sd">        weights to shrink towards 0 while smaller alphas apply a lesser </span>
</span><span id="run-27"><a href="#run-27"><span class="linenos"> 27</span></a><span class="sd">        penalty to kernal weights.</span>
</span><span id="run-28"><a href="#run-28"><span class="linenos"> 28</span></a>
</span><span id="run-29"><a href="#run-29"><span class="linenos"> 29</span></a><span class="sd">    **metrics** : *list[str]*</span>
</span><span id="run-30"><a href="#run-30"><span class="linenos"> 30</span></a><span class="sd">        &gt; What metrics should be calculated on predictions. Options are </span>
</span><span id="run-31"><a href="#run-31"><span class="linenos"> 31</span></a><span class="sd">        [&#39;AUROC&#39;, &#39;F1-Score&#39;, &#39;Accuracy&#39;, &#39;Precision&#39;, &#39;Recall&#39;]. When </span>
</span><span id="run-32"><a href="#run-32"><span class="linenos"> 32</span></a><span class="sd">        set to `None`, all metrics are calculated.</span>
</span><span id="run-33"><a href="#run-33"><span class="linenos"> 33</span></a><span class="sd">    </span>
</span><span id="run-34"><a href="#run-34"><span class="linenos"> 34</span></a><span class="sd">    Returns</span>
</span><span id="run-35"><a href="#run-35"><span class="linenos"> 35</span></a><span class="sd">    -------</span>
</span><span id="run-36"><a href="#run-36"><span class="linenos"> 36</span></a><span class="sd">    **results** : *dict*</span>
</span><span id="run-37"><a href="#run-37"><span class="linenos"> 37</span></a><span class="sd">    &gt; With keys and values: </span>
</span><span id="run-38"><a href="#run-38"><span class="linenos"> 38</span></a>
</span><span id="run-39"><a href="#run-39"><span class="linenos"> 39</span></a><span class="sd">    &gt; `&#39;Metrics&#39;` : a nested dictionary as `[alpha][metric]` = value.</span>
</span><span id="run-40"><a href="#run-40"><span class="linenos"> 40</span></a><span class="sd">    </span>
</span><span id="run-41"><a href="#run-41"><span class="linenos"> 41</span></a><span class="sd">    &gt; `&#39;Selected_groups&#39;` : a dictionary as `[alpha]` = array of </span>
</span><span id="run-42"><a href="#run-42"><span class="linenos"> 42</span></a><span class="sd">        groups with nonzero weights.</span>
</span><span id="run-43"><a href="#run-43"><span class="linenos"> 43</span></a>
</span><span id="run-44"><a href="#run-44"><span class="linenos"> 44</span></a><span class="sd">    &gt; `&#39;Norms&#39;` : a dictionary as `[alpha]` = array of kernel weights</span>
</span><span id="run-45"><a href="#run-45"><span class="linenos"> 45</span></a><span class="sd">        for each group, order respective to &#39;Group_names&#39;.</span>
</span><span id="run-46"><a href="#run-46"><span class="linenos"> 46</span></a>
</span><span id="run-47"><a href="#run-47"><span class="linenos"> 47</span></a><span class="sd">    &gt; `&#39;Predictions&#39;` : a dictionary as `[alpha]` = predicted class</span>
</span><span id="run-48"><a href="#run-48"><span class="linenos"> 48</span></a><span class="sd">        respective to &#39;Observations&#39; for that `alpha`.</span>
</span><span id="run-49"><a href="#run-49"><span class="linenos"> 49</span></a>
</span><span id="run-50"><a href="#run-50"><span class="linenos"> 50</span></a><span class="sd">    &gt; `&#39;Observed&#39;` : an array of ground truth cell labels from the</span>
</span><span id="run-51"><a href="#run-51"><span class="linenos"> 51</span></a><span class="sd">        test set.</span>
</span><span id="run-52"><a href="#run-52"><span class="linenos"> 52</span></a>
</span><span id="run-53"><a href="#run-53"><span class="linenos"> 53</span></a><span class="sd">    &gt; `&#39;Test_indices&#39;` : indices of samples respective to adata </span>
</span><span id="run-54"><a href="#run-54"><span class="linenos"> 54</span></a><span class="sd">        used in the training set.</span>
</span><span id="run-55"><a href="#run-55"><span class="linenos"> 55</span></a>
</span><span id="run-56"><a href="#run-56"><span class="linenos"> 56</span></a><span class="sd">    &gt; `&#39;Group_names&#39;` : an array of group names respective to each</span>
</span><span id="run-57"><a href="#run-57"><span class="linenos"> 57</span></a><span class="sd">        array in &#39;Norms&#39;.</span>
</span><span id="run-58"><a href="#run-58"><span class="linenos"> 58</span></a>
</span><span id="run-59"><a href="#run-59"><span class="linenos"> 59</span></a><span class="sd">    &gt; `&#39;Model&#39;` : a dictionary where `[alpha]` = Celer Group Lasso</span>
</span><span id="run-60"><a href="#run-60"><span class="linenos"> 60</span></a><span class="sd">        object for that `alpha`.</span>
</span><span id="run-61"><a href="#run-61"><span class="linenos"> 61</span></a>
</span><span id="run-62"><a href="#run-62"><span class="linenos"> 62</span></a><span class="sd">    &gt; `&#39;RAM_usage&#39;` : memory usage after training models for each </span>
</span><span id="run-63"><a href="#run-63"><span class="linenos"> 63</span></a><span class="sd">        `alpha`.</span>
</span><span id="run-64"><a href="#run-64"><span class="linenos"> 64</span></a>
</span><span id="run-65"><a href="#run-65"><span class="linenos"> 65</span></a><span class="sd">    Examples</span>
</span><span id="run-66"><a href="#run-66"><span class="linenos"> 66</span></a><span class="sd">    --------</span>
</span><span id="run-67"><a href="#run-67"><span class="linenos"> 67</span></a><span class="sd">    &gt;&gt;&gt; results = scmkl.run(adata = adata, </span>
</span><span id="run-68"><a href="#run-68"><span class="linenos"> 68</span></a><span class="sd">    ...                     alpha_list = np.array([0.05, 0.1, 0.5]))</span>
</span><span id="run-69"><a href="#run-69"><span class="linenos"> 69</span></a><span class="sd">    &gt;&gt;&gt; results</span>
</span><span id="run-70"><a href="#run-70"><span class="linenos"> 70</span></a><span class="sd">    dict_keys([&#39;Metrics&#39;, &#39;Selected_groups&#39;, &#39;Norms&#39;, &#39;Predictions&#39;, </span>
</span><span id="run-71"><a href="#run-71"><span class="linenos"> 71</span></a><span class="sd">    ...        &#39;Observed&#39;, &#39;Test_indices&#39;, &#39;Group_names&#39;, &#39;Models&#39;, </span>
</span><span id="run-72"><a href="#run-72"><span class="linenos"> 72</span></a><span class="sd">    ...        &#39;Train_time&#39;, &#39;RAM_usage&#39;])</span>
</span><span id="run-73"><a href="#run-73"><span class="linenos"> 73</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="run-74"><a href="#run-74"><span class="linenos"> 74</span></a><span class="sd">    &gt;&gt;&gt; # List of alpha values</span>
</span><span id="run-75"><a href="#run-75"><span class="linenos"> 75</span></a><span class="sd">    &gt;&gt;&gt; results[&#39;Metrics&#39;].keys()</span>
</span><span id="run-76"><a href="#run-76"><span class="linenos"> 76</span></a><span class="sd">    dict_keys([0.05, 0.1, 0.5])</span>
</span><span id="run-77"><a href="#run-77"><span class="linenos"> 77</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="run-78"><a href="#run-78"><span class="linenos"> 78</span></a><span class="sd">    &gt;&gt;&gt; results[&#39;Metrics&#39;][0.05]</span>
</span><span id="run-79"><a href="#run-79"><span class="linenos"> 79</span></a><span class="sd">    {&#39;AUROC&#39;: 0.9859,</span>
</span><span id="run-80"><a href="#run-80"><span class="linenos"> 80</span></a><span class="sd">    &#39;Accuracy&#39;: 0.945,</span>
</span><span id="run-81"><a href="#run-81"><span class="linenos"> 81</span></a><span class="sd">    &#39;F1-Score&#39;: 0.9452736318407959,</span>
</span><span id="run-82"><a href="#run-82"><span class="linenos"> 82</span></a><span class="sd">    &#39;Precision&#39;: 0.9405940594059405,</span>
</span><span id="run-83"><a href="#run-83"><span class="linenos"> 83</span></a><span class="sd">    &#39;Recall&#39;: 0.95}</span>
</span><span id="run-84"><a href="#run-84"><span class="linenos"> 84</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="run-85"><a href="#run-85"><span class="linenos"> 85</span></a>    <span class="k">if</span> <span class="n">metrics</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run-86"><a href="#run-86"><span class="linenos"> 86</span></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AUROC&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">]</span>
</span><span id="run-87"><a href="#run-87"><span class="linenos"> 87</span></a>
</span><span id="run-88"><a href="#run-88"><span class="linenos"> 88</span></a>    <span class="c1"># Initializing variables to capture metrics</span>
</span><span id="run-89"><a href="#run-89"><span class="linenos"> 89</span></a>    <span class="n">group_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;group_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="run-90"><a href="#run-90"><span class="linenos"> 90</span></a>    <span class="n">preds</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="run-91"><a href="#run-91"><span class="linenos"> 91</span></a>    <span class="n">group_norms</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="run-92"><a href="#run-92"><span class="linenos"> 92</span></a>    <span class="n">mets_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="run-93"><a href="#run-93"><span class="linenos"> 93</span></a>    <span class="n">selected_groups</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="run-94"><a href="#run-94"><span class="linenos"> 94</span></a>    <span class="n">train_time</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="run-95"><a href="#run-95"><span class="linenos"> 95</span></a>    <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="run-96"><a href="#run-96"><span class="linenos"> 96</span></a>    <span class="n">probs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="run-97"><a href="#run-97"><span class="linenos"> 97</span></a>
</span><span id="run-98"><a href="#run-98"><span class="linenos"> 98</span></a>    <span class="n">D</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
</span><span id="run-99"><a href="#run-99"><span class="linenos"> 99</span></a>
</span><span id="run-100"><a href="#run-100"><span class="linenos">100</span></a>    <span class="c1"># Generating models for each alpha and outputs</span>
</span><span id="run-101"><a href="#run-101"><span class="linenos">101</span></a>    <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alpha_list</span><span class="p">:</span>
</span><span id="run-102"><a href="#run-102"><span class="linenos">102</span></a>        
</span><span id="run-103"><a href="#run-103"><span class="linenos">103</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Evaluating model. Alpha: </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="run-104"><a href="#run-104"><span class="linenos">104</span></a>
</span><span id="run-105"><a href="#run-105"><span class="linenos">105</span></a>        <span class="n">train_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="run-106"><a href="#run-106"><span class="linenos">106</span></a>
</span><span id="run-107"><a href="#run-107"><span class="linenos">107</span></a>        <span class="n">adata</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group_size</span><span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">)</span>
</span><span id="run-108"><a href="#run-108"><span class="linenos">108</span></a>
</span><span id="run-109"><a href="#run-109"><span class="linenos">109</span></a>        <span class="k">if</span> <span class="n">return_probs</span><span class="p">:</span>
</span><span id="run-110"><a href="#run-110"><span class="linenos">110</span></a>            <span class="n">alpha_res</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> 
</span><span id="run-111"><a href="#run-111"><span class="linenos">111</span></a>                                <span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">,</span>
</span><span id="run-112"><a href="#run-112"><span class="linenos">112</span></a>                                <span class="n">return_probs</span> <span class="o">=</span> <span class="n">return_probs</span><span class="p">)</span>
</span><span id="run-113"><a href="#run-113"><span class="linenos">113</span></a>            <span class="n">preds</span><span class="p">[</span><span class="n">alpha</span><span class="p">],</span> <span class="n">mets_dict</span><span class="p">[</span><span class="n">alpha</span><span class="p">],</span> <span class="n">probs</span><span class="p">[</span><span class="n">alpha</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_res</span>
</span><span id="run-114"><a href="#run-114"><span class="linenos">114</span></a>
</span><span id="run-115"><a href="#run-115"><span class="linenos">115</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="run-116"><a href="#run-116"><span class="linenos">116</span></a>            <span class="n">alpha_res</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> 
</span><span id="run-117"><a href="#run-117"><span class="linenos">117</span></a>                                <span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">,</span>
</span><span id="run-118"><a href="#run-118"><span class="linenos">118</span></a>                                <span class="n">return_probs</span> <span class="o">=</span> <span class="n">return_probs</span><span class="p">)</span>
</span><span id="run-119"><a href="#run-119"><span class="linenos">119</span></a>            <span class="n">preds</span><span class="p">[</span><span class="n">alpha</span><span class="p">],</span> <span class="n">mets_dict</span><span class="p">[</span><span class="n">alpha</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_res</span>
</span><span id="run-120"><a href="#run-120"><span class="linenos">120</span></a>
</span><span id="run-121"><a href="#run-121"><span class="linenos">121</span></a>        <span class="n">selected_groups</span><span class="p">[</span><span class="n">alpha</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_selected_groups</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</span><span id="run-122"><a href="#run-122"><span class="linenos">122</span></a>
</span><span id="run-123"><a href="#run-123"><span class="linenos">123</span></a>        <span class="n">kernel_weights</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span>
</span><span id="run-124"><a href="#run-124"><span class="linenos">124</span></a>        <span class="n">group_norms</span><span class="p">[</span><span class="n">alpha</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="run-125"><a href="#run-125"><span class="linenos">125</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">kernel_weights</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">D</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">D</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="run-126"><a href="#run-126"><span class="linenos">126</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_names</span><span class="p">))</span>
</span><span id="run-127"><a href="#run-127"><span class="linenos">127</span></a>            <span class="p">]</span>
</span><span id="run-128"><a href="#run-128"><span class="linenos">128</span></a>        
</span><span id="run-129"><a href="#run-129"><span class="linenos">129</span></a>        <span class="n">models</span><span class="p">[</span><span class="n">alpha</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
</span><span id="run-130"><a href="#run-130"><span class="linenos">130</span></a>        
</span><span id="run-131"><a href="#run-131"><span class="linenos">131</span></a>        <span class="n">train_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="run-132"><a href="#run-132"><span class="linenos">132</span></a>        <span class="n">train_time</span><span class="p">[</span><span class="n">alpha</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_end</span> <span class="o">-</span> <span class="n">train_start</span>
</span><span id="run-133"><a href="#run-133"><span class="linenos">133</span></a>
</span><span id="run-134"><a href="#run-134"><span class="linenos">134</span></a>    <span class="c1"># Combining results into one object</span>
</span><span id="run-135"><a href="#run-135"><span class="linenos">135</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="run-136"><a href="#run-136"><span class="linenos">136</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mets_dict</span>
</span><span id="run-137"><a href="#run-137"><span class="linenos">137</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Selected_groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_groups</span>
</span><span id="run-138"><a href="#run-138"><span class="linenos">138</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Norms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_norms</span>
</span><span id="run-139"><a href="#run-139"><span class="linenos">139</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Predictions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>
</span><span id="run-140"><a href="#run-140"><span class="linenos">140</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Observed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]]</span>
</span><span id="run-141"><a href="#run-141"><span class="linenos">141</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Test_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]</span>
</span><span id="run-142"><a href="#run-142"><span class="linenos">142</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Group_names&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">group_names</span>
</span><span id="run-143"><a href="#run-143"><span class="linenos">143</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Models&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span>
</span><span id="run-144"><a href="#run-144"><span class="linenos">144</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Train_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_time</span>
</span><span id="run-145"><a href="#run-145"><span class="linenos">145</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;RAM_usage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e9</span><span class="si">}</span><span class="s1"> GB&#39;</span>
</span><span id="run-146"><a href="#run-146"><span class="linenos">146</span></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Probabilities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs</span>
</span><span id="run-147"><a href="#run-147"><span class="linenos">147</span></a>
</span><span id="run-148"><a href="#run-148"><span class="linenos">148</span></a>    <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper function for training and test with multiple alpha values.
Returns metrics, predictions, group weights, and resource usage.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>adata</strong> : <em>AnnData</em> </p>

<blockquote>
  <p>A processed <em>AnnData</em> with <code>'Z_train'</code>, <code>'Z_test'</code>, and 
      <code>'group_dict'</code> keys in <code>adata.uns</code>.</p>
</blockquote>

<p><strong>alpha_list</strong> : <em>np.ndarray</em> </p>

<blockquote>
  <p><code>alpha</code> values to create models using. Alpha refers to the 
      penalty parameter in Group Lasso. Larger alphas force group 
      weights to shrink towards 0 while smaller alphas apply a lesser 
      penalty to kernal weights.</p>
</blockquote>

<p><strong>metrics</strong> : <em>list[str]</em></p>

<blockquote>
  <p>What metrics should be calculated on predictions. Options are 
      ['AUROC', 'F1-Score', 'Accuracy', 'Precision', 'Recall']. When 
      set to <code>None</code>, all metrics are calculated.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>results</strong> : <em>dict</em></p>

<blockquote>
  <p>With keys and values: </p>
</blockquote>

<blockquote>
  <p><code>'Metrics'</code> : a nested dictionary as <code>[alpha][metric]</code> = value.</p>
</blockquote>

<blockquote>
  <p><code>'Selected_groups'</code> : a dictionary as <code>[alpha]</code> = array of 
      groups with nonzero weights.</p>
</blockquote>

<blockquote>
  <p><code>'Norms'</code> : a dictionary as <code>[alpha]</code> = array of kernel weights
      for each group, order respective to 'Group_names'.</p>
</blockquote>

<blockquote>
  <p><code>'Predictions'</code> : a dictionary as <code>[alpha]</code> = predicted class
      respective to 'Observations' for that <code>alpha</code>.</p>
</blockquote>

<blockquote>
  <p><code>'Observed'</code> : an array of ground truth cell labels from the
      test set.</p>
</blockquote>

<blockquote>
  <p><code>'Test_indices'</code> : indices of samples respective to adata 
      used in the training set.</p>
</blockquote>

<blockquote>
  <p><code>'Group_names'</code> : an array of group names respective to each
      array in 'Norms'.</p>
</blockquote>

<blockquote>
  <p><code>'Model'</code> : a dictionary where <code>[alpha]</code> = Celer Group Lasso
      object for that <code>alpha</code>.</p>
</blockquote>

<blockquote>
  <p><code>'RAM_usage'</code> : memory usage after training models for each 
      <code>alpha</code>.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n"><a href="scmkl/run.html">scmkl.run</a></span><span class="p">(</span><span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">,</span> 
<span class="gp">... </span>                    <span class="n">alpha_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span>
<span class="go">dict_keys([&#39;Metrics&#39;, &#39;Selected_groups&#39;, &#39;Norms&#39;, &#39;Predictions&#39;, </span>
<span class="go">...        &#39;Observed&#39;, &#39;Test_indices&#39;, &#39;Group_names&#39;, &#39;Models&#39;, </span>
<span class="go">...        &#39;Train_time&#39;, &#39;RAM_usage&#39;])</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># List of alpha values</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;Metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="go">dict_keys([0.05, 0.1, 0.5])</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;Metrics&#39;</span><span class="p">][</span><span class="mf">0.05</span><span class="p">]</span>
<span class="go">{&#39;AUROC&#39;: 0.9859,</span>
<span class="go">&#39;Accuracy&#39;: 0.945,</span>
<span class="go">&#39;F1-Score&#39;: 0.9452736318407959,</span>
<span class="go">&#39;Precision&#39;: 0.9405940594059405,</span>
<span class="go">&#39;Recall&#39;: 0.95}</span>
</code></pre>
</div>
</div>


                </section>
                <section id="tfidf_normalize">
                            <input id="tfidf_normalize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tfidf_normalize</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">adata</span>, </span><span class="param"><span class="n">binarize</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="tfidf_normalize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#tfidf_normalize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="tfidf_normalize-72"><a href="#tfidf_normalize-72"><span class="linenos"> 72</span></a><span class="k">def</span> <span class="nf">tfidf_normalize</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">binarize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="tfidf_normalize-73"><a href="#tfidf_normalize-73"><span class="linenos"> 73</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="tfidf_normalize-74"><a href="#tfidf_normalize-74"><span class="linenos"> 74</span></a><span class="sd">    Function to TFIDF normalize the data in an adata object. If any </span>
</span><span id="tfidf_normalize-75"><a href="#tfidf_normalize-75"><span class="linenos"> 75</span></a><span class="sd">    rows are entirely 0, that row and its metadata will be removed from</span>
</span><span id="tfidf_normalize-76"><a href="#tfidf_normalize-76"><span class="linenos"> 76</span></a><span class="sd">    the object.</span>
</span><span id="tfidf_normalize-77"><a href="#tfidf_normalize-77"><span class="linenos"> 77</span></a>
</span><span id="tfidf_normalize-78"><a href="#tfidf_normalize-78"><span class="linenos"> 78</span></a><span class="sd">    Parameters</span>
</span><span id="tfidf_normalize-79"><a href="#tfidf_normalize-79"><span class="linenos"> 79</span></a><span class="sd">    ----------</span>
</span><span id="tfidf_normalize-80"><a href="#tfidf_normalize-80"><span class="linenos"> 80</span></a><span class="sd">    **adata** : *AnnData* </span>
</span><span id="tfidf_normalize-81"><a href="#tfidf_normalize-81"><span class="linenos"> 81</span></a><span class="sd">        &gt; `adata.X` to be normalized. If `&#39;train_indices&#39;` and </span>
</span><span id="tfidf_normalize-82"><a href="#tfidf_normalize-82"><span class="linenos"> 82</span></a><span class="sd">        `&#39;test_indices&#39;` in `&#39;adata.uns.keys()&#39;`, normalization will be</span>
</span><span id="tfidf_normalize-83"><a href="#tfidf_normalize-83"><span class="linenos"> 83</span></a><span class="sd">        done separately for the training and testing data. Otherwise, </span>
</span><span id="tfidf_normalize-84"><a href="#tfidf_normalize-84"><span class="linenos"> 84</span></a><span class="sd">        it will calculate it on the entire dataset.</span>
</span><span id="tfidf_normalize-85"><a href="#tfidf_normalize-85"><span class="linenos"> 85</span></a>
</span><span id="tfidf_normalize-86"><a href="#tfidf_normalize-86"><span class="linenos"> 86</span></a><span class="sd">    **binarize** : *bool* </span>
</span><span id="tfidf_normalize-87"><a href="#tfidf_normalize-87"><span class="linenos"> 87</span></a><span class="sd">        &gt; If `True`, all values in `adata.X` greater than 1 will become </span>
</span><span id="tfidf_normalize-88"><a href="#tfidf_normalize-88"><span class="linenos"> 88</span></a><span class="sd">        1.</span>
</span><span id="tfidf_normalize-89"><a href="#tfidf_normalize-89"><span class="linenos"> 89</span></a>
</span><span id="tfidf_normalize-90"><a href="#tfidf_normalize-90"><span class="linenos"> 90</span></a><span class="sd">    Returns</span>
</span><span id="tfidf_normalize-91"><a href="#tfidf_normalize-91"><span class="linenos"> 91</span></a><span class="sd">    -------</span>
</span><span id="tfidf_normalize-92"><a href="#tfidf_normalize-92"><span class="linenos"> 92</span></a><span class="sd">    **adata** : *AnnData* </span>
</span><span id="tfidf_normalize-93"><a href="#tfidf_normalize-93"><span class="linenos"> 93</span></a><span class="sd">        &gt; adata with adata.X TFIDF normalized. Will now have the train </span>
</span><span id="tfidf_normalize-94"><a href="#tfidf_normalize-94"><span class="linenos"> 94</span></a><span class="sd">        data stacked on test data, and the indices will be adjusted </span>
</span><span id="tfidf_normalize-95"><a href="#tfidf_normalize-95"><span class="linenos"> 95</span></a><span class="sd">        accordingly.</span>
</span><span id="tfidf_normalize-96"><a href="#tfidf_normalize-96"><span class="linenos"> 96</span></a>
</span><span id="tfidf_normalize-97"><a href="#tfidf_normalize-97"><span class="linenos"> 97</span></a><span class="sd">    Examples</span>
</span><span id="tfidf_normalize-98"><a href="#tfidf_normalize-98"><span class="linenos"> 98</span></a><span class="sd">    --------</span>
</span><span id="tfidf_normalize-99"><a href="#tfidf_normalize-99"><span class="linenos"> 99</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.create_adata(X = data_mat, </span>
</span><span id="tfidf_normalize-100"><a href="#tfidf_normalize-100"><span class="linenos">100</span></a><span class="sd">    ...                            feature_names = gene_names, </span>
</span><span id="tfidf_normalize-101"><a href="#tfidf_normalize-101"><span class="linenos">101</span></a><span class="sd">    ...                            group_dict = group_dict)</span>
</span><span id="tfidf_normalize-102"><a href="#tfidf_normalize-102"><span class="linenos">102</span></a><span class="sd">    &gt;&gt;&gt; </span>
</span><span id="tfidf_normalize-103"><a href="#tfidf_normalize-103"><span class="linenos">103</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.tfidf_normalize(adata)</span>
</span><span id="tfidf_normalize-104"><a href="#tfidf_normalize-104"><span class="linenos">104</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="tfidf_normalize-105"><a href="#tfidf_normalize-105"><span class="linenos">105</span></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="tfidf_normalize-106"><a href="#tfidf_normalize-106"><span class="linenos">106</span></a>    <span class="n">row_sums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="tfidf_normalize-107"><a href="#tfidf_normalize-107"><span class="linenos">107</span></a>    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">row_sums</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;TFIDF requires all row sums be positive&quot;</span>
</span><span id="tfidf_normalize-108"><a href="#tfidf_normalize-108"><span class="linenos">108</span></a>
</span><span id="tfidf_normalize-109"><a href="#tfidf_normalize-109"><span class="linenos">109</span></a>    <span class="k">if</span> <span class="n">binarize</span><span class="p">:</span>
</span><span id="tfidf_normalize-110"><a href="#tfidf_normalize-110"><span class="linenos">110</span></a>        <span class="n">X</span><span class="p">[</span><span class="n">X</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="tfidf_normalize-111"><a href="#tfidf_normalize-111"><span class="linenos">111</span></a>
</span><span id="tfidf_normalize-112"><a href="#tfidf_normalize-112"><span class="linenos">112</span></a>    <span class="k">if</span> <span class="s1">&#39;train_indices&#39;</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns_keys</span><span class="p">():</span>
</span><span id="tfidf_normalize-113"><a href="#tfidf_normalize-113"><span class="linenos">113</span></a>
</span><span id="tfidf_normalize-114"><a href="#tfidf_normalize-114"><span class="linenos">114</span></a>        <span class="n">train_indices</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="tfidf_normalize-115"><a href="#tfidf_normalize-115"><span class="linenos">115</span></a>        <span class="n">test_indices</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="tfidf_normalize-116"><a href="#tfidf_normalize-116"><span class="linenos">116</span></a>
</span><span id="tfidf_normalize-117"><a href="#tfidf_normalize-117"><span class="linenos">117</span></a>        <span class="c1"># Calculate the train TFIDF matrix on just the training data so it is </span>
</span><span id="tfidf_normalize-118"><a href="#tfidf_normalize-118"><span class="linenos">118</span></a>        <span class="c1"># not biased by testing data</span>
</span><span id="tfidf_normalize-119"><a href="#tfidf_normalize-119"><span class="linenos">119</span></a>        <span class="n">tfidf_train</span> <span class="o">=</span> <span class="n">_tfidf</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">train_indices</span><span class="p">,:],</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;normalize&#39;</span><span class="p">)</span>
</span><span id="tfidf_normalize-120"><a href="#tfidf_normalize-120"><span class="linenos">120</span></a>
</span><span id="tfidf_normalize-121"><a href="#tfidf_normalize-121"><span class="linenos">121</span></a>        <span class="c1"># Calculate the test TFIDF by calculating it on the train and test </span>
</span><span id="tfidf_normalize-122"><a href="#tfidf_normalize-122"><span class="linenos">122</span></a>        <span class="c1"># data and index the test data</span>
</span><span id="tfidf_normalize-123"><a href="#tfidf_normalize-123"><span class="linenos">123</span></a>        <span class="n">tfidf_test</span> <span class="o">=</span> <span class="n">_tfidf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;normalize&#39;</span><span class="p">)[</span><span class="n">test_indices</span><span class="p">,:]</span>
</span><span id="tfidf_normalize-124"><a href="#tfidf_normalize-124"><span class="linenos">124</span></a>
</span><span id="tfidf_normalize-125"><a href="#tfidf_normalize-125"><span class="linenos">125</span></a>        <span class="c1"># Impossible to add rows back to original location so we need to </span>
</span><span id="tfidf_normalize-126"><a href="#tfidf_normalize-126"><span class="linenos">126</span></a>        <span class="c1"># stack the matrices to maintain train/test</span>
</span><span id="tfidf_normalize-127"><a href="#tfidf_normalize-127"><span class="linenos">127</span></a>        <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="tfidf_normalize-128"><a href="#tfidf_normalize-128"><span class="linenos">128</span></a>            <span class="n">tfidf_norm</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tfidf_train</span><span class="p">,</span> <span class="n">tfidf_test</span><span class="p">))</span>
</span><span id="tfidf_normalize-129"><a href="#tfidf_normalize-129"><span class="linenos">129</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="tfidf_normalize-130"><a href="#tfidf_normalize-130"><span class="linenos">130</span></a>            <span class="n">tfidf_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tfidf_train</span><span class="p">,</span> <span class="n">tfidf_test</span><span class="p">))</span>
</span><span id="tfidf_normalize-131"><a href="#tfidf_normalize-131"><span class="linenos">131</span></a>
</span><span id="tfidf_normalize-132"><a href="#tfidf_normalize-132"><span class="linenos">132</span></a>        <span class="c1"># I&#39;m not sure why this reassignment is necessary, but without, the </span>
</span><span id="tfidf_normalize-133"><a href="#tfidf_normalize-133"><span class="linenos">133</span></a>        <span class="c1"># values will be saved as 0s in adata</span>
</span><span id="tfidf_normalize-134"><a href="#tfidf_normalize-134"><span class="linenos">134</span></a>        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_indices</span>
</span><span id="tfidf_normalize-135"><a href="#tfidf_normalize-135"><span class="linenos">135</span></a>        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;test_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_indices</span>
</span><span id="tfidf_normalize-136"><a href="#tfidf_normalize-136"><span class="linenos">136</span></a>
</span><span id="tfidf_normalize-137"><a href="#tfidf_normalize-137"><span class="linenos">137</span></a>        <span class="n">combined_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span><span class="p">))</span>
</span><span id="tfidf_normalize-138"><a href="#tfidf_normalize-138"><span class="linenos">138</span></a>
</span><span id="tfidf_normalize-139"><a href="#tfidf_normalize-139"><span class="linenos">139</span></a>        <span class="c1"># Anndata indexes by &quot;rownames&quot; not position so we need to rename the </span>
</span><span id="tfidf_normalize-140"><a href="#tfidf_normalize-140"><span class="linenos">140</span></a>        <span class="c1"># rows to properly index</span>
</span><span id="tfidf_normalize-141"><a href="#tfidf_normalize-141"><span class="linenos">141</span></a>        <span class="n">adata_index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">[</span><span class="n">combined_indices</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="tfidf_normalize-142"><a href="#tfidf_normalize-142"><span class="linenos">142</span></a>        <span class="n">tfidf_norm</span> <span class="o">=</span> <span class="n">tfidf_norm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">adata_index</span><span class="p">),:]</span>
</span><span id="tfidf_normalize-143"><a href="#tfidf_normalize-143"><span class="linenos">143</span></a>
</span><span id="tfidf_normalize-144"><a href="#tfidf_normalize-144"><span class="linenos">144</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="tfidf_normalize-145"><a href="#tfidf_normalize-145"><span class="linenos">145</span></a>
</span><span id="tfidf_normalize-146"><a href="#tfidf_normalize-146"><span class="linenos">146</span></a>        <span class="n">tfidf_norm</span> <span class="o">=</span> <span class="n">_tfidf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;normalize&#39;</span><span class="p">)</span>
</span><span id="tfidf_normalize-147"><a href="#tfidf_normalize-147"><span class="linenos">147</span></a>
</span><span id="tfidf_normalize-148"><a href="#tfidf_normalize-148"><span class="linenos">148</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">tfidf_norm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="tfidf_normalize-149"><a href="#tfidf_normalize-149"><span class="linenos">149</span></a>
</span><span id="tfidf_normalize-150"><a href="#tfidf_normalize-150"><span class="linenos">150</span></a>    <span class="k">return</span> <span class="n">adata</span>
</span></pre></div>


            <div class="docstring"><p>Function to TFIDF normalize the data in an adata object. If any 
rows are entirely 0, that row and its metadata will be removed from
the object.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>adata</strong> : <em>AnnData</em> </p>

<blockquote>
  <p><code>adata.X</code> to be normalized. If <code>'train_indices'</code> and 
      <code>'test_indices'</code> in <code>'adata.uns.keys()'</code>, normalization will be
      done separately for the training and testing data. Otherwise, 
      it will calculate it on the entire dataset.</p>
</blockquote>

<p><strong>binarize</strong> : <em>bool</em> </p>

<blockquote>
  <p>If <code>True</code>, all values in <code>adata.X</code> greater than 1 will become 
      1.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>adata</strong> : <em>AnnData</em> </p>

<blockquote>
  <p>adata with adata.X TFIDF normalized. Will now have the train 
      data stacked on test data, and the indices will be adjusted 
      accordingly.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/create_adata.html">scmkl.create_adata</a></span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">data_mat</span><span class="p">,</span> 
<span class="gp">... </span>                           <span class="n">feature_names</span> <span class="o">=</span> <span class="n">gene_names</span><span class="p">,</span> 
<span class="gp">... </span>                           <span class="n">group_dict</span> <span class="o">=</span> <span class="n">group_dict</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/tfidf_normalize.html">scmkl.tfidf_normalize</a></span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</code></pre>
</div>
</div>


                </section>
                <section id="train_model">
                            <input id="train_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">train_model</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">adata</span>, </span><span class="param"><span class="n">group_size</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="train_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#train_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="train_model-6"><a href="#train_model-6"><span class="linenos"> 6</span></a><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">):</span>
</span><span id="train_model-7"><a href="#train_model-7"><span class="linenos"> 7</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="train_model-8"><a href="#train_model-8"><span class="linenos"> 8</span></a><span class="sd">    Fit a grouplasso model to the provided data.</span>
</span><span id="train_model-9"><a href="#train_model-9"><span class="linenos"> 9</span></a>
</span><span id="train_model-10"><a href="#train_model-10"><span class="linenos">10</span></a><span class="sd">    Parameters</span>
</span><span id="train_model-11"><a href="#train_model-11"><span class="linenos">11</span></a><span class="sd">    ----------</span>
</span><span id="train_model-12"><a href="#train_model-12"><span class="linenos">12</span></a><span class="sd">    **adata** : *AnnData* </span>
</span><span id="train_model-13"><a href="#train_model-13"><span class="linenos">13</span></a><span class="sd">        &gt; Has `&#39;Z_train&#39;` and `&#39;Z_test&#39;` keys in `adata.uns`.</span>
</span><span id="train_model-14"><a href="#train_model-14"><span class="linenos">14</span></a>
</span><span id="train_model-15"><a href="#train_model-15"><span class="linenos">15</span></a><span class="sd">    **group_size** : *int* </span>
</span><span id="train_model-16"><a href="#train_model-16"><span class="linenos">16</span></a><span class="sd">        &gt; Argument describing how the features are grouped. Should be</span>
</span><span id="train_model-17"><a href="#train_model-17"><span class="linenos">17</span></a><span class="sd">        `2 * D`. For more information see celer documentation. </span>
</span><span id="train_model-18"><a href="#train_model-18"><span class="linenos">18</span></a><span class="sd">            </span>
</span><span id="train_model-19"><a href="#train_model-19"><span class="linenos">19</span></a><span class="sd">    **alpha** : *float*</span>
</span><span id="train_model-20"><a href="#train_model-20"><span class="linenos">20</span></a><span class="sd">        &gt; Group Lasso regularization coefficient. alpha is a floating </span>
</span><span id="train_model-21"><a href="#train_model-21"><span class="linenos">21</span></a><span class="sd">        point value controlling model solution sparsity. Must be a </span>
</span><span id="train_model-22"><a href="#train_model-22"><span class="linenos">22</span></a><span class="sd">        positive float. The smaller the value, the more feature groups </span>
</span><span id="train_model-23"><a href="#train_model-23"><span class="linenos">23</span></a><span class="sd">        will be selected in the trained model.</span>
</span><span id="train_model-24"><a href="#train_model-24"><span class="linenos">24</span></a><span class="sd">    </span>
</span><span id="train_model-25"><a href="#train_model-25"><span class="linenos">25</span></a><span class="sd">    Returns</span>
</span><span id="train_model-26"><a href="#train_model-26"><span class="linenos">26</span></a><span class="sd">    -------</span>
</span><span id="train_model-27"><a href="#train_model-27"><span class="linenos">27</span></a><span class="sd">    **adata** : *AnnData* </span>
</span><span id="train_model-28"><a href="#train_model-28"><span class="linenos">28</span></a><span class="sd">        &gt; Trained model accessible with `adata.uns[&#39;model&#39;]`.</span>
</span><span id="train_model-29"><a href="#train_model-29"><span class="linenos">29</span></a>
</span><span id="train_model-30"><a href="#train_model-30"><span class="linenos">30</span></a><span class="sd">    Examples</span>
</span><span id="train_model-31"><a href="#train_model-31"><span class="linenos">31</span></a><span class="sd">    --------</span>
</span><span id="train_model-32"><a href="#train_model-32"><span class="linenos">32</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.estimate_sigma(adata)</span>
</span><span id="train_model-33"><a href="#train_model-33"><span class="linenos">33</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.calculate_z(adata)</span>
</span><span id="train_model-34"><a href="#train_model-34"><span class="linenos">34</span></a><span class="sd">    &gt;&gt;&gt; metrics = [&#39;AUROC&#39;, &#39;F1-Score&#39;, &#39;Accuracy&#39;, &#39;Precision&#39;, </span>
</span><span id="train_model-35"><a href="#train_model-35"><span class="linenos">35</span></a><span class="sd">    ...            &#39;Recall&#39;]</span>
</span><span id="train_model-36"><a href="#train_model-36"><span class="linenos">36</span></a><span class="sd">    &gt;&gt;&gt; d = scmkl.calculate_d(adata.shape[0])</span>
</span><span id="train_model-37"><a href="#train_model-37"><span class="linenos">37</span></a><span class="sd">    &gt;&gt;&gt; group_size = 2 * d</span>
</span><span id="train_model-38"><a href="#train_model-38"><span class="linenos">38</span></a><span class="sd">    &gt;&gt;&gt; adata = scmkl.train_model(adata, group_size)</span>
</span><span id="train_model-39"><a href="#train_model-39"><span class="linenos">39</span></a><span class="sd">    &gt;&gt;&gt;</span>
</span><span id="train_model-40"><a href="#train_model-40"><span class="linenos">40</span></a><span class="sd">    &gt;&gt;&gt; &#39;model&#39; in adata.uns.keys()</span>
</span><span id="train_model-41"><a href="#train_model-41"><span class="linenos">41</span></a><span class="sd">    True</span>
</span><span id="train_model-42"><a href="#train_model-42"><span class="linenos">42</span></a>
</span><span id="train_model-43"><a href="#train_model-43"><span class="linenos">43</span></a><span class="sd">    See Also</span>
</span><span id="train_model-44"><a href="#train_model-44"><span class="linenos">44</span></a><span class="sd">    --------</span>
</span><span id="train_model-45"><a href="#train_model-45"><span class="linenos">45</span></a><span class="sd">    celer documentation :</span>
</span><span id="train_model-46"><a href="#train_model-46"><span class="linenos">46</span></a><span class="sd">    https://mathurinm.github.io/celer/generated/celer.GroupLasso.html</span>
</span><span id="train_model-47"><a href="#train_model-47"><span class="linenos">47</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="train_model-48"><a href="#train_model-48"><span class="linenos">48</span></a>    <span class="k">assert</span> <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Alpha must be positive&#39;</span>
</span><span id="train_model-49"><a href="#train_model-49"><span class="linenos">49</span></a>
</span><span id="train_model-50"><a href="#train_model-50"><span class="linenos">50</span></a>    <span class="n">y_train</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;train_indices&#39;</span><span class="p">]]</span>
</span><span id="train_model-51"><a href="#train_model-51"><span class="linenos">51</span></a>    <span class="n">X_train</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;Z_train&#39;</span><span class="p">]</span>
</span><span id="train_model-52"><a href="#train_model-52"><span class="linenos">52</span></a>
</span><span id="train_model-53"><a href="#train_model-53"><span class="linenos">53</span></a>    <span class="n">cell_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
</span><span id="train_model-54"><a href="#train_model-54"><span class="linenos">54</span></a>
</span><span id="train_model-55"><a href="#train_model-55"><span class="linenos">55</span></a>    <span class="c1"># This is a regression algorithm. We need to make the labels &#39;continuous&#39; </span>
</span><span id="train_model-56"><a href="#train_model-56"><span class="linenos">56</span></a>    <span class="c1"># for classification, but they will remain binary. Casts training labels </span>
</span><span id="train_model-57"><a href="#train_model-57"><span class="linenos">57</span></a>    <span class="c1"># to array of -1,1</span>
</span><span id="train_model-58"><a href="#train_model-58"><span class="linenos">58</span></a>    <span class="n">train_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="train_model-59"><a href="#train_model-59"><span class="linenos">59</span></a>    <span class="n">train_labels</span><span class="p">[</span><span class="n">y_train</span> <span class="o">==</span> <span class="n">cell_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="train_model-60"><a href="#train_model-60"><span class="linenos">60</span></a>
</span><span id="train_model-61"><a href="#train_model-61"><span class="linenos">61</span></a>    <span class="c1"># Alphamax is a calculation to regularize the effect of alpha across </span>
</span><span id="train_model-62"><a href="#train_model-62"><span class="linenos">62</span></a>    <span class="c1"># different data sets</span>
</span><span id="train_model-63"><a href="#train_model-63"><span class="linenos">63</span></a>    <span class="n">alphamax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)))</span>
</span><span id="train_model-64"><a href="#train_model-64"><span class="linenos">64</span></a>    <span class="n">alphamax</span> <span class="o">/=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
</span><span id="train_model-65"><a href="#train_model-65"><span class="linenos">65</span></a>    <span class="n">alphamax</span> <span class="o">*=</span> <span class="n">alpha</span>
</span><span id="train_model-66"><a href="#train_model-66"><span class="linenos">66</span></a>
</span><span id="train_model-67"><a href="#train_model-67"><span class="linenos">67</span></a>    <span class="c1"># Instantiate celer Group Lasso Regression Model Object</span>
</span><span id="train_model-68"><a href="#train_model-68"><span class="linenos">68</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">celer</span><span class="o">.</span><span class="n">GroupLasso</span><span class="p">(</span><span class="n">groups</span> <span class="o">=</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alphamax</span><span class="p">)</span>
</span><span id="train_model-69"><a href="#train_model-69"><span class="linenos">69</span></a>
</span><span id="train_model-70"><a href="#train_model-70"><span class="linenos">70</span></a>    <span class="c1"># Fit model using training data</span>
</span><span id="train_model-71"><a href="#train_model-71"><span class="linenos">71</span></a>    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">train_labels</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
</span><span id="train_model-72"><a href="#train_model-72"><span class="linenos">72</span></a>
</span><span id="train_model-73"><a href="#train_model-73"><span class="linenos">73</span></a>    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="train_model-74"><a href="#train_model-74"><span class="linenos">74</span></a>    <span class="k">return</span> <span class="n">adata</span>
</span></pre></div>


            <div class="docstring"><p>Fit a grouplasso model to the provided data.</p>

<h2 id="parameters">Parameters</h2>

<p><strong>adata</strong> : <em>AnnData</em> </p>

<blockquote>
  <p>Has <code>'Z_train'</code> and <code>'Z_test'</code> keys in <code>adata.uns</code>.</p>
</blockquote>

<p><strong>group_size</strong> : <em>int</em> </p>

<blockquote>
  <p>Argument describing how the features are grouped. Should be
      <code>2 * D</code>. For more information see celer documentation. </p>
</blockquote>

<p><strong>alpha</strong> : <em>float</em></p>

<blockquote>
  <p>Group Lasso regularization coefficient. alpha is a floating 
      point value controlling model solution sparsity. Must be a 
      positive float. The smaller the value, the more feature groups 
      will be selected in the trained model.</p>
</blockquote>

<h2 id="returns">Returns</h2>

<p><strong>adata</strong> : <em>AnnData</em> </p>

<blockquote>
  <p>Trained model accessible with <code>adata.uns['model']</code>.</p>
</blockquote>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/estimate_sigma.html">scmkl.estimate_sigma</a></span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/calculate_z.html">scmkl.calculate_z</a></span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AUROC&#39;</span><span class="p">,</span> <span class="s1">&#39;F1-Score&#39;</span><span class="p">,</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span> 
<span class="gp">... </span>           <span class="s1">&#39;Recall&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">scmkl</span><span class="o">.</span><span class="n">calculate_d</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">group_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n"><a href="scmkl/train_model.html">scmkl.train_model</a></span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group_size</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="go">True</span>
</code></pre>
</div>

<h2 id="see-also">See Also</h2>

<p>celer documentation :
<a href="https://mathurinm.github.io/celer/generated/celer.GroupLasso.html">https://mathurinm.github.io/celer/generated/celer.GroupLasso.html</a></p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>